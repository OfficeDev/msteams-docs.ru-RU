---
title: Подготовка облачных ресурсов с помощью набора средств Teams
author: MuyangAmigo
description: В этом модуле вы узнаете, как подготовить облачные ресурсы с помощью Набора средств Teams, создать и настроить подготовку ресурсов.
ms.author: shenwe
ms.localizationpriority: medium
ms.topic: overview
ms.date: 11/29/2021
zone_pivot_groups: teams-app-platform
ms.openlocfilehash: a0174d113d441e2318f4f9f4165211f46df1876e
ms.sourcegitcommit: ea7b7b8ebb4b2acdd0b9a3411c59a9a91a06f409
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/03/2022
ms.locfileid: "68350463"
---
# <a name="provision-cloud-resources"></a>Подготовка облачных ресурсов

TeamsFx интегрируется с облаком Azure и Microsoft 365, что позволяет разместить приложение в Azure с помощью одной команды. TeamsFx интегрируется с диспетчером ресурсов Azure, что позволяет подготавливать ресурсы Azure, необходимые приложению для подхода к коду.

::: zone pivot="visual-studio-code"

## <a name="provision-using-teams-toolkit-in-visual-studio-code"></a>Подготовка с помощью Набора средств Teams в Visual Studio Code

Подготовка выполняется с помощью одной команды в Наборе средств Teams для Visual Studio Code или TeamsFx CLI. Дополнительные сведения см[. в разделе "Подготовка приложения на основе Azure"](/microsoftteams/platform/sbs-gs-javascript?tabs=vscode%2Cvsc%2Cviscode%2Cvcode&tutorial-step=8).

## <a name="create-resources"></a>Создание ресурсов

При активации команды подготовки в наборе средств Teams или TeamsFx CLI можно получить следующие ресурсы:

* Microsoft Azure Active Directory (Azure AD) в клиенте Microsoft 365.
* Регистрация приложения Teams на платформе Teams клиента Microsoft 365.
* Ресурсы Azure в выбранной подписке Azure.

При создании проекта можно использовать все ресурсы Azure. Шаблон ARM определяет все ресурсы Azure и помогает создавать необходимые ресурсы Azure во время подготовки. При [добавлении нового ресурса возможностей](./add-resource.md) в существующий проект обновленный шаблон ARM отражает последнее изменение.

> [!NOTE]
> Использование служб Azure влечет за собой дополнительные затраты в вашей подписке. Подробнее об оценке затрат см. [калькулятор цен](https://azure.microsoft.com/pricing/calculator/).

В следующем списке показано создание ресурсов для различных типов приложений и ресурсов Azure:
<br>

<details>
<summary><b>Создание ресурсов для приложения вкладки Teams</b></summary>

|Ресурс|Назначение|Описание |
|----------|--------------------------------|-----|
| Хранилище Azure | Размещение приложения вкладки | Включает функцию статического веб-приложения для размещения приложения вкладки |
| План службы приложений для простой проверки подлинности | Размещение веб-приложения простой проверки подлинности |Неприменимо |
| Веб-приложение для простой проверки подлинности | Размещение простого сервера проверки подлинности для получения доступа к другим службам в одностраничном приложении | Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure |
| Назначаемое пользователем удостоверение | Проверка подлинности запросов между службами Azure | Совместно используется различными возможностями и ресурсами |

</details>
<br>

<details>
<summary><b>Создание ресурсов для бота или приложения расширения для сообщений Teams</b></summary>

|Ресурс|Назначение| Описание |
|----------|--------------------------------|-----|
| Служба бота Azure | Регистрация приложения в качестве бота на платформе бота | Подключение бота к Teams |
| План службы приложений для бота | Размещение веб-приложения бота |Неприменимо |
| Веб-приложение для бота | Размещение приложения бота | Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure. <br /> Добавляет параметры приложения, необходимые пакету [SDK для TeamsFx](https://www.npmjs.com/package/@microsoft/teamsfx) |
| Назначаемое пользователем удостоверение | Проверка подлинности запросов между службами Azure | Совместно используется различными возможностями и ресурсами |

</details>
<br>

<details>
<summary><b>Создание ресурсов для функции Azure в проекте</b></summary>

|Ресурс|Назначение| Описание|
|----------|--------------------------------|-----|
| План службы приложений для приложения-функции | Размещение приложения-функции |Неприменимо |
| Приложение-функция | Размещение API-интерфейсов функций Azure | Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure. <br /> Добавляет правило общего доступа к ресурсам независимо от источника (CORS), чтобы разрешить запросы из приложения вкладки. <br /> Добавляет параметр проверки подлинности, который разрешает только запросы из приложения Teams. <br /> Добавляет параметры приложения, необходимые пакету [SDK для TeamsFx](https://www.npmjs.com/package/@microsoft/teamsfx) |
| Хранилище Azure для приложения-функции | Требуется для создания приложения-функции |Неприменимо|
| Назначаемое пользователем удостоверение | Проверка подлинности запросов между службами Azure | Совместно используется различными возможностями и ресурсами |

</details>
<br>

<details>
<summary><b>Создание ресурсов для Azure SQL в проекте</b></summary>

|Ресурс|Назначение | Описание |
|----------|--------------------------------|-----|
| Azure SQL Server | Размещение экземпляра базы данных Azure SQL | Разрешает всем службам Azure доступ к серверу |
| База данных Azure SQL | Хранение данных для приложения | Предоставляет назначаемому пользователем удостоверению разрешение на чтение или запись в базу данных |
| Назначаемое пользователем удостоверение | Проверка подлинности запросов между службами Azure | Совместно используется различными возможностями и ресурсами |

</details>
<br>

<details>
<summary><b>Создание ресурсов для управления API Azure в проекте</b></summary>

|Ресурс|Назначение|
|----------|--------------------------------|
| Приложение Azure AD для службы управления API | Разрешает Microsoft Power Platform доступ к API-интерфейсам, управляемым службой управления API |
| Служба управления API | Управление API-интерфейсами, размещенными в приложении-функции |
| Продукт управления API | Группирование API, определение условий использования и политик среды выполнения |
| Сервер OAuth для управления API | Позволяет платформе Microsoft Power Platform получить доступ к API- интерфейсам, размещенным в приложении-функции |
| Назначаемое пользователем удостоверение | Проверка подлинности запросов между службами Azure |

</details>
<br>

<details>
<summary><b>Ресурсы, созданные при включении Key Vault Azure в проект</b></summary>

|Ресурсы|Назначение этого ресурса|
|----------|--------------------------------|
| Служба Key Vault Azure | Управление секретами (например, секретом клиента приложения Azure AD), которые используются другими службами Azure |
| Назначаемое пользователем удостоверение | Проверка подлинности запросов между службами Azure |

</details>
<br>

## <a name="customize-resource-provision"></a>Настройка подготовки ресурсов

Набор средств Teams позволяет использовать подход "инфраструктура как код" для определения ресурсов Azure, которые необходимо подготовить, и способа настройки. Это средство использует шаблон ARM для определения ресурсов Azure. Шаблон ARM — это набор файлов bicep, определяющий инфраструктуру и конфигурацию проекта. Ресурсы Azure можно настраивать, изменяя шаблон ARM. Дополнительные сведения см. в [документе по bicep](/azure/azure-resource-manager/bicep).

Подготовка с помощью ARM включает в себя изменение следующих наборов файлов, параметров и шаблонов:

* Файлы параметров ARM (`azure.parameters.{your_env_name}.json`), расположенные в папке `.fx/configs`, для передачи параметров в шаблоны.
* Файлы шаблонов ARM, расположенные в `templates/azure`; эта папка содержит следующие файлы:

| Файл | Функция | Разрешение настройки |
| --- | --- | --- |
| main.bicep | Предоставление точки входа для подготовки ресурсов Azure | Да |
| provision.bicep | Создание и настройка ресурсов Azure | Да |
| config.bicep | Добавление необходимых конфигураций TeamsFx в ресурсы Azure | Да |
| provision/xxx.bicep | Создание и настройка каждого ресурса Azure, потребляемого `provision.bicep` | Да |
| teamsfx/xxx.bicep | Добавление необходимых конфигураций TeamsFx в каждый ресурс Azure, используемый `config.bicep`| Нет |

> [!NOTE]
> При добавлении ресурсов или возможностей в проект `teamsfx/xxx.bicep` будет создано повторно; этот процесс нельзя заменить настройкой. Чтобы изменить файлы bicep, можно использовать Git для отслеживания изменений в файлах `teamsfx/xxx.bicep`, что помогает не потерять изменения при добавлении ресурсов или возможностей.

### <a name="azure-ad-parameters"></a>Azure AD параметров

В файлах шаблонов ARM для параметров используются заполнители. Цель этих заполнителей — обеспечить создание новых ресурсов в новой среде. Фактические значения разрешаются на основе `.fx/states/state.{env}.json`.

Существует два типа параметров, таких как Azure AD параметры, связанные с приложением, и параметры, связанные с ресурсами Azure.

##### <a name="azure-ad-application-related-parameters"></a>Параметры, связанные с приложением Azure AD

| Имя параметра | Заполнитель значения по умолчанию | Значение заполнителя | Создание и настройка |
| --- | --- | --- | --- |
| Microsoft 365 ClientId | {{state.fx-resource-aad-app-for-teams.clientId}} | Идентификатор клиента приложения Azure AD, созданный во время подготовки | [Использование существующего приложения Azure AD для бота](#use-an-existing-azure-ad-app-for-your-bot) |
| Microsoft 365 ClientSecret | {{state.fx-resource-aad-app-for-teams.clientSecret}} | Секрет клиента приложения Azure AD, созданный во время подготовки | [Использование существующего приложения Azure AD для приложения Teams](#use-an-existing-azure-ad-app-for-your-teams-app) |
| Идентификатор клиента Microsoft 365 | {{state.fx-resource-aad-app-for-teams.tenantId}} | Идентификатор клиента приложения Azure AD вашего приложения | [Использование существующего приложения Azure AD для приложения Teams](#use-an-existing-azure-ad-app-for-your-teams-app)  |
| Microsoft 365 OAuthAuthorityHost | {{state.fx-resource-aad-app-for-teams.oauthHost}} | Авторизующий узел OAuth приложения Azure AD вашего приложения | [Использование существующего приложения Azure AD для приложения Teams](#use-an-existing-azure-ad-app-for-your-teams-app) |
| botAadAppClientId | {{state.fx-resource-bot.botId}} | Идентификатор клиента приложения Azure AD бота, созданный во время подготовки | [Использование существующего приложения Azure AD для бота](#use-an-existing-azure-ad-app-for-your-bot) |
| botAadAppClientSecret | {{state.fx-resource-bot.botPassword}} | Секрет клиента приложения Azure AD бота, созданный во время подготовки | [Использование существующего приложения Azure AD для бота](#use-an-existing-azure-ad-app-for-your-bot) |

##### <a name="azure-resource-related-parameters"></a>Параметры, связанные с ресурсами Azure

| Имя параметра | Заполнитель значения по умолчанию | Значение заполнителя | Создание и настройка |
| --- | --- | --- | --- |
| azureSqlAdmin | {{state.fx-resource-azure-sql.admin}} | Учетная запись администратора сервера Azure SQL Server, указанная вами во время подготовки | Удаление заполнителя и заполнение фактического значения |
| azureSqlAdminPassword | {{state.fx-resource-azure-sql.adminPassword}} | Пароль администратора сервера Azure SQL Server, указанный во время подготовки | Удаление заполнителя и заполнение фактического значения |

#### <a name="referencing-environment-variables-in-parameter-files"></a>Ссылка на переменные среды в файлах параметров

Если вы не хотите указывать фиксированные значения прямо в файлах параметров, например, если значение является секретом. Файлы параметров поддерживают ссылки на значения из переменных среды. Вы можете использовать синтаксис `{{$env.YOUR_ENV_VARIABLE_NAME}}` в значениях параметров, чтобы средство могло получить значение из текущей переменной среды.

В следующем примере считывается значение параметра `mySelfHostedDbConnectionString` из переменной среды `DB_CONNECTION_STRING`:

```json
...
    "mySelfHostedDbConnectionString": "{{$env.DB_CONNECTION_STRING}}"
...
```

#### <a name="customize-arm-template-files"></a>Настройка файлов шаблонов ARM

Если стандартные шаблоны не соответствуют требованиям приложения, можно настроить шаблоны ARM в папке `templates/azure`. Например, можно настроить шаблон ARM, чтобы создать дополнительные ресурсы Azure для приложения. Вам потребуется базовое знание языка bicep, который используется для создания шаблона ARM. Начать работу с bicep поможет [документация по bicep](/azure/azure-resource-manager/bicep/).

> [!NOTE]
> Шаблон ARM является общим для всех сред. [Условное развертывание](/azure/azure-resource-manager/bicep/conditional-resource-deployment) можно использовать, если поведение подготовки различается в разных средах.

Чтобы обеспечить правильную работу инструмента TeamsFx, настройте шаблон ARM, который соответствует следующему требованию. Если вы используете для дальнейшей разработки другое средство, эти требования можно игнорировать.

* Сохраните структуру папки и имя файла без изменений. Средство может добавлять новое содержимое в существующие файлы при добавлении дополнительных ресурсов или возможностей в проект.
* Не изменяйте имена автоматически создаваемых параметров и имена свойств. Автоматически созданные параметры можно использовать при добавлении дополнительных ресурсов или возможностей в проект.
* Сохраните вывод автоматически созданного шаблона ARM без изменений. Можно добавить в шаблон ARM дополнительный вывод. Выходные данные представляют собой `.fx/states/state.{env}.json` и могут использоваться в других функциях, таких как развертывание, проверка файла манифеста.

### <a name="customization-scenarios"></a>Сценарии настройки

Вы можете провести настройку следующих сценариев:

#### <a name="use-an-existing-azure-ad-app-for-your-teams-app"></a>Использование существующего приложения Azure AD для приложения Teams

Вы можете добавить следующий фрагмент конфигурации в файл `.fx/configs/config.{env}.json`, чтобы использовать приложение Azure AD, созданное вами для приложения Teams. Сведения о создании Azure AD см. в разделе <https://aka.ms/teamsfx-existing-aad-doc>.

```json
"auth": {
    "clientId": "<your Azure AD app client id>",
    "clientSecret": "{{$env.ENV_NAME_THAT_STORES_YOUR_SECRET}}",
    "objectId": "<your Azure AD app object id>",
    "accessAsUserScopeId": "<id of the access_as_user scope>"
}
```

После добавления приведенного фрагмента кода добавьте секрет в связанную переменную среды, чтобы средство могло разрешить фактический секрет во время подготовки.

> [!NOTE]
> Убедитесь, что одно и то же приложение Azure AD не используется в нескольких средах. Если у вас нет разрешения на обновление приложения Azure AD, вы можете получить предупреждение с инструкциями по обновлению приложения Azure AD вручную. Следуйте инструкциям, чтобы обновить приложение Azure AD после подготовки.

#### <a name="use-an-existing-azure-ad-app-for-your-bot"></a>Использование существующего приложения Azure AD для бота

Вы можете добавить следующий фрагмент конфигурации в файл `.fx/configs/config.{env}.json`, чтобы использовать приложение Azure AD, созданное вами для бота:

```json
"bot": {
    "appId": "<your Azure AD app client id>",
    "appPassword": "{{$env.ENV_NAME_THAT_STORES_YOUR_SECRET}}"
}
```

После добавления предыдущего фрагмента кода добавьте секрет в связанную переменную среды, чтобы средство могло разрешить фактический секрет во время подготовки.

#### <a name="skip-adding-user-for-sql-database"></a>Пропустить добавление пользователя для SQL базы данных

Если при попытке добавить пользователя в базу данных SQL недостаточно разрешений, можно добавить следующий фрагмент конфигурации в файл `.fx/configs/config.{env}.json`, чтобы пропустить добавление SQL базы данных:

```json
"skipAddingSqlUser": true
```

### <a name="specifying-the-name-of-function-app-instance"></a>Указание имени экземпляра приложения-функции

`contosoteamsappapi` можно использовать вместо имени по умолчанию экземпляра приложения-функции.

> [!NOTE]
> Если среда уже подготовлена, указание имени может создать новый экземпляр приложения-функции вместо переименования созданного ранее экземпляра.

Следующие шаги:

1. Откройте `.fx/configs/azure.parameters.{env}.json` для текущей среды.
2. Добавьте новое свойство, например, `functionAppName` в разделе `provisionParameters` .
3. Введите, например `functionAppName`, значение `contosoteamsappapi`.
4. Окончательный файл параметров показан в следующем фрагменте кода:

    ```json
    {
        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {
            "provisionParameters": {
            "value": {
                "functionAppName": "contosoteamsappapi"
                ...
                }
            }
        }
    }
    ```

Чтобы добавить в приложение другой ресурс или хранилище Azure:

Рассмотрим следующий сценарий.

Вы хотите добавить хранилище Azure в серверную часть функции Azure для хранения данных больших двоичных объектов. Для обновления шаблона bicep с поддержкой службы хранилища Azure не существует автоматического потока. Однако вы можете изменить bicep-файл и добавить ресурс. Для этого выполните следующие действия.

1. Создайте проект вкладки.
2. Добавьте в проект функцию. Дополнительные сведения см. в документации по [добавлению ресурсов](./add-resource.md).
3. Объявите новую учетную запись хранения в шаблоне ARM. Можно объявить ресурс напрямую в `templates/azure/provision/function.bicep`. По желанию можно объявлять ресурсы в других местах.

    `````````bicep
    var applicationStorageAccountName = 'myapp${uniqueString(resourceGroup().id)}'
    resource applicationStorageAccount 'Microsoft.Storage/storageAccounts@2021-06-01' = {
        name: applicationStorageAccountName
        location: resourceGroup().location
        kind: 'Storage'
        sku: {
            name: 'Standard_LRS'
        }
    }
    `````````

4. Обновите параметры приложения-функции Azure, используя строку подключения к хранилищу Azure в `templates/azure/provision/function.bicep`. Добавьте следующий фрагмент кода в массив `appSettings` ресурса `functionApp`:

    ``````````````````bicep
    {
        name: 'MyAppStorageAccountConnectionString'
        value: 'DefaultEndpointsProtocol=https;AccountName=${applicationStorageAccount.name};AccountKey=${listKeys(applicationStorageAccount.id, '2021-06-01').keys[0].value}'
    }
    ```````````````````

5. Вы можете обновить функцию с помощью выходных привязок службы хранилища Azure.

::: zone-end

::: zone pivot="visual-studio"

## <a name="provision-using-teams-toolkit-in-visual-studio"></a>Подготовка с помощью набора средств Teams в Visual Studio

Следующие шаги помогут вам подготовить облачные ресурсы с помощью Visual Studio:

### <a name="sign-in-to-your-microsoft-365-account"></a>Вход в учетную запись Microsoft 365

1. Откройте Visual Studio 2022.
1. Откройте проект приложения Microsoft Teams.
1. Выберите **"Project** > **Teams Toolkit Prepare** > **Teams App Dependencies" (Подготовка зависимостей приложений Teams**).

   :::image type="content" source="../assets/images/Tools-and-SDK-revamp/Provision-cloud-resources-in-TTK-VS/teams-toolkit-vs-prepare-app-dependencies1.png" alt-text="Подготовка зависимостей приложений teams":::

1. Выберите **"Войти"** , чтобы войти в учетную запись Azure.

   :::image type="content" source="../assets/images/Tools-and-SDK-revamp/Provision-cloud-resources-in-TTK-VS/teams-toolkit-vs-prepare1.png" alt-text="Вход в Microsoft 365":::

    > [!NOTE]
    > Если вы уже вошли в систему, отобразится имя пользователя или вы можете выбрать то же самое, чтобы переключить учетную запись.

1. Откроется веб-браузер по умолчанию, позволяющий [войти в](https://developer.microsoft.com/en-us/microsoft-365/dev-program) учетную запись.

1. Нажмите **кнопку "** Продолжить" после входа в учетную запись.

    :::image type="content" source="../assets/images/Tools-and-SDK-revamp/Provision-cloud-resources-in-TTK-VS/teams-toolkit-vs-signin-M365.png" alt-text="Подтвердите, выбрав &quot;Продолжить&quot;.":::

### <a name="sign-in-to-your-azure-account"></a>Вход в учетную запись Azure

1. Откройте Visual Studio 2022.
1. Откройте проект приложения Teams.
1. Выберите **Project** > **Teams Toolkit** > **Provision в облаке**.

   :::image type="content" source="../assets/images/Tools-and-SDK-revamp/Provision-cloud-resources-in-TTK-VS/teams-toolkit-vs-provision-in-cloud2.png" alt-text="Вход в учетную запись Azure":::

1. Выберите **"Войти...** ", чтобы войти в свою учетную запись Azure.

   :::image type="content" source="../assets/images/Tools-and-SDK-revamp/Provision-cloud-resources-in-TTK-VS/teams-toolkit-vs-provision-start.png" alt-text="Вход в учетную запись Azure":::

   > [!NOTE]
   > Если вы уже вошли в систему, отобразится имя пользователя или вы можете переключить учетную запись.

   После входа в учетную запись Azure с использованием учетных данных браузер автоматически закрывается.

### <a name="to-provision-cloud-resources"></a>Подготовка облачных ресурсов

После открытия проекта в Visual Studio:

1. Выберите **Project** > **Teams Toolkit** > **Provision в облаке**.

   :::image type="content" source="../assets/images/Tools-and-SDK-revamp/Provision-cloud-resources-in-TTK-VS/teams-toolkit-vs-provision-in-cloud2.png" alt-text="Подготовка в облаке":::

   **Появится окно** подготовки.

1. Введите следующие сведения для подготовки ресурсов.

    :::image type="content" source="../assets/images/Tools-and-SDK-revamp/Provision-cloud-resources-in-TTK-VS/teams-toolkit-vs-provision-select-subscription1.png" alt-text="Выбор группы ресурсов":::

   1. Выберите имя **подписки** из раскрывающегося списка.
   1. Выберите свою **группу ресурсов** в раскрывающемся списке.
   1. Выберите свой **регион** в раскрывающемся списке.

      > [!NOTE]
      > Вы можете создать группу ресурсов, выбрав "Создать **"**.

   1. Выберите **"Подготовка"**.

1. Появится диалоговое окно со сведениями о том, что плата может быть добавлена в соответствии с использованием Azure. Выберите **"Подготовка"**.

   :::image type="content" source="../assets/images/Tools-and-SDK-revamp/Provision-cloud-resources-in-TTK-VS/teams-toolkit-vs-provision-warning.png" alt-text="Предупреждение о подготовке":::

   Процесс подготовки создает ресурсы в облаке Azure. Ход выполнения можно отслеживать, просмотрев окно вывода Набора средств Teams.

1. После завершения подготовки появится запрос. Выберите **"Просмотреть подготовленные ресурсы** ", чтобы просмотреть все подготовленные ресурсы.

   :::image type="content" source="../assets/images/Tools-and-SDK-revamp/Provision-cloud-resources-in-TTK-VS/teams-toolkit-vs-provision-provision-success.png" alt-text="Просмотр подготовленных ресурсов":::

## <a name="create-resources"></a>Создание ресурсов

При активации команды подготовки в Teams Toolkit или TeamsFx CLI можно создать следующие ресурсы:

* Microsoft Azure Active Directory (Azure AD) в клиенте Microsoft 365.
* Регистрация приложения Teams на платформе Teams клиента Microsoft 365.
* Ресурсы Azure в выбранной подписке Azure.

При создании проекта также необходимо создать ресурсы Azure. Шаблоны Azure Resource Manager (ARM) определяют все ресурсы Azure и помогают создавать необходимые ресурсы Azure во время подготовки.

В следующем списке показано создание ресурсов для различных типов приложений и ресурсов Azure:
<br>

<details>
<summary><b>Создание ресурсов для приложения вкладки Teams</b></summary>

| Ресурс | Назначение | Описание |
| --- | --- | --- |
| План службы приложений | Размещает веб-приложение на вкладке. | Неприменимо |
| Служба приложений | Размещает приложение вкладки Blazor и простой сервер проверки подлинности, который помогает получить доступ к другим службам. | Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure. |
| Управление удостоверениями | Проверка подлинности запросов между службами Azure. | Совместное использование различных возможностей и ресурсов. |

</details>
<br>

<details>
<summary><b>Создание ресурса для приложения расширения сообщений Teams</b></summary>

| Ресурс | Назначение | Описание |
| --- | --- | --- |
| Бот Azure | Регистрирует приложение в качестве бота в платформе бота. | Подключает бота к Teams. |
| Служба приложений плана | Размещает приложение веб-бота. | Неприменимо |
| Служба приложений | Размещает приложение бота. | Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure. |
| Управление удостоверениями | Проверка подлинности запросов между службами Azure. | Совместное использование различных возможностей и ресурсов. |

</details>
<br>

<details>
<summary><b>Создание ресурсов для приложения командного бота Teams</b></summary>

| Ресурс | Назначение | Описание |
| --- | --- | --- |
| Бот Azure | Регистрирует приложение в качестве бота в платформе бота. | Подключает бота к Teams. |
| План службы приложений | Размещает приложение веб-бота. | Неприменимо |
| Служба приложений | Размещает приложение бота. | Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure. |
| Управление удостоверениями | Проверка подлинности запросов между службами Azure. | Совместное использование различных возможностей и ресурсов. |

</details>
<br>

<details>
<summary><b>Создание ресурсов для бота уведомлений Teams с помощью триггера HTTP (сервер веб-API)</b></summary>

| Ресурс | Назначение | Описание |
| --- | --- | --- |
| Бот Azure | Регистрирует приложение в качестве бота в платформе бота. | Подключает бота к Teams. |
| План службы приложений | Размещает приложение веб-бота. | Неприменимо |
| Служба приложений | Размещение приложения бота. | Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure. |
| Управляемое удостоверение | Проверка подлинности запросов между службами Azure. | Совместное использование различных возможностей и ресурсов. |

</details>
<br>

<details>
<summary><b>Создание ресурсов для бота уведомлений Teams с помощью триггера HTTP (функция Azure)</b></summary>

| Ресурс | Назначение | Описание |
| --- | --- | --- |
| Бот Azure | Регистрирует приложение в качестве бота в платформе бота. | Подключает бота к Teams. |
| Управление удостоверениями | Выполняет проверку подлинности запросов между службами Azure. | Совместное использование различных возможностей и ресурсов. |
| Учетная запись хранения | Помогает создать приложение-функцию. | Неприменимо |
| План службы приложений | Размещает приложение бота-функции. | Неприменимо |
| Приложение-функция | Размещает приложение бота. | - Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure.<br>- Добавляет правило общего доступа к ресурсам независимо от источника (CORS), чтобы разрешить запросы из приложения вкладки.<br>- Добавляет параметр проверки подлинности, который разрешает только запросы из приложения Teams.<br>- Добавляет параметры приложения, необходимые пакету SDK teamsFx. |

</details>
<br>

<details>
<summary><b>Создание ресурсов для бота уведомлений Teams с триггером таймера (функция Azure)</b></summary>

| Ресурс | Назначение | Описание |
| --- | --- | --- |
| Бот Azure | Регистрирует приложение в качестве бота в платформе бота. | Подключает бота к Teams. |
| Управление удостоверениями | Проверка подлинности запросов между службами Azure. | Совместное использование различных возможностей и ресурсов. |
| Учетная запись хранения | Помогает создать приложение-функцию. | Не применимо. |
| План службы приложений | Размещает приложение бота-функции. | Неприменимо |
| Приложение-функция | Размещает приложение бота. | - Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure.<br>- Добавляет правило общего доступа к ресурсам независимо от источника (CORS), чтобы разрешить запросы из приложения вкладки.<br>- Добавляет параметр проверки подлинности, который разрешает только запросы из приложения Teams.<br>- Добавляет параметры приложения, необходимые пакету SDK teamsFx. |

</details>
<br>

<details>
<summary><b>Создание ресурсов для бота уведомлений Teams с триггером HTTP и триггером таймера (функция Azure)</b></summary>

| Ресурс | Назначение | Описание |
| --- | --- | --- |
| Бот Azure | Регистрирует приложение в качестве бота в платформе бота. | Подключает бота к Teams. |
| Управление удостоверениями | Проверка подлинности запросов между службами Azure. | Совместное использование различных возможностей и ресурсов. |
| Учетная запись хранения | Помогает создать приложение-функцию. | Неприменимо |
| План службы приложений | Размещает приложение бота-функции. | Неприменимо |
| Приложение-функция | Размещает приложение бота. | - Добавляет назначенное пользователем удостоверение для доступа к другим ресурсам Azure.<br>- Добавляет правило общего доступа к ресурсам независимо от источника (CORS), чтобы разрешить запросы из приложения вкладки.<br>- Добавляет параметр проверки подлинности, который разрешает только запросы из приложения Teams.<br>- Добавляет параметры приложения, необходимые пакету SDK teamsFx. |

</details>
<br>

### <a name="manage-your-resources"></a>Управление ресурсами

Вы можете войти [в портал Azure и](https://portal.azure.com/) управлять всеми ресурсами, созданными набором средств Teams.

* Вы можете выбрать группу ресурсов из существующего списка или новой созданной группы ресурсов.
* Вы можете просмотреть сведения о группе ресурсов, выбранной в разделе обзора оглавлной таблицы.

## <a name="customize-resource-provision"></a>Настройка подготовки ресурсов

Набор средств Teams позволяет использовать инфраструктуру для подхода к коду для определения ресурсов Azure, которые необходимо подготовить. Конфигурацию в Наборе средств Teams можно изменить в соответствии с вашими требованиями.

Набор средств Teams использует шаблон ARM для определения ресурсов Azure. Шаблон ARM — это набор файлов bicep, определяющий инфраструктуру и конфигурацию проекта. Ресурсы Azure можно настраивать, изменяя шаблон ARM. Дополнительные сведения см. в [документе по bicep](/azure/azure-resource-manager/bicep).

Подготовка с помощью ARM включает в себя изменение следующих наборов файлов, параметров и шаблонов:

* Файлы параметров ARM (`azure.parameters.{your_env_name}.json`), расположенные в папке `.fx/configs` , для передачи параметров в шаблоны.
* Файлы шаблонов ARM, расположенные в `templates/azure` папке, содержат следующие файлы:

| Файл | Функция | Разрешение настройки |
| --- | --- | --- |
| main.bicep | Укажите точку входа для ресурса Azure. Предоставление | Да |
| provision.bicep | Создание и настройка ресурсов Azure. | Да |
| config.bicep | Добавьте необходимые конфигурации TeamsFx в ресурсы Azure. | Да |
| provision/xxx.bicep | Создайте и настройте каждый ресурс Azure, потребляемый `provision.bicep`. | Да |
| teamsfx/xxx.bicep | Добавьте необходимые конфигурации TeamsFx в каждый ресурс Azure, используемый `config.bicep`.| Нет |

> [!NOTE]
> После добавления ресурсов или возможностей в проект `teamsfx/xxx.bicep` создается повторно. Чтобы изменить файлы bicep, можно использовать Git для отслеживания изменений в файлах `teamsfx/xxx.bicep` . Это не приводит к потере изменений при добавлении ресурсов или возможностей в проект.

В файлах шаблонов ARM для параметров используются заполнители. Назначение заполнителей — обеспечить создание новых ресурсов в новой среде. Фактические значения разрешены из `.fx/states/state.{env}.json` файла.

### <a name="azure-ad-application-related-parameters"></a>Azure AD параметров, связанных с приложением

| Имя параметра | Заполнитель значения по умолчанию | Значение заполнителя | Создание и настройка |
| --- | --- | --- | --- |
| Microsoft 365 ClientId | {{state.fx-resource-aad-app-for-teams.clientId}} | Идентификатор клиента Azure AD приложения, созданный во время подготовки. | [Использование существующего приложения Azure AD для приложения Teams](#use-an-existing-azure-ad-app-for-your-teams-app) |
| Microsoft 365 ClientSecret | {{state.fx-resource-aad-app-for-teams.clientSecret}} | Секрет клиента Azure AD приложения, созданный во время подготовки. | [Использование существующего приложения Azure AD для приложения Teams](#use-an-existing-azure-ad-app-for-your-teams-app)  |
| Идентификатор клиента Microsoft 365 | {{state.fx-resource-aad-app-for-teams.tenantId}} | Идентификатор клиента приложения Azure AD приложения. | [Использование существующего приложения Azure AD для приложения Teams](#use-an-existing-azure-ad-app-for-your-teams-app)  |
| Microsoft 365 OAuthAuthorityHost | {{state.fx-resource-aad-app-for-teams.oauthHost}} | OAuth authority host of your app's Azure AD app. | [Использование существующего приложения Azure AD для приложения Teams](#use-an-existing-azure-ad-app-for-your-teams-app) |
| botAadAppClientId | {{state.fx-resource-bot.botId}} | Идентификатор клиента Azure AD бота, созданный во время подготовки. | [Использование существующего приложения Azure AD для бота](#use-an-existing-azure-ad-app-for-your-bot) |
| botAadAppClientSecret | {{state.fx-resource-bot.botPassword}} | Секрет клиента Azure AD бота, созданный во время подготовки. | [Использование существующего приложения Azure AD для бота](#use-an-existing-azure-ad-app-for-your-bot) |

### <a name="reference-environment-variables-in-parameter-files"></a>Ссылочные переменные среды в файлах параметров

Если значение является секретным, вам не нужно жестко кодировать их в файле параметров. Файлы параметров поддерживают ссылки на значения из переменных среды. Этот синтаксис можно использовать в `{{$env.YOUR_ENV_VARIABLE_NAME}}` значениях параметров набора средств Teams для разрешения из текущей переменной среды.

В следующем примере считывается значение параметра `mySelfHostedDbConnectionString` из переменной среды `DB_CONNECTION_STRING`:

```json
...
    "mySelfHostedDbConnectionString": "{{$env.DB_CONNECTION_STRING}}"
...
```

### <a name="customize-arm-template-files"></a>Настройка файлов шаблонов ARM

Если стандартные шаблоны не соответствуют требованиям приложения, можно настроить шаблоны ARM в папке `templates/azure` . Например, можно настроить шаблон ARM, чтобы создать дополнительные ресурсы Azure для приложения. Вам потребуется базовое знание языка bicep, который используется для создания шаблона ARM.

Чтобы инструмент TeamsFx правильно функционирует, настройте шаблон ARM, который соответствует следующему требованию:

* Убедитесь, что структура папки и имя файла остаются неизменными. Средство может добавлять новое содержимое к существующим файлам при добавлении дополнительных ресурсов или возможностей в проект.
* Убедитесь, что имена автоматически созданных параметров и их свойств остаются невмесятыми. Автоматически созданные параметры можно использовать при добавлении дополнительных ресурсов или возможностей в проект.
* Убедитесь, что выходные данные автоматически созданного шаблона ARM также не изменились. Вы можете добавить дополнительные выходные данные в шаблон ARM. Выходные данные можно использовать `.fx/states/state.{env}.json` и использовать в других функциях, таких как развертывание и проверка файла манифеста.

### <a name="customize-teams-app"></a>Настройка приложения Teams

Вы можете настроить бот или приложение Teams, добавив фрагменты конфигурации для использования Azure AD приложения, созданного вами. Это можно сделать следующими способами:

#### <a name="use-an-existing-azure-ad-app-for-your-teams-app"></a>Использование существующего приложения Azure AD для приложения Teams

Вы можете добавить следующий фрагмент конфигурации`.fx/configs/config.{env}.json`, чтобы использовать Azure AD приложение, созданное вами для приложения Teams. Чтобы создать Azure AD, перейдите по ссылке<https://aka.ms/teamsfx-existing-aad-doc>.

```json
"auth": {
    "clientId": "<your Azure AD app client id>",
    "clientSecret": "{{$env.ENV_NAME_THAT_STORES_YOUR_SECRET}}",
    "objectId": "<your Azure AD app object id>",
    "accessAsUserScopeId": "<id of the access_as_user scope>"
}
```

После добавления фрагмента добавьте секрет клиента в связанную переменную среды, чтобы набор средств Teams разрешал фактический секрет клиента во время подготовки.

> [!NOTE]
> Убедитесь, что одно и то же приложение Azure AD не используется в нескольких средах. Если у вас нет разрешения на обновление Azure AD, вы получите предупреждение с инструкциями по обновлению приложения Azure AD вручную. Следуйте этим инструкциям, чтобы обновить Azure AD после подготовки.

#### <a name="use-an-existing-azure-ad-app-for-your-bot"></a>Использование существующего приложения Azure AD для бота

Вы можете добавить следующий фрагмент конфигурации`.fx/configs/config.{env}.json`, чтобы использовать приложение Azure AD, созданное для бота:

```json
"bot": {
    "appId": "<your Azure AD app client id>",
    "appPassword": "{{$env.ENV_NAME_THAT_STORES_YOUR_SECRET}}"
}
```

После добавления фрагмента добавьте секрет клиента в связанную переменную среды для Набора средств Teams, чтобы разрешить фактический секрет клиента во время подготовки.

#### <a name="skip-adding-user-for-sql-database"></a>Пропустить добавление пользователя для SQL базы данных

Если при попытке добавить пользователя в базу данных SQL при попытке добавить пользователя в базу данных SQL возникает ошибка с недостаточным разрешением, `.fx/configs/config.{env}.json` можно добавить следующий фрагмент конфигурации, чтобы пропустить добавление пользователя базы данных SQL:

```json
"skipAddingSqlUser": true
```

::: zone-end

## <a name="see-also"></a>Дополнительные ресурсы

* [Развертывание приложения Teams в облаке](deploy.md)
* [Управление несколькими средами](TeamsFx-multi-env.md)
* [Совместная работа с другими разработчиками в проекте Teams](TeamsFx-collaboration.md)
* [Развертывание приложения Teams в облаке с помощью Visual Studio](deploy-teams-app.md)
* [Изменение манифеста приложения Teams с помощью Visual Studio](VS-TeamsFx-preview-and-customize-app-manifest.md)
* [Локальная отладка приложения Teams для Visual Studio](debug-teams-app-visual-studio.md)
