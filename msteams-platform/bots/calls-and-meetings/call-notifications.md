---
title: Технические подробности об обработке уведомлений о входящем звонке
description: Подробная техническая информация об обработке уведомлений от входящих вызовов
keywords: сопоставление для уведомлений о вызовах в области обратного вызова
ms.date: 04/02/2019
ms.openlocfilehash: be8860ff70cd7dff4fd9599079ea7aab4f454174
ms.sourcegitcommit: 4329a94918263c85d6c65ff401f571556b80307b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2020
ms.locfileid: "41675587"
---
# <a name="incoming-call-notifications-technical-details"></a>Уведомления о входящем звонке: технические сведения

В процессе [регистрации абонента и приглашения на собрание для Microsoft Teams](./registering-calling-bot.md#creating-a-new-bot-or-adding-calling-capabilities-to-an-existing-bot)мы упомянули URL-адрес веб-перехватчика **(для вызова)** — конечная точка веб-перехватчика для всех входящих вызовов в Bot. В этом разделе обсуждаются технические сведения, которые необходимо ответить на эти уведомления.

## <a name="protocol-determination"></a>Определение протокола

Входящее уведомление предоставляется в устаревшем формате для совместимости с предыдущим [протоколом Skype](/azure/bot-service/dotnet/bot-builder-dotnet-real-time-media-concepts?view=azure-bot-service-3.0). Чтобы преобразовать вызов в протокол Microsoft Graph, ваш Bot должен определить, находится ли уведомление в устаревшем формате и ответить:

```http
HTTP/1.1 204 No Content
```

Ваш робот снова получит уведомление, но на этот раз в протоколе Microsoft Graph.

В будущих выпусках мультимедийной платформы реального времени мы разберем, как настроить протокол, поддерживаемый приложением, чтобы избежать получения исходного обратного вызова в устаревшем формате.

## <a name="redirects-for-region-affinity"></a>Перенаправление для сходства региона

Вы назовите свой веб-перехватчик из центра обработки данных, в котором размещен вызов. Вызов может начаться в любом центре обработки данных и не потребует сходства с областями счетов. Уведомление будет отправлено в развертывание в зависимости от разрешения GeoDNS. Если приложение определяет, изменив полезные полезные данные уведомления или иным образом, оно должно выполняться в другом развертывании, приложение может ответить следующим образом:

```http
HTTP/1.1 302 Found
Location: your-new-location
```

Разрешить интерфейсу Bot отвечать на входящий вызов с помощью API [ответов](https://developer.microsoft.com/graph/docs/api-reference/beta/api/call_answer) . Вы можете задать `callbackUri` обработку этого конкретного вызова. Это полезно для экземпляров с _ведением состояния_ , где вызов обрабатывается определенным разделом и необходимо внедрить эту информацию в маршрут `callbackUri` для маршрутизации в нужный экземпляр.

## <a name="authenticating-the-callback"></a>Проверка подлинности обратного вызова

Ваш робот должен проверить маркер, отправленный на веб-перехватчик, чтобы проверить запрос. Когда API отправляется в веб-перехватчик, сообщение POST HTTP содержит маркер OAuth в заголовке авторизации в качестве маркера носителя с аудиторией в качестве идентификатора приложения.

Приложение должно проверить этот маркер, прежде чем принимать запрос обратного вызова.

```http
POST https://bot.contoso.com/api/calls
Content-Type: application/json
Authentication: Bearer <TOKEN>

"value": [
    "subscriptionId": "2887CEE8344B47C291F1AF628599A93C",
    "subscriptionExpirationDateTime": "2016-11-20T18:23:45.9356913Z",
    "changeType": "updated",
    "resource": "/app/calls/8A934F51F25B4EE19613D4049491857B",
    "resourceData": {
        "@odata.type": "#microsoft.graph.call",
        "state": "Established"
    }
]
```

Маркер OAuth будет иметь значения, подобные приведенным ниже, и будет подписан Skype. Конфигурацию OpenID, опубликованную <https://api.aps.skype.com/v1/.well-known/OpenIdConfiguration> в, можно использовать для проверки маркера.

```json
{
    "aud": "0efc74f7-41c3-47a4-8775-7259bfef4241",
    "iss": "https://api.botframework.com",
    "iat": 1466741440,
    "nbf": 1466741440,
    "exp": 1466745340,
    "tid": "1fdd12d0-4620-44ed-baec-459b611f84b2"
}
```

* **ауд** аудитория — это URI идентификатора приложения, указанный для приложения.
* **tid** — идентификатор клиента для contoso.com.
* **ISS** — это поставщик маркеров, `https://api.botframework.com`.

При обработке кода веб-перехватчику необходимо проверить маркер, убедиться, что срок его действия истек, и проверить, подписан ли он опубликованной конфигурацией OpenID. Кроме того, необходимо проверить, соответствует ли **ауд** идентификатору приложения, прежде чем принимать запрос обратного вызова.

В [примере](https://github.com/microsoftgraph/microsoft-graph-comms-samples/blob/master/Samples/Common/Sample.Common/Authentication/AuthenticationProvider.cs) показано, как проверить входящие запросы.
