---
title: Как разрабатывать звонки на Боты и собраний по сети на локальном компьютере
description: Узнайте, как использовать ngrok для разработки звонков и собраний по сети боты на локальном компьютере.
keywords: Локальная разработка ngrok туннеля
ms.date: 11/18/2018
ms.openlocfilehash: b6cd2ba5a3866da8085b3da42377ab9e21f12f5f
ms.sourcegitcommit: 4329a94918263c85d6c65ff401f571556b80307b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2020
ms.locfileid: "41675585"
---
# <a name="how-to-develop-calling-and-online-meeting-bots-on-your-local-pc"></a>Как разрабатывать звонки на Боты и собраний по сети на локальном компьютере

В разделе [Запуск и отладка приложения](../../concepts/build-and-test/debug.md) мы объясним, как использовать [ngrok](https://ngrok.com) для создания туннеля между локальным компьютером и Интернетом. В этом разделе рассказывается о том, как использовать ngrok и локальный компьютер для разработки Боты, поддерживающих звонки и собрания по сети.

Обмен сообщениями Боты использовать HTTP, но звонки и собрания по сети Боты используют протокол TCP нижнего уровня. Ngrok поддерживает туннели TCP в дополнение к туннелям HTTP; Вы узнаете, как ниже.

## <a name="configuring-ngrokyml"></a>Настройка ngrok. yml

Перейдите в [ngrok](https://ngrok.com) и запишитесь на бесплатную учетную запись или войдите в существующую учетную запись. Войдя в систему, перейдите на [панель мониторинга](https://dashboard.ngrok.com) и получите аустокен.

Создайте файл `ngrok.yml` конфигурации ngrok [(Подробнее о](https://ngrok.com/docs#config) том, где можно найти этот файл) и добавьте следующую строку:

  `authtoken: <Your-AuthToken>`

## <a name="setting-up-signaling"></a>Настройка сигнализации

В разделе [звонки и собрания по сети Боты](./calls-meetings-bots-overview.md)мы обсуждали сигнал о вызове, как боты обнаруживает и реагирует на новые вызовы и события во время вызова. События сигнализации вызовов отправляются по протоколу HTTP POST в конечную точку абонента Bot.

Как и в случае с API обмена сообщениями Bot, чтобы платформа для работы с мультимедийными данными в режиме реального времени применялись к Bot, ваш робот должен быть достижим через Интернет. Ngrok делает это простым — добавьте следующие строки в Ngrok. yml:

```yaml
tunnels:
    signaling:
        addr: 12345
        proto: http
```

## <a name="setting-up-local-media"></a>Настройка локальных носителей

> [!NOTE]
> Этот раздел необходим только для приложений Media Боты, размещаемых в приложении, и может быть пропущен, если вы не размещаете мультимедиа самостоятельно.

На носителях, размещаемых в приложении, используются сертификаты и туннели TCP. Необходимо выполнить следующие действия:

- Общедоступные конечные точки TCP Ngrok имеют фиксированные URL-адреса. Они есть `0.tcp.ngrok.io`, `1.tcp.ngrok.io`и так далее. Для службы должна быть указана запись CNAME DNS, указывающая на эти URL-адреса. В `0.bot.contoso.com` этом примере подразумевается, что давайте будем `0.tcp.ngrok.io`ссылаться `1.bot.contoso.com` `1.tcp.ngrok.io`на и т. д.
- Для URL-адресов необходим SSL-сертификат. Чтобы упростить этот процесс, используйте SSL-сертификат, выданный для домена с подстановочными знаками. В этом случае это будет `*.bot.contoso.com`. Этот SSL-сертификат проверяется с помощью пакета SDK Media, поэтому он должен быть сопоставлен общедоступному URL-адресу Bot. Обратите внимание на отпечаток и установите его в сертификатах компьютера.
- Теперь настройте туннель TCP, чтобы переадресовать трафик на localhost. Запишите следующие строки в файл ngrok. yml:

    ```yaml
    media:
        addr: 8445
        proto: tcp
    ```

## <a name="start-ngrok"></a>Запуск ngrok

Теперь, когда конфигурация ngrok готова, запустите ее:

  `ngrok.exe start -all -config <Path to your ngrok.yml>`

При этом запускается ngrok и определяются общедоступные URL-адреса, которые обеспечивают туннель для локального узла. Результат выглядит следующим образом:

```cmd
Forwarding  http://signal.ngrok.io -> localhost:12345
Forwarding  https://signal.ngrok.io -> localhost:12345
Forwarding  tcp://1.tcp.ngrok.io:12332 -> localhost:8445
```

`12345` Это сигнальный порт, `8445` размещенный в приложении, и `12332` является удаленным портом мультимедиа, предоставляемым ngrok. Обратите внимание, что у нас `1.bot.contoso.com` есть `1.tcp.ngrok.io`переадресация из. Он будет использоваться в качестве URL-адреса для устройства Bot. Конечно, эти номера портов являются простыми примерами, и вы можете использовать любой доступный порт.

### <a name="update-code"></a>Обновление кода

После запуска и запуска ngrok обновите код, чтобы использовать только что настроенную конфигурацию.

#### <a name="update-signaling"></a>Обновление сигналов

- В вызове Ботбуилдер замените `NotificationUrl` на сигнальный URL-адрес, предоставленный ngrok.

```csharp
statefulClientBuilder.SetNotificationUrl(
    new Uri("https://signal.ngrok.io/notificationEndpoint"))
```

> [!NOTE]
> Замените сигнал на тот, который предоставляется ngrok, и `NotificationEndpoint` путь к контроллеру, который получает уведомление.

> **Важно!** URL-адрес `SetNotificationUrl` должен иметь значение HTTPS.

> **Важно!** локальный экземпляр должен прослушивать трафик HTTP в сигнальном порте. Запросы, совершенные на платформе "звонки и собрания по сети", будут достигать HTTP-трафика localhost, если не настроено сквозное шифрование.

#### <a name="update-media"></a>Обновление мультимедиа

`MediaPlatformSettings` Обновите указанные ниже.

```csharp
var mediaPlatform = new MediaPlatformSettings
{
    ApplicationId = <Your application id>
    MediaPlatformInstanceSettings = new MediaPlatformInstanceSettings
    {
        CertificateThumbprint = <Your SSL Cert thumbprint>,
        InstanceInternalPort = <Localhost media port>,
        InstancePublicPort = <Ngrok exposed remote media port>,
        InstancePublicIPAddress = new IPAddress(0x0),
        ServiceFqdn = <Media url for bot (eg: 1.bot.contoso.com)>,
    },
}
```

> [!NOTE]
> Указанный выше отпечаток сертификата должен быть соответствующим полному доменному имени службы. Причина в том, что записи DNS являются обязательными.

## <a name="next-steps"></a>Дальнейшие действия

Теперь Bot можно запускать локально и все потоки работают с локального узла.

## <a name="caveats"></a>Предостережения

- Свободные учетные записи Ngrok **не** обеспечивают сквозное шифрование. Данные HTTPS заканчиваются на URL-адресе ngrok и потоки данных, не зашифрованные `localhost`из ngrok в. Если требуется сквозное шифрование, рассмотрите платную учетную запись ngrok. Для выполнения действий, описанных в статье Настройка безопасных сквозных туннельных туннелей, обратитесь к разделу [туннели TLS](https://ngrok.com/docs#tls) .
- Так как URL-адрес обратного вызова Bot является динамическим, для входящих сценариев вызовов требуется часто обновлять конечные точки ngrok. Одним из способов устранения этой ошибки является использование платной учетной записи ngrok, предоставляющей фиксированные поддомены, для которых можно указать вашу Bot и платформу.
- Туннели Ngrok также можно использовать с [фабрикой служб Azure](/azure/service-fabric/service-fabric-overview). Пример, как это сделать, приведен в [примере приложения хуебот](/microsoftgraph/microsoft-graph-comms-samples/tree/master/Samples/LocalMediaSamples/HueBot/HueBot).
