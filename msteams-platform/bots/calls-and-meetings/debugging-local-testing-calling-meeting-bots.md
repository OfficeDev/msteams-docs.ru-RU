---
title: Локальная отладка бота для звонков и собраний
description: Узнайте, как можно также использовать ngrok для разработки звонков и ботов собраний по сети на локальном компьютере.
ms.topic: how-to
keywords: локальный туннель ngrok для разработки
ms.date: 11/18/2018
ms.openlocfilehash: e9b77df18c8d80f02134dc7912b5796023082039
ms.sourcegitcommit: 976e870cc925f61b76c3830ec04ba6e4bdfde32f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/27/2021
ms.locfileid: "50014308"
---
# <a name="how-to-develop-calling-and-online-meeting-bots-on-your-local-pc"></a>Разработка ботов для звонков и собраний по сети на локальном компьютере

В [окне "Запуск и отлагивание"](../../concepts/build-and-test/debug.md) приложения мы объясним, как использовать [ngrok](https://ngrok.com) для создания туннеля между локальным компьютером и Интернетом. В этом разделе вы узнаете, как можно также использовать ngrok и локальный компьютер для разработки ботов, которые поддерживают звонки и собрания по сети.

Боты для обмена сообщениями используют протокол HTTP, но боты для звонков и собраний по сети используют TCP более низкого уровня. Ngrok поддерживает также туннели TCP, а также туннели HTTP; вы узнаете, как это сделать, ниже.

## <a name="configuring-ngrokyml"></a>Настройка ngrok.yml

Перейдите [в ngrok](https://ngrok.com) и зарегистрйдите для бесплатной учетной записи или войдите в существующую учетную запись. После входа перейдите на панель мониторинга и [получите](https://dashboard.ngrok.com) свой authtoken.

Создайте файл конфигурации ngrok (дополнительные сведения о расположении этого файла) и добавьте `ngrok.yml` данная строка: [](https://ngrok.com/docs#config)

  `authtoken: <Your-AuthToken>`

## <a name="setting-up-signaling"></a>Настройка сигналов

В [ботах звонков](./calls-meetings-bots-overview.md)и собраний по сети мы обсуждают сигналы звонков — как боты обнаруживают новые вызовы и события во время звонка и реагируют на них. События сигналов вызова отправляются через HTTP POST в конечную точку вызова бота.

Как и в API сообщений бота, для связи с ботом с помощью платформы мультимедиа в режиме реального времени бот должен быть досяжим через Интернет. Ngrok упрощает эту и добавляет следующие строки в ngrok.yml:

```yaml
tunnels:
    signaling:
        addr: 12345
        proto: http
```

## <a name="setting-up-local-media"></a>Настройка локального носители

> [!NOTE]
> Этот раздел необходим только для ботов мультимедиа, которые есть в приложении, и его можно пропустить, если вы не разведете мультимедиа самостоятельно.

Носители, которые используются в приложении, используют сертификаты и туннели TCP. Необходимы следующие действия:

- Общедоступные конечные точки TCP Ngrok имеют фиксированные URL-адреса. Это `0.tcp.ngrok.io` и `1.tcp.ngrok.io` так далее. Для службы должна быть запись DNS CNAME, которая указывает на эти URL-адреса. В этом примере, предположим, `0.bot.contoso.com` относится `0.tcp.ngrok.io` к , `1.bot.contoso.com` относится и так `1.tcp.ngrok.io` далее.
- Для URL-адресов требуется SSL-сертификат. Чтобы у вас было просто, используйте SSL-сертификат, выданный для домена с поддиапными карточками. В этом случае это будет `*.bot.contoso.com` . Этот SSL-сертификат проверяется с помощью media SDK, поэтому он должен совпадать с общедоступным URL-адресом бота. Обратите внимание на отпечаток и установите его в сертификаты компьютера.
- Теперь настроим туннель TCP, чтобы перенапорять трафик на localhost. Напишите в ngrok.yml следующие строки:

    ```yaml
    media:
        addr: 8445
        proto: tcp
    ```

## <a name="start-ngrok"></a>Запуск ngrok

Теперь, когда конфигурация ngrok готова, запустите ее:

  `ngrok.exe start -all -config <Path to your ngrok.yml>`

При этом запускается ngrok и определяются общедоступные URL-адреса, которые предоставляют туннеля для localhost. Выходные данные выглядят следующим образом:

```cmd
Forwarding  http://signal.ngrok.io -> localhost:12345
Forwarding  https://signal.ngrok.io -> localhost:12345
Forwarding  tcp://1.tcp.ngrok.io:12332 -> localhost:8445
```

Здесь находится сигнальный порт, который является портом, который находится в приложении и является удаленным портом мультимедиа, который `12345` `8445` `12332` выставил ngrok. Обратите внимание, что у нас есть переад `1.bot.contoso.com` вперед. `1.tcp.ngrok.io` Он будет использоваться в качестве URL-адреса мультимедиа для бота. Конечно, эти номера портов являются лишь примерами, и вы можете использовать любой доступный порт.

### <a name="update-code"></a>Обновление кода

После запуска ngrok обновите код, чтобы использовать только что настроенную вами config.

#### <a name="update-signaling"></a>Обновление сигналов

- В вызове BotBuilder измените url-адрес сигнала, `NotificationUrl` предоставленный ngrok.

```csharp
statefulClientBuilder.SetNotificationUrl(
    new Uri("https://signal.ngrok.io/notificationEndpoint"))
```

> [!NOTE]
> Замените сигнал на сигнал, предоставленный ngrok, и путь `NotificationEndpoint` контроллера, который получает уведомление.

> **ВАЖНО!** URL-адрес `SetNotificationUrl` должен иметь значение HTTPS.

> **ВАЖНО!** Локальный экземпляр должен прослушивать ТРАФИК HTTP на сигнальный порт. Запросы, сделанные платформой звонков и собраний по сети, будут достигать бота в качестве HTTP-трафика localhost, если не настроено шифрование.

#### <a name="update-media"></a>Обновление носители

`MediaPlatformSettings`Обновите свою следующую версию.

```csharp
var mediaPlatform = new MediaPlatformSettings
{
    ApplicationId = <Your application id>
    MediaPlatformInstanceSettings = new MediaPlatformInstanceSettings
    {
        CertificateThumbprint = <Your SSL Cert thumbprint>,
        InstanceInternalPort = <Localhost media port>,
        InstancePublicPort = <Ngrok exposed remote media port>,
        InstancePublicIPAddress = new IPAddress(0x0),
        ServiceFqdn = <Media url for bot (eg: 1.bot.contoso.com)>,
    },
}
```

> [!NOTE]
> Отпечаток сертификата, предоставленный выше, должен соответствовать FQDN службы. Именно поэтому требуются записи DNS.

## <a name="next-steps"></a>Дальнейшие действия

Теперь бот может запускаться локально, и все потоки работают с вашего localhost.

## <a name="caveats"></a>Предостереские оговорки

- Бесплатные учетные записи Ngrok **не** обеспечивают шифрование. Данные HTTPS заканчиваются URL-адресом ngrok, а потоки данных незашифровываются из ngrok в `localhost` . Если требуется все шифрование, рассмотрите возможность платной учетной записи ngrok. Шаги по настройке безопасных конечных туннелях см. в туннелях [TLS.](https://ngrok.com/docs#tls)
- Так как URL-адрес для вызова бота является динамическим, для сценариев входящих вызовов требуется часто обновлять конечные точки ngrok. Один из способов устранить эту проблему — использовать платную учетную запись ngrok, которая предоставляет фиксированные поддомены, на которые можно указать бота и платформу.
- Туннеля Ngrok также можно использовать с [Azure Service Fabric.](/azure/service-fabric/service-fabric-overview) Пример этого см. в примере приложения [HueBot.](/microsoftgraph/microsoft-graph-comms-samples/tree/master/Samples/LocalMediaSamples/HueBot/HueBot)
