---
title: Добавление проверки подлинности для бота Teams
author: surbhigupta
description: Узнайте, как добавить проверку подлинности OAuth в бот в Teams с помощью Azure Active Directory. Узнайте, как создавать, развертывать и интегрировать боты с поддержкой проверки подлинности.
ms.topic: how-to
ms.localizationpriority: medium
ms.author: lajanuar
ms.openlocfilehash: 2a9ebf96f5795b6674646bc50dd856badf59152e
ms.sourcegitcommit: ca84b5fe5d3b97f377ce5cca41c48afa95496e28
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2022
ms.locfileid: "66142565"
---
# <a name="add-authentication-to-your-teams-bot"></a>Добавление проверки подлинности для бота Teams

Иногда может потребоваться создать ботов в Microsoft Teams, которые могут получать доступ к ресурсам от имени пользователя, например к почтовой службе.

В этой статье показано, как использовать проверку подлинности пакета SDK Службы Azure Bot версии 4 на основе OAuth 2.0. Это упрощает разработку бота, который может использовать маркеры проверки подлинности на основе учетных данных пользователя. Ключом во всем этом является использование **поставщиков удостоверений**, как мы будем видеть позже.

OAuth 2.0 — это открытый стандарт проверки подлинности и авторизации, используемый Microsoft Azure Active Directory (Azure AD) и многими другими поставщиками удостоверений. Базовое понимание OAuth 2.0 является необходимым условием для работы с проверкой подлинности в Teams.

Основные сведения см. в статье [Упрощенный обзор OAuth 2](https://aka.ms/oauth2-simplified), а полные спецификации — в статье [OAuth 2.0](https://oauth.net/2/).

Дополнительные сведения о том, как Служба Azure Bot выполняет проверку подлинности, см. в статье [Проверка подлинности пользователя в беседе](https://aka.ms/azure-bot-authentication).

В данной статье вы узнаете следующее.

- **Как создать бота с поддержкой проверки подлинности**. Вы примените [cs-auth-sample][teams-auth-bot-cs] для обработки учетных данных для входа пользователя и создания маркера проверки подлинности.
- **Как развернуть бот в Azure и связать его с поставщиком удостоверений**. Поставщик выпускает маркер на основе учетных данных для входа пользователя. Бот может использовать маркер для доступа к ресурсам, таким как почтовая служба, для которых требуется проверка подлинности. Дополнительные сведения см[. в Microsoft Teams проверки подлинности для ботов](auth-flow-bot.md).
- **Как интегрировать бота в Microsoft Teams**. После интеграции бота вы можете войти и обмениваться с ним сообщениями в чате.

## <a name="prerequisites"></a>Предварительные условия

- Знание [основ бота][concept-basics], [управления состоянием][concept-state], [библиотеки диалогов][concept-dialogs] и способа [реализации последовательного потока беседы][simple-dialog].
- Знание Azure и разработки OAuth 2.0.
- Текущие версии Microsoft Visual Studio и Git.
- Учетная запись Azure. При необходимости вы можете создать [бесплатную учетную запись Azure](https://azure.microsoft.com/free/).
- Указанный ниже пример.

    | Пример | Версия BotBuilder | Демонстрирует |
    |:---|:---:|:---|
    | **Проверка подлинности бота** в [cs-auth-sample][teams-auth-bot-cs] | версия 4 | Поддержку OAuthCard |
    | **Проверка подлинности бота** в [js-auth-sample][teams-auth-bot-js] | версия 4| Поддержку OAuthCard  |
    | **Проверка подлинности бота** в [py-auth-sample][teams-auth-bot-py] | версия 4 | Поддержку OAuthCard |

## <a name="create-the-resource-group"></a>Создание группы ресурсов

Группа ресурсов и план обслуживания не являются строго обязательными, но они позволяют легко выпускать создаваемые вами ресурсы. Это рекомендуется для упорядочения ресурсов и управления ими.

Вы воспользуетесь группой ресурсов с целью создания отдельных ресурсов для Bot Framework. Для обеспечения производительности убедитесь, что эти ресурсы находятся в одном регионе Azure.

1. В браузере войдите на [**портал Microsoft Azure**][azure-portal].
1. На панели навигации слева выберите **Группы ресурсов**.
1. В левом верхнем углу отображаемого окна выберите вкладку **Добавить**, чтобы создать группу ресурсов. Вам будет предложено указать следующее.
    1. **Подписка**. Используйте свою существующую подписку.
    1. **Группа ресурсов**. Введите имя группы ресурсов. Например: *TeamsResourceGroup*. Помните, что имя должно быть уникальным.
    1. В раскрывающемся меню **Регион** выберите *Западная часть США* или регион, близкий к вашим приложениям.
    1. Нажмите кнопку **Проверить и создать**. Должен появиться баннер с сообщением *Проверка пройдена*.
    1. Нажмите кнопку **Создать**. Создание группы ресурсов может занять несколько минут.

> [!TIP]
> Как и в случае с ресурсами, которые вы создадите далее в этом руководстве, рекомендуется закрепить эту группу ресурсов на панели мониторинга для удобного доступа. Если вы хотите сделать это, щелкните значок закрепления &#128204; в правом верхнем углу панели мониторинга.

## <a name="create-the-service-plan"></a>Создание плана обслуживания

1. На [**портале Azure**][azure-portal] в панели навигации слева выберите **Создать ресурс**.
1. В поле поиска введите *План службы приложений*. Выберите карточку **План службы приложений** в результатах поиска.
1. Нажмите **Создать**.
1. Вам будет предложено указать следующую информацию.
    1. **Подписка**. Вы можете использовать существующую подписку.
    1. **Группа ресурсов**. Выберите ранее созданную группу.
    1. **Имя**. Введите имя плана обслуживания. Например: *TeamsServicePlan*. Помните, что имя должно быть уникальным в пределах группы.
    1. **Операционная система**. Выберите *Windows* или применимую ОС.
    1. **Регион**. Выберите *Западная часть США* или регион, близкий к вашим приложениям.
    1. **Ценовая категория**. Выберите *Стандартный S1*. Это должно быть значение по умолчанию.
    1. Нажмите кнопку **Проверить и создать**. Должен появиться баннер с сообщением *Проверка пройдена*.
    1. Нажмите **Создать**. Создание плана службы приложений может занять несколько минут. План будет указан в группе ресурсов.

## <a name="create-azure-bot-resource-registration"></a>Создание регистрации ресурсов Azure Bot

Регистрация ресурсов Azure Bot регистрирует веб-службу в качестве бота в Bot Framework, которая предоставляет идентификатор приложения Майкрософт и пароль приложения (секрет клиента).

> [!IMPORTANT]
> Бот необходимо зарегистрировать только в том случае, если он не размещен в Azure. Если вы [создали бот](/azure/bot-service/abs-quickstart?view=azure-bot-service-4.0&viewFallbackFrom=azure-bot-service-3.0&preserve-view=true) на портале Azure, он уже зарегистрирован в службе. Если вы создали бот с помощью [Bot Framework](https://dev.botframework.com/bots/new) или [портала разработчика](../../../concepts/build-and-test/teams-developer-portal.md), он не зарегистрирован в Azure.

1. Перейдите на [**портал Azure**][azure-portal] и выполните поиск по запросу **Azure Bot** в разделе **Создание ресурса**.
1. Откройте **Azure Bot** нажмите **Создать**.
1. Введите имя дескриптора бота в поле **Дескриптор бота**.
1. Выберите свою **подписку** в раскрывающемся списке.
1. Выберите свою **группу ресурсов** в раскрывающемся списке.
1. Для параметра **Тип приложения** выберите **Мультитенантное** в разделе **Идентификатор приложения Майкрософт**.

    ![Мультитенантное](~/assets/images/adaptive-cards/multi-tenant.png)

1. Выберите **Проверить и создать**.

    ![Создание Azure Bot](~/assets/images/adaptive-cards/create-azure-bot.png)

1. Если проверка пройдена, нажмите **Создать**.

    Подготовка службы бота займет несколько секунд.

    ![Проверка Azure Bot](~/assets/images/adaptive-cards/validation-pane.png)

1. Выберите пункт **Перейти к ресурсу**. Бот и связанные ресурсы указаны в группе ресурсов.

    ![Перейти к ресурсу](~/assets/images/adaptive-cards/go-to-resource-card.png)

    Теперь ваш бот Azure создан.

    ![Созданный ресурс бота Azure](~/assets/images/adaptive-cards/azure-bot-ui.png)

Чтобы создать секрет клиента:

1. В разделе **Параметры** выберите **Конфигурация**. Сохраните **Идентификатор приложения Майкрософт** (идентификатор клиента) для дальнейшего использования.

    ![Идентификатор приложения Майкрософт](~/assets/images/adaptive-cards/config-microsoft-app-id.png)

1. Рядом с **идентификатором приложения Майкрософт** выберите " **Управление"**.

    ![Управление ботом](~/assets/images/adaptive-cards/manage-bot-label.png)

1. В разделе **Секреты клиента** выберите **Новый секрет клиента**. Появится окно **Добавить секрет клиента**.

    ![Новый секрет клиента](~/assets/images/adaptive-cards/new-client-secret.png)

1. Введите **описание** и нажмите **Добавить**.

    ![Секрет клиента](~/assets/images/adaptive-cards/client-secret.png)

1. В столбце **Значение** выберите **Копировать в буфер обмена** и сохраните идентификатор секрета клиента для дальнейшего использования.

    ![Значение секрета клиента](~/assets/images/adaptive-cards/client-secret-value.png)

Чтобы добавить канал Microsoft Teams:

1. Перейдите на **домашнюю страницу**.

    ![Домашняя страница бота](~/assets/images/adaptive-cards/bot-home-page.png)

1. Откройте бот, который указан в разделе **Последние ресурсы**.

1. Нажмите **Каналы** в левой области и выберите **Microsoft Teams** :::image type="icon" source="../../../assets/icons/teams-icon.png" border="false":::.

   :::image type="content" source="../../../assets/images/adaptive-cards/channel-teams.png" alt-text="Канал Teams":::

1. Установите флажок, чтобы принять условия обслуживания, и выберите **Принять**.</br>

    ![Выбор условий обслуживания](~/assets/images/adaptive-cards/select-terms-of-service.png)

1. Нажмите кнопку **Сохранить**.

    ![Выбор Teams](~/assets/images/adaptive-cards/select-teams.png)

Дополнительные сведения см. в статье [Создание бота для Teams](../create-a-bot-for-teams.md).

## <a name="create-the-identity-provider"></a>Создание поставщика удостоверений

Вам нужен поставщик удостоверений, которого можно использовать для проверки подлинности.
В этой процедуре вы будете использовать поставщик Azure AD; можно также использовать Azure AD поддерживаемых поставщиков удостоверений.

1. На [**портале Azure**][azure-portal] в области навигации слева выберите **Azure Active Directory**.
    > [!TIP]
    > Вам потребуется создать и зарегистрировать этот ресурс Azure AD в клиенте, в котором можно предоставить согласие на делегирование разрешений, запрашиваемых приложением.
    > Инструкции по созданию клиента см. в статье [Доступ к порталу и создание клиента](/azure/active-directory/fundamentals/active-directory-access-create-new-tenant).
1. На панели слева выберите **Регистрация приложений**.
1. На панели справа выберите вкладку **Новая регистрация** в левом верхнем углу.
1. Вам будет предложено указать следующую информацию.
   1. **Имя**. Введите имя приложения. Например: *BotTeamsIdentity*. Помните, что имя должно быть уникальным.
   1. Выберите **поддерживаемые типы учетных записей** для приложения. Выберите учетные записи в любом каталоге организации (любой Microsoft Azure Active Directory (Azure AD) — мультитенантный) и личных учетных записях *Майкрософт (например, Skype, Xbox).*
   1. Для **URI перенаправления**:<br/>
       &#x2713;Выберите **Веб**.<br/>
       &#x2713; Установите для URL-адреса значение `https://token.botframework.com/.auth/web/redirect`.
   1. Нажмите **Зарегистрировать**.

1. После его создания Azure отобразит страницу **обзора** для приложения. Скопируйте и сохраните следующие сведения в файл.

    1. Значение **Идентификатор приложения (клиент)**. Это значение будет использоваться позже в качестве *идентификатора клиента* при регистрации этого приложения удостоверений Azure в боте.
    1. Значение **Идентификатора каталога (клиент)**. Это значение также будет использоваться позже в качестве *идентификатора клиента* для регистрации этого приложения удостоверений Azure в боте.

1. На панели слева выберите **Сертификаты и секреты**, чтобы создать секрет клиента для приложения.

   1. В разделе **Секреты клиента** выберите &#x2795; **Новый секрет клиента**.
   1. Добавьте описание, чтобы отличать этот секрет от других секретов, которые может потребоваться создать для этого приложения, например *Приложение удостоверений бота в Teams*.
   1. Задайте значение для параметра **Срок действия**.
   1. Нажмите **Добавить**.
   1. Прежде чем покинуть эту страницу, **запишите секрет**. Это значение будет использоваться позже в качестве *секрета клиента* при регистрации приложения Azure AD в боте.

### <a name="configure-the-identity-provider-connection-and-register-it-with-the-bot"></a>Настройка подключения поставщика удостоверений и его регистрация в боте

Обратите внимание, что существует два варианта для поставщиков служб: Microsoft Azure Active Directory (Azure AD) версии 1 и Microsoft Azure Active Directory (Azure AD) версии 2.  Различия между двумя поставщиками обобщены [здесь](/azure/active-directory/azuread-dev/azure-ad-endpoint-comparison), но в целом версия 2 обеспечивает большую гибкость в отношении изменения разрешений бота.  В поле областей перечислены разрешения API Graph, а при добавлении новых разрешений боты позволяют пользователям предоставлять согласие на новые разрешения при следующем входе.  В версии 1 пользователь должен удалить согласие бота, чтобы в диалоговом окне OAuth были предложены новые разрешения.

#### <a name="microsoft-azure-active-directory-azure-ad-v1"></a>Microsoft Azure Active Directory (Azure AD) версии 1

1. На [**портале Azure**][azure-portal] выберите группу ресурсов на панели мониторинга.
1. Выберите ссылку регистрации бота.
1. Откройте страницу ресурса и выберите **Конфигурация** в разделе **Параметры**.
1. Нажмите **Добавить параметры подключения OAuth**.
На следующем изображении показан соответствующий выбор на странице ресурса.  
![Конфигурация SampleAppDemoBot](~/assets/images/authentication/sample-app-demo-bot-configuration.png)
1. Заполните форму следующим образом:

    1. **Имя**. Введите имя подключения. Это имя будет использоваться в боте в файле `appsettings.json`. Например, *BotTeamsAuthADv1*.
    1. **Поставщик службы**. Выберите **Microsoft Azure Active Directory (Azure AD)**. После выбора этого параметра отобразятся поля, относящиеся к Azure AD.
    1. **Идентификатор клиента**. Введите идентификатор приложения (клиент), записанный для приложения поставщика удостоверений Azure, на описанных выше шагах.
    1. **Секрет клиента**. Введите секрет, записанный для приложения поставщика удостоверений Azure, на описанных выше шагах.
    1. **Тип предоставления**. Введите `authorization_code`.
    1. **URL-адрес входа**. Введите `https://login.microsoftonline.com`.
    1. **ИД клиента**. Введите **идентификатор каталога (клиент)**, записанный ранее для приложения удостоверений Azure, или **общий** вариант в зависимости от поддерживаемого типа учетной записи, выбранного при создании приложения поставщика удостоверений. Чтобы решить, какое значение следует назначить, выполните следующие условия:

        - Если вы выбрали одну из учетных записей только в этом каталоге организации (только microsoft — один клиент *)* или учетные записи в любом каталоге организации *(Microsoft Azure Active Directory (Azure AD) —* несколько клиентов), введите идентификатор клиента,  записанный ранее для Microsoft Azure Active Directory (Azure AD) приложения. Это будет клиент, связанный с пользователями, которые могут проходить проверку подлинности.

        - Если вы выбрали учетные записи в любом каталоге организации (любой Microsoft Azure Active Directory (Azure AD) — многопользовательские и личные учетные записи Майкрософт *, например Skype, Xbox, Outlook),* введите общее слово вместо идентификатора клиента. В противном случае приложение Microsoft Azure Active Directory (Azure AD) выполнит проверку через клиент, идентификатор которого был выбран, и исключит личные учетные записи Майкрософт.

    з. Для **URL-адреса ресурса** введите `https://graph.microsoft.com/`. Он не используется в текущем примере кода.  
    и. Оставьте **Области** пустыми. Указанное ниже изображение является примером.

    ![представление adv1 строки подключения проверки подлинности приложения бота Teams](../../../assets/images/authentication/auth-bot-identity-connection-adv1.png)

1. Нажмите кнопку **Сохранить**.

#### <a name="microsoft-azure-active-directory-azure-ad-v2"></a>Microsoft Azure Active Directory (Azure AD) версии 2

1. На [**портале Azure**][azure-portal] выберите Azure Bot на панели мониторинга.
1. На странице ресурса выберите **Конфигурация** в разделе **Параметры**.
1. Нажмите **Добавить параметры подключения OAuth**.  
На следующем рисунке показан соответствующий выбор на странице ресурса. ![Конфигурация SampleAppDemoBot](~/assets/images/authentication/sample-app-demo-bot-configuration.png)

1. Заполните форму следующим образом:

    1. **Имя**. Введите имя подключения. Это имя будет использоваться в боте в файле `appsettings.json`. Например, *BotTeamsAuthADv2*.
    1. **Поставщик службы**. Выберите **Microsoft Azure Active Directory версии 2**. После выбора этого параметра отобразятся поля, относящиеся к Microsoft Azure Active Directory (Azure AD).
    1. **Идентификатор клиента**. Введите идентификатор приложения (клиент), записанный для приложения поставщика удостоверений Azure, на описанных выше шагах.
    1. **Секрет клиента**. Введите секрет, записанный для приложения поставщика удостоверений Azure, на описанных выше шагах.
    1. **URL-адрес Exchange маркера**. Не заполняйте это поле.
    1. **ИД клиента**. Введите **идентификатор каталога (клиент)**, записанный ранее для приложения удостоверений Azure, или **общий** вариант в зависимости от поддерживаемого типа учетной записи, выбранного при создании приложения поставщика удостоверений. Чтобы решить, какое значение следует назначить, выполните следующие условия:

        - Если вы выбрали учетные записи только в этом каталоге организации (только Microsoft — один клиент *)* или учетные записи в любом каталоге организации *(Microsoft Azure Active Directory — Несколько клиентов)*, введите идентификатор  клиента, записанный ранее для приложения Microsoft Azure Active Directory (Azure AD). Это будет клиент, связанный с пользователями, которые могут проходить проверку подлинности.

        - Если вы выбрали учетные записи в любом каталоге организации (любой Microsoft Azure Active Directory (Azure AD) — многопользовательские и личные учетные записи Майкрософт *, например Skype, Xbox, Outlook),* введите общее слово вместо идентификатора клиента. В противном случае приложение Microsoft Azure Active Directory (Azure AD) выполнит проверку через клиент, идентификатор которого был выбран, и исключит личные учетные записи Майкрософт.

    1. Для **областей** введите разделенный пробелом список разрешений графа, необходимых этому приложению, например: User.Read User.ReadBasic.All Mail.Read

1. Нажмите кнопку **Сохранить**.

### <a name="test-the-connection"></a>Проверка подключения

1. Выберите запись подключения, чтобы открыть созданное подключение.
1. Выберите **Проверить подключение** в верхней части панели **Параметр подключения поставщика службы**.
1. При первом выполнении откроется новое окно браузера с просьбой выбрать учетную запись. Выберите учетную запись, которую нужно использовать.
1. Затем вам будет предложено разрешить поставщику удостоверений использовать ваши данные (учетные данные). Указанное ниже изображение является примером.

    ![adv1 строки подключения проверки подлинности бота Teams](../../../assets/images/authentication/auth-bot-connection-test-accept.PNG)

1. Выберите **Принять**.
1. После этого вы будете перенаправлены на страницу **Проверка подключения к \<your-connection-name> успешно пройдена**. Обновите страницу, если возникает ошибка. Указанное ниже изображение является примером.

    ![adv1 строки подключения проверки подлинности приложения бота Teams](../../../assets/images/authentication/auth-bot-connection-test-token.PNG)

Имя подключения используется кодом бота для получения маркеров проверки подлинности пользователя.

## <a name="prepare-the-bot-sample-code"></a>Подготовка примера кода бота

После настройки предварительных параметров давайте сосредоточимся на создании бота, который будет использоваться в этой статье.

# <a name="cnet"></a>[C#/.NET](#tab/dotnet)

1. Клонируйте [cs-auth-sample][teams-auth-bot-cs].
1. Запустите Visual Studio.
1. На панели инструментов выберите **файл -> Открыть -> Project/Решение** и откройте проект бота.
1. В C# **обновите appsettings.json** следующим образом:

    - Установите для `ConnectionName` имя подключения поставщика удостоверений, добавленного в регистрацию бота. В этом примере используется имя *BotTeamsAuthADv1*.
    - Установите для `MicrosoftAppId` значение **идентификатора приложения бота**, сохраненного во время регистрации бота.
    - Установите для `MicrosoftAppPassword` значение **секрета клиента**, сохраненного во время регистрации бота.

    В зависимости от символов в вашем секрете бота может потребоваться применить escape-последовательность XML для пароля. Например, все амперсанды (&) необходимо закодировать как `&amp;`.

     [!code-json[appsettings](~/../botbuilder-samples/samples/csharp_dotnetcore/46.teams-auth/appsettings.json?range=1-5)]

1. В обозревателе решений перейдите в папку `TeamsAppManifest`, откройте `manifest.json` и настройте для `id` и `botId` значение **идентификатора приложения бота**, который вы сохранили во время регистрации бота.

# <a name="javascript"></a>[JavaScript](#tab/node-js)

1. Клонируйте [node-auth-sample][teams-auth-bot-js].
1. В консоли перейдите к проекту: </br></br>
`cd samples/javascript_nodejs/46.teams`  
1. Установите модули</br></br>
`npm install`
1. Обновите конфигурацию **ENV** следующим образом.

    - Установите для `MicrosoftAppId` значение **идентификатора приложения бота**, сохраненного во время регистрации бота.
    - Установите для `MicrosoftAppPassword` значение **секрета клиента**, сохраненного во время регистрации бота.
    - Установите для `connectionName` имя подключения поставщика удостоверений.
    В зависимости от символов в вашем секрете бота может потребоваться применить escape-последовательность XML для пароля. Например, все амперсанды (&) необходимо закодировать как `&amp;`.

     [!code-javascript[settings](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/.env)]

1. В папке `teamsAppManifest` откройте `manifest.json` и настройте для `id` значение **идентификатора приложения Майкрософт**, а для `botId` — значение **идентификатора приложения бота**, которые вы сохранили во время регистрации бота.

# <a name="python"></a>[Python](#tab/python)

1. Клонируйте [py-auth-sample][teams-auth-bot-py] из репозитория GitHub.
1. Обновите **config.py**:

    - Установите для `ConnectionName` имя параметра подключения OAuth, добавленного в бот.
    - Установите для `MicrosoftAppId` и `MicrosoftAppPassword` значение идентификатора приложения и секрета приложения вашего бота.

      В зависимости от символов в вашем секрете бота может потребоваться применить escape-последовательность XML для пароля. Например, все амперсанды (&) необходимо закодировать как `&amp;`.

      [!code-python[config](~/../botbuilder-samples/samples/python/46.teams-auth/config.py?range=14-16)]

---

### <a name="deploy-the-bot-to-azure"></a>Развертывание бота в Azure

Чтобы развернуть бот, выполните действия, описанные в разделе "Развертывание [бота в Azure"](https://aka.ms/azure-bot-deployment-cli).

Кроме того, в Visual Studio вы можете выполнить следующие действия.

1. В Visual Studio *Обозреватель решений* выберите и удерживайте (или щелкните правой кнопкой мыши) имя проекта.
1. В раскрывающемся меню выберите **Опубликовать**.
1. В появившемся окне щелкните ссылку **Создать**.
1. В диалоговом окне выберите **Служба приложений** слева и **Создать** справа.
1. Нажмите кнопку **Опубликовать**.
1. В следующем диалоговом окне введите необходимые сведения. Ниже приведен пример.

    ![auth-app-service](../../../assets/images/authentication/auth-bot-app-service.png)

1. Нажмите **Создать**.
1. Если развертывание завершится успешно, вы увидите, что оно отображается в Visual Studio. Кроме того, в вашем стандартном браузере отображается страница с фразой *Ваш бот готов!* URL-адрес будет примерно таким: `https://botteamsauth.azurewebsites.net/`. Сохраните его в файл.
1. В браузере перейдите на [**портал Azure**][azure-portal].
1. Проверьте группу ресурсов. Бот должен быть указан вместе с другими ресурсами. Указанное ниже изображение является примером.

    ![teams-bot-auth-app-service-group](../../../assets/images/authentication/auth-bot-app-service-in-group.png)

1. В группе ресурсов выберите имя регистрации бота (ссылка).
1. На левой панели выберите **Параметры**.
1. В поле **Конечная точка обмена сообщениями** введите URL-адрес, полученный выше, с `api/messages` в конце. Пример: `https://botteamsauth.azurewebsites.net/api/messages`.
    > [!NOTE]
    > Для бота разрешена только одна конечная точка обмена сообщениями.
1. Нажмите кнопку **Сохранить** в левом верхнем углу.

## <a name="test-the-bot-using-the-emulator"></a>Тестирование бота с помощью Emulator

Если вы еще не сделали этого, установите [Microsoft Bot Framework Emulator](https://aka.ms/bot-framework-emulator-readme). См. также статью [Отладка с помощью Emulator](https://aka.ms/bot-framework-emulator-debug-with-emulator).

Чтобы работал вход примера бота, необходимо настроить Emulator.

### <a name="configure-the-emulator-for-authentication"></a>Настройка Emulator для проверки подлинности

Если боту требуется проверка подлинности, необходимо настроить Emulator. Для настройки:

1. Запустите Emulator.
1. В Emulator щелкните значок шестеренки &#9881; левом нижнем углу или вкладку **Параметры Emulator** в правом верхнем углу.
1. Установите флажок **Использовать маркеры проверки подлинности версии 1.0**.
1. Введите локальный путь к средству **ngrok**. *См.* [вики-статью](https://github.com/Microsoft/BotFramework-Emulator/wiki/Tunneling-(ngrok)) об интеграции Bot Framework Emulator и туннелирования ngrok. Дополнительные сведения о средстве см. в разделе [ngrok](https://ngrok.com/).
1. Установите флажок **Запускать ngrok при запуске Emulator**.
1. Нажмите кнопку **Сохранить**.

Когда бот отображает карточку входа и пользователь нажимает кнопку входа, Emulator открывает страницу, которую пользователь может использовать для входа с помощью поставщика проверки подлинности.
После выполнения этих действий пользователем поставщик создает маркер пользователя и отправляет его боту. После этого бот может действовать от имени пользователя.

### <a name="test-the-bot-locally"></a>Локальное тестирование бота

После настройки механизма проверки подлинности можно выполнить фактическое тестирование бота.  

1. Запустите пример бота локально на компьютере, например с помощью Visual Studio.
1. Запустите Emulator.
1. Нажмите кнопку **Открыть бот**.
1. В поле **URL-адрес бота** введите локальный URL-адрес бота. Обычно это `http://localhost:3978/api/messages`.
1. В поле **Идентификатор приложения Майкрософт** введите идентификатор приложения бота из `appsettings.json`.
1. В поле **Пароль приложения Майкрософт** введите пароль приложения бота из `appsettings.json`.
1. Нажмите **Подключиться**.
1. После запуска бота введите любой текст, чтобы отобразить карточку входа.
1. Нажмите кнопку **Войти**.
1. Откроется всплывающее диалоговое окно для **подтверждения открытого URL-адреса**. Это позволяет пользователю бота (вам) проходить проверку подлинности.  
1. Выберите **Подтвердить**.
1. При появлении запроса выберите учетную запись соответствующего пользователя.
1. В зависимости от конфигурации, используемой для Emulator, вы получите один из следующих результатов.
    1. **Использование кода проверки входа**  
      &#x2713; Откроется окно с кодом проверки.  
      &#x2713; Скопируйте и введите код проверки в поле чата, чтобы завершить вход.
    1. **Использование маркеров проверки подлинности**.  
      &#x2713; Вы вошли с использованием ваших учетных данных.

    На следующем изображении показан пример пользовательского интерфейса бота после входа.

    ![эмулятор входа бота проверки подлинности](../../../assets/images/authentication/auth-bot-login-emulator.PNG)

1. Если вы **выберете "** Да", когда бот спросит, хотите ли вы просмотреть маркер *?* Вы получите примерно такой ответ:

    ![маркер эмулятора входа бота проверки подлинности](../../../assets/images/authentication/auth-bot-login-emulator-token.png)

1. Введите **выход** в поле ввода чата, чтобы выйти из системы. Это освобождает маркер пользователя, и бот не сможет действовать от вашего имени, пока вы не выполните вход снова.

> [!NOTE]
> Для проверки подлинности бота требуется **служба соединителя бота**. Служба получает доступ к сведениям о регистрации вашего бота.

## <a name="test-the-deployed-bot"></a>Тестирование развернутого бота

<!--There are several testing scenarios here. Ideally, we'd have a separate article on the what, why, 
and when for these, and just reference that from here, along with the set of steps that exercises the bot code.-->

1. В браузере перейдите на [**портал Azure**][azure-portal].
1. Найдите свою группу ресурсов.
1. Выберите ссылку ресурса. Отобразится страница ресурса.
1. На странице ресурса выберите **Тестировать в веб-чате**. Бот запускается и отображает предопределенное приветствие.
1. Введите что-либо в поле чата.
1. Выберите поле **Войти**.
1. Откроется всплывающее диалоговое окно для **подтверждения открытого URL-адреса**. Это позволяет пользователю бота (вам) проходить проверку подлинности.  
1. Выберите **Подтвердить**.
1. При появлении запроса выберите учетную запись соответствующего пользователя.
    На следующем изображении показан пример пользовательского интерфейса бота после входа.

    ![развернутый вход бота проверки подлинности](../../../assets/images/authentication/auth-bot-login-deployed.PNG).

1. Нажмите кнопку **Да**, чтобы отобразить маркер проверки подлинности. Указанное ниже изображение является примером.

    ![развернутый маркер входа бота проверки подлинности](../../../assets/images/authentication/auth-bot-login-deployed-token.PNG).

1. Введите "выход", чтобы выйти.

    ![развернутый выход бота проверки подлинности](../../../assets/images/authentication/auth-bot-deployed-logout.PNG)

> [!NOTE]
> Если при входе возникают проблемы, попробуйте проверить подключение еще раз, как описано в предыдущих шагах. Это может привести к повторному созданию маркера проверки подлинности.
> При использовании клиента веб-чата Bot Framework в Azure вам может потребоваться войти несколько раз, прежде чем проверка подлинности будет реализована правильно.

## <a name="install-and-test-the-bot-in-teams"></a>Установка и тестирование бота в Teams

1. В своем проекте бота убедитесь, что папка `TeamsAppManifest` содержит `manifest.json` вместе с файлами `outline.png` и `color.png`.
1. В обозревателе решений перейдите к папке `TeamsAppManifest`. Измените `manifest.json`, назначив следующие значения.
    1. Назначьте полученный во время регистрации бота **идентификатор приложения бота** для `id` и `botId`.
    1. Назначьте это значение: `validDomains: [ "token.botframework.com" ]`.
1. Выберите и **запакуйте** файлы `manifest.json`, `outline.png` и `color.png`.
1. Откройте **Microsoft Teams**.
1. В нижней части панели слева щелкните значок **Приложения**.
1. В нижней части панели справа выберите **Отправить пользовательское приложение**.
1. Перейдите в папку `TeamsAppManifest` и отправьте запакованный манифест.
Отобразится следующий мастер.

    ![отправка бота проверки подлинности Teams](../../../assets/images/authentication/auth-bot-teams-upload.png)

1. Нажмите кнопку **Добавить в группу**.
1. В следующем окне выберите команду, в которой нужно использовать бота.
1. Нажмите кнопку **Настройка бота**.
1. Щелкните три точки (&#x25cf;&#x25cf;&#x25cf;) на левой панели. Затем щелкните значок **App Studio**.
1. Выберите вкладку **Редактор манифеста**. Вы должны увидеть значок отправленного бота.
1. Кроме того, бот должен появиться в списке чатов в качестве контакта, который можно использовать для обмена сообщениями с ботом.

### <a name="testing-the-bot-locally-in-teams"></a>Локальное тестирование бота в Teams

Microsoft Teams является полностью облачным продуктом. Для него требуется, чтобы все используемые службы были доступны из облака с помощью конечных точек HTTPS. Таким образом, чтобы бот (наш пример) работал в Teams, необходимо либо опубликовать код в выбранном вами облаке, либо сделать локально работающий экземпляр доступным из внешней среды через средство **туннелирования**. Рекомендуется использовать средство [ngrok](https://ngrok.com/download), которое создает доступный из внешней среды URL-адрес для порта, который вы открываете локально на компьютере.
Чтобы настроить ngrok при подготовке к локальному запуску вашего приложения Microsoft Teams, выполните следующие действия.

1. В окне терминала перейдите в каталог, в котором установлен `ngrok.exe`. Рекомендуется настроить путь к *переменной среды*, чтобы указать на него.
1. Например, запустите `ngrok http 3978 --host-header=localhost:3978`. При необходимости замените номер порта.
При этом запускается ngrok для прослушивания порта, который вы указали. В ответ он предоставляет доступный из внешней среды URL-адрес, действительный до тех пор, пока запущен ngrok. Указанное ниже изображение является примером.

    ![adv1 строки подключения для проверки подлинности приложения бота Teams](../../../assets/images/authentication/auth-bot-ngrok-start.PNG).

1. Скопируйте HTTPS-адрес переадресации. Он должен выглядеть примерно так: `https://dea822bf.ngrok.io/`.
1. Добавьте `/api/messages` для получения `https://dea822bf.ngrok.io/api/messages`. Это **конечная точка сообщений** для бота, запущенного локально на вашем компьютере и доступного через Интернет в чате Microsoft Teams.
1. Последним шагом является обновление конечной точки сообщений развернутого бота. В этом примере мы развернули бот в Azure. Давайте выполним следующие действия.
    1. В браузере перейдите на [**портал Azure**][azure-portal].
    1. Выберите **Регистрация бота**.
    1. На левой панели выберите **Параметры**.
    1. На правой панели в поле **Конечная точка обмена сообщениями** введите URL-адрес ngrok (в нашем примере: `https://dea822bf.ngrok.io/api/messages`).
1. Запустите бот локально, например в режиме отладки Visual Studio.
1. Протестируйте бот при локальной работе с помощью **тестового веб-чата** на портале Bot Framework. Как и Emulator, этот тест не позволяет получить доступ к функциям Teams.
1. В окне терминала, где запущен `ngrok`, вы можете увидеть HTTP-трафик между ботом и клиентом веб-чата. Если требуется более подробное представление, в окне браузера введите значение `http://127.0.0.1:4040`, полученное из предыдущего окна терминала. Указанное ниже изображение является примером.

    ![тестирование ngrok для бота проверки подлинности Teams](../../../assets/images/authentication/auth-bot-teams-ngrok-testing.png).

> [!NOTE]
> Если остановить и перезапустить ngrok, URL-адрес изменится. Чтобы использовать ngrok в проекте и в зависимости от используемых возможностей, необходимо обновить все ссылки на URL-адрес.

## <a name="additional-information"></a>Дополнительные сведения

### <a name="teamsappmanifestmanifestjson"></a>TeamsAppManifest/manifest.json

Этот манифест содержит сведения, необходимые Microsoft Teams для подключения к боту:  

```json
{
  "$schema": "https://developer.microsoft.com/json-schemas/teams/v1.8/MicrosoftTeams.schema.json",
  "manifestVersion": "1.5",
  "version": "1.0.0",
  "id": "",
  "packageName": "com.teams.auth.bot",
  "developer": {
    "name": "TeamsBotAuth",
    "websiteUrl": "https://www.microsoft.com",
    "privacyUrl": "https://www.teams.com/privacy",
    "termsOfUseUrl": "https://www.teams.com/termsofuse"
  },
  "icons": {
    "color": "color.png",
    "outline": "outline.png"
  },
  "name": {
    "short": "TeamsBotAuth",
    "full": "Teams Bot Authentication"
  },
  "description": {
    "short": "TeamsBotAuth",
    "full": "Teams Bot Authentication"
  },
  "accentColor": "#FFFFFF",
  "bots": [
    {
      "botId": "",
      "scopes": [
        "groupchat",
        "team"
      ],
      "supportsFiles": false,
      "isNotificationOnly": false
    }
  ],
  "permissions": [
    "identity",
    "messageTeamMembers"
  ],
  "validDomains": [ "token.botframework.com" ]
}
```

При проверке подлинности Teams ведет себя немного иначе, чем в других каналах, как описано ниже.

### <a name="handling-invoke-activity"></a>Обработка действия вызова

Боту отправляется **действие вызова**, а не действие события, используемое другими каналами.
Это осуществляется с помощью вложенного класса **ActivityHandler**.

# <a name="cnet"></a>[C#/.NET](#tab/dotnet-sample)

**Bots/DialogBot.cs**

[!code-csharp[ActivityHandler](~/../botbuilder-samples/samples/csharp_dotnetcore/46.teams-auth/Bots/DialogBot.cs?range=19-51)]

**Bots/TeamsBot.cs**

*Действие вызова* должно перенаправляться в диалоговое окно, если используется **OAuthPrompt**.

[!code-csharp[ActivityHandler](~/../botbuilder-samples/samples/csharp_dotnetcore/46.teams-auth/Bots/TeamsBot.cs?range=34-42)]

#### <a name="teamsactivityhandlercs"></a>TeamsActivityHandler.cs

```csharp

protected virtual Task OnInvokeActivityAsync(ITurnContext<IInvokeActivity> turnContext, CancellationToken cancellationToken)
{
    switch (turnContext.Activity.Name)
    {
        case "signin/verifyState":
            return OnSigninVerifyStateAsync(turnContext, cancellationToken);

        default:
            return Task.CompletedTask;
    }
}

protected virtual Task OnSigninVerifyStateAsync(ITurnContext<IInvokeActivity> turnContext, CancellationToken cancellationToken)
{
    return Task.CompletedTask;
}
```

# <a name="javascript"></a>[JavaScript](#tab/node-js-dialog-sample)

**bots/dialogBot.js**

[!code-javascript[ActivityHandler](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/bots/dialogBot.js?range=4-46)]

**bots/teamsBot.js**

*Действие вызова* должно перенаправляться в диалоговое окно, если используется **OAuthPrompt**.

[!code-javascript[ActivityHandler](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/bots/teamsBot.js?range=4-33)]

**dialogs/mainDialog.js**

На шаге диалогового окна используйте `beginDialog`, чтобы запустить запрос OAuth, который предлагает пользователю выполнить вход.

- Если пользователь уже выполнил вход, это приведет к возникновению события отклика маркера без обращения к пользователю.
- В противном случае пользователю будет предложено выполнить вход. Служба Azure Bot отправляет событие отклика маркера после попытки пользователя выполнить вход.

[!code-javascript[AddOAuthPrompt](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/dialogs/mainDialog.js?range=50-52)]

На следующем шаге диалогового окна проверьте наличие маркера в результате из предыдущего шага. Если значение не равно NULL, пользователь успешно выполнил вход.

[!code-javascript[AddOAuthPrompt](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/dialogs/mainDialog.js?range=50-64)]

**bots/logoutDialog.js**

[!code-javascript[allow-logout](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/dialogs/logoutDialog.js?range=31-42&highlight=7)]

# <a name="python"></a>[Python](#tab/python-sample)

**bots/dialog_bot.py**

[!code-python[ActivityHandler](~/../botbuilder-samples/samples/python/46.teams-auth/bots/dialog_bot.py?range=10-42)]

**bots/teams_bot.py**

*Действие вызова* должно перенаправляться в диалоговое окно, если используется **OAuthPrompt**.

[!code-python[on_token_response_event](~/../botbuilder-samples/samples/python/46.teams-auth/bots/teams_bot.py?range=38-45)]

**dialogs/main_dialog.py**

На шаге диалогового окна используйте `begin_dialog`, чтобы запустить запрос OAuth, который предлагает пользователю выполнить вход.

- Если пользователь уже выполнил вход, это приведет к возникновению события отклика маркера без обращения к пользователю.
- В противном случае пользователю будет предложено выполнить вход. Служба Azure Bot отправляет событие отклика маркера после попытки пользователя выполнить вход.

[!code-python[Add OAuthPrompt](~/../botbuilder-samples/samples/python/46.teams-auth/dialogs/main_dialog.py?range=48-49)]

На следующем шаге диалогового окна проверьте наличие маркера в результате из предыдущего шага. Если значение не равно NULL, пользователь успешно выполнил вход.

[!code-python[Add OAuthPrompt](~/../botbuilder-samples/samples/python/46.teams-auth/dialogs/main_dialog.py?range=51-61)]

**dialogs/logout_dialog.py**

[!code-python[allow logout](~/../botbuilder-samples/samples/python/46.teams-auth/dialogs/logout_dialog.py?range=29-36&highlight=6)]

---

## <a name="code-sample"></a>Пример кода

В этом разделе приведен пример пакета SDK для проверки подлинности бота версии 3.

| **Название примера** | **Описание** | **.NET** | **Node.js** | **Python** |
|---------------|------------|------------|-------------|---------------|
| Проверка подлинности бота | В этом примере показано, как начать работу с проверкой подлинности в боте для Microsoft Teams. | [View](https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/csharp_dotnetcore/46.teams-auth) | [Просмотр](https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/javascript_nodejs/46.teams-auth) | [View](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python/46.teams-auth) |
| Вкладка, бот и расширение сообщений (ME) SSO | В этом примере показана система единого входа для Tab, Bot и ME — поиск, действие, linkunfurl. |  [View](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-sso/csharp) | [View](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-sso/nodejs) | Недоступно |

## <a name="see-also"></a>Дополнительные ресурсы

[Добавление проверки подлинности с помощью Службы Azure Bot](https://aka.ms/azure-bot-add-authentication)

<!-- Footnote-style links -->

[azure-portal]: https://ms.portal.azure.com

[concept-basics]: /azure/bot-service/bot-builder-basics?view=azure-bot-service-4.0&preserve-view=true
[concept-state]: /azure/bot-service/bot-builder-concept-state?view=azure-bot-service-4.0&preserve-view=true
[concept-dialogs]: /azure/bot-service/bot-builder-concept-dialog?view=azure-bot-service-4.0&preserve-view=true
[simple-dialog]: /azure/bot-service/bot-builder-dialog-manage-conversation-flow?view=azure-bot-service-4.0&preserve-view=true

[teams-auth-bot-cs]: https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/csharp_dotnetcore/46.teams-auth

[teams-auth-bot-py]: https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/python/46.teams-auth

[teams-auth-bot-js]: https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/javascript_nodejs/46.teams-auth

[azure-aad-blade]: https://ms.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview
[aad-registration-blade]: https://ms.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredAppsPreview
