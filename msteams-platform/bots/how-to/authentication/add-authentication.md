---
title: Добавить аутентификацию к вашему Teams боту
author: clearab
description: Как добавить аутентификацию OAuth к боту в Microsoft Teams.
ms.topic: how-to
localization_priority: Normal
ms.author: lajanuar
ms.openlocfilehash: 36cb6f3de6f97af1d01512175923b79f69f630ad
ms.sourcegitcommit: 51e4a1464ea58c254ad6bd0317aca03ebf6bf1f6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2021
ms.locfileid: "52566006"
---
# <a name="add-authentication-to-your-teams-bot"></a>Добавить аутентификацию к вашему Teams боту

Есть моменты, когда вам может понадобиться создать ботов в Microsoft Teams которые могут получить доступ к ресурсам от имени пользователя, таких как почтовая служба.

Эта статья демонстрирует, как использовать Azure Bot Service v4 SDK аутентификации, на основе OAuth 2.0. Это упрощает разработку бота, который может использовать токены аутентификации на основе учетных данных пользователя. Ключевым во всем этом является использование идентификации **поставщиков,** как мы увидим позже.

OAuth 2.0 — это открытый стандарт проверки подлинности и авторизации, используемый Azure Active Directory (Azure AD) и многими другими поставщиками удостоверений. Базовое понимание OAuth 2.0 является необходимым условием для работы с аутентификацией в Teams.

Смотрите [OAuth 2 Упрощенный для](https://aka.ms/oauth2-simplified) базового понимания, и [OAuth 2.0 для](https://oauth.net/2/) полной спецификации.

Для получения дополнительной информации о том, как служба Azure Bot обрабатывает аутентификацию, [см.](https://aka.ms/azure-bot-authentication)

В данной статье вы узнаете следующее.

- **Как создать бот с поддержкой аутентификации.** Вы будете использовать [cs-auth-образец для][teams-auth-bot-cs] обработки учетных данных входа пользователя и генерации маркера аутентификации.
- **Как развернуть бота в Azure и связать его с поставщиком идентификационных данных.** Поставщик выдает токен на основе учетных данных входа пользователя. Бот может использовать токен для доступа к ресурсам, таким как почтовая служба, которые требуют проверки подлинности. Для получения дополнительной информации [Microsoft Teams потока аутентификации для ботов.](auth-flow-bot.md)
- **Как интегрировать бота в Microsoft Teams.** После интеграции бота можно войти в систему и обменяться с ним сообщениями в чате.

## <a name="prerequisites"></a>Предварительные требования

- Знание основ [бота,][concept-basics] [управление состоянием,][concept-state] [библиотека диалогов,][concept-dialogs]и [как реализовать последовательный поток разговоров.][simple-dialog]
- Знание разработки Azure и OAuth 2.0.
- Текущие версии Visual Studio Git.
- Учетная запись Azure. При необходимости можно создать бесплатную [учетную запись Azure.](https://azure.microsoft.com/free/)
- Следующий пример:

    | Пример | Версия Для Ботбилдер | Показано |
    |:---|:---:|:---|
    | **Бот аутентификации** [в cs-auth-образец][teams-auth-bot-cs] | v4 | Поддержка OAuthCard |
    | **Бот аутентификации** [в js-auth-образец][teams-auth-bot-js] | v4| Поддержка OAuthCard  |
    | **Бот аутентификации** [в py-auth-образец][teams-auth-bot-py] | v4 | Поддержка OAuthCard |

## <a name="create-the-resource-group"></a>Создание группы ресурсов

Группа ресурсов и план обслуживания не являются строго необходимыми, но они позволяют удобно выпускать ресурсы, которые вы создаете. Это хорошая практика для поддержания ваших ресурсов организованы и управляемым.

Вы используете группу ресурсов для создания отдельных ресурсов для Bot Framework. Для обеспечения производительности убедитесь, что эти ресурсы расположены в том же регионе Azure.

1. В браузере вопишитесь на [**портал Azure.**][azure-portal]
1. В левой навигационной панели выберите **группы ресурсов.**
1. В левом верхнем левом верхнем левом от отображаемого окна выберите **вкладку Добавить** для создания новой группы ресурсов. Вам будет предложено предоставить следующее:
    1. **Подписка**. Используйте существующую подписку.
    1. **Ресурсная группа**. Введите название группы ресурсов. Примером может быть  *TeamsResourceGroup*. Помните, что имя должно быть уникальным.
    1. Из **меню «Регион»** выберите *Западный США или* регион, близкий к вашим приложениям.
    1. Выберите **обзор и создайте кнопку.** Вы должны увидеть баннер, который читает *Проверка прошла*.
    1. Выберите **кнопку** «Создать». Создание группы ресурсов может занять несколько минут.

> [!TIP]
> Как и в случае с ресурсами, которые вы создадите позже в этом учебнике, это хорошая идея, чтобы приколоть эту группу ресурсов к панели мониторинга для легкого доступа. Если вы хотите сделать это, выберите значок контактный &#128204; в правом верхнем правом верхнем справа от приборной панели.

## <a name="create-the-service-plan"></a>Создание плана обслуживания

1. На портале [**Azure,**][azure-portal]на левой навигационной панели, **выберите Создать ресурс.**
1. В поле поиска ввет *план обслуживания приложений.* Выберите **карту Плана обслуживания** приложений из результатов поиска.
1. Выберите пункт **Создать**.
1. Вам будет предложено предоставить следующую информацию:
    1. **Подписка**. Можно использовать существующую подписку.
    1. **Ресурсная группа**. Выберите группу, которую вы создали ранее.
    1. **Имя**. Введите название плана обслуживания. Примером может быть  *TeamsServicePlan*. Помните, что название должно быть уникальным, в группе.
    1. **Операционная система**. Выберите *Windows* или применимую ОС.
    1. **Регион**. Выберите *Западную США* или регион, близкий к вашим приложениям.
    1. **Уровень ценообразования**. Убедитесь, *что выбран стандартный S1.* Это должно быть значение по умолчанию.
    1. Выберите **обзор и создайте кнопку.** Вы должны увидеть баннер, который читает *Проверка прошла*.
    1. Выберите пункт **Создать**. Создание плана обслуживания приложений может занять несколько минут. План будет указан в ресурсной группе.

## <a name="create-the-bot-channels-registration"></a>Создание регистрации бот-каналов

Регистрация бот-каналов регистрирует ваш веб-сервис в качестве бота с Bot Framework, при условии, что у вас есть пароль Microsoft App Id и App (секрет клиента).

> [!IMPORTANT]
> Вам нужно зарегистрировать бота только в том случае, если он не размещен в Azure. Если [вы создали бота](/azure/bot-service/abs-quickstart?view=azure-bot-service-4.0&viewFallbackFrom=azure-bot-service-3.0&preserve-view=true) через портал Azure, то он уже зарегистрирован в службе. Если вы создали бота [через Bot Framework](https://dev.botframework.com/bots/new) или [AppStudio,](~/concepts/build-and-test/app-studio-overview.md) ваш бот не зарегистрирован в Azure.

[!INCLUDE [bot channels registration steps](~/includes/bots/azure-bot-channels-registration.md)]

> [!NOTE]
> Ресурс регистрации Бот-каналов покажет Глобальный **регион,** даже если вы выбрали Западную США. Это ожидается.

Для получения дополнительной информации [с Teams м.](../create-a-bot-for-teams.md)

## <a name="create-the-identity-provider"></a>Создание поставщика идентификационных данных

Вам нужен поставщик идентификационных данных, который может быть использован для проверки подлинности.
В этой процедуре вы будете использовать поставщика AD Azure; могут также использоваться другие поддерживаемые Azure AD поставщики идентификаций.

1. На портале [**Azure,**][azure-portal]на левой навигационной панели, **выберите Azure Active Directory.**
    > [!TIP]
    > Вам нужно будет создать и зарегистрировать этот ресурс Azure AD в арендаторе, в котором вы можете дать согласие на делегирование разрешений, запрошенных приложением.
    > Для получения инструкций по созданию [арендатора, см. Доступ к порталу и создать арендатора](/azure/active-directory/fundamentals/active-directory-access-create-new-tenant).
1. В левой панели выберите **регистрацию приложений.**
1. В правой панели выберите **новую регистрационную** вкладку в левом верхнем направлении.
1. Вам будет предложено предоставить следующую информацию:
   1. **Имя**. Введите название приложения. Примером может быть  *BotTeamsIdentity*. Помните, что имя должно быть уникальным.
   1. Выберите **типы поддерживаемых счетов** для приложения. Выберите *учетные записи в любом организационном каталоге (Любой каталог Azure AD - Multitenant) и личные учетные записи Майкрософт (например, Skype, Xbox).*
   1. Для **перенаправления URI**:<br/>
       &#x2713;Выберите **веб**. <br/>
       &#x2713; Установите `https://token.botframework.com/.auth/web/redirect` URL-
   1. Нажмите **Зарегистрировать**.

1. После его создания Azure отображает страницу **Обзора** для приложения. Копировать и сохранить следующую информацию в файл:

    1. **Идентификационное значение приложения (клиента).** Вы будете использовать это значение позже в качестве *идентификатора клиента* при регистрации этого приложения идентификации Azure с вашим ботом.
    1. Значение **идентификатора каталога (арендатора).** Вы также будете использовать это значение позже в качестве *идентификатора арендатора для* регистрации этого приложения идентификации Azure с вашим ботом.

1. В левой панели **выберите сертификаты & секреты** для создания клиентской тайны для вашего приложения.

   1. Под **секретами** клиента, выберите &#x2795; **секрет нового клиента.**
   1. Добавьте описание, чтобы идентифицировать этот секрет от других, которые вам могут понадобиться создать для этого приложения, *такие как приложение идентификации Bot в Teams.*
   1. Срок **действия набора** истекает в выборе.
   1. Нажмите **Добавить**.
   1. Перед тем, как покинуть эту **страницу, завехать секрет**. Вы будете использовать это значение позже в _качестве секрета Клиента_ при регистрации приложения Azure AD с вашим ботом.

### <a name="configure-the-identity-provider-connection-and-register-it-with-the-bot"></a>Настройте соединение поставщика идентификационных данных и зарегистрируйте его у бота

Примечание-Есть два варианта для поставщиков услуг здесь-Azure AD V1 и Azure AD V2.  Различия между двумя поставщиками суммируются здесь, [но](/azure/active-directory/azuread-dev/azure-ad-endpoint-comparison)в целом, V2 обеспечивает большую гибкость в отношении изменения разрешений бота.  Graph Разрешения API перечислены в поле областей, и по мере добавления новых боты позволят пользователям соглашаться на новые разрешения при следующем вписав в систему.  Для V1 согласие бота должно быть удалено пользователем для получения новых разрешений в диалоге OAuth. 

#### <a name="azure-ad-v1"></a>Лазурный АД V1

1. На портале [**Azure выберите**][azure-portal]группу ресурсов из панели мониторинга.
1. Выберите ссылку на регистрацию бот-канала.
1. Откройте страницу ресурса и выберите **конфигурацию** под **Параметры**. 
1. Выберите **Добавить OAuth Соединение Параметры**.    
Следующее изображение отображает соответствующий выбор на странице ресурса:  
![Конфигурация SampleAppDemoBot](~/assets/images/authentication/sample-app-demo-bot-configuration.png)
1. Заполните форму следующим образом:

    1. **Имя**. Введите имя для соединения. Вы будете использовать это имя в вашем боте в `appsettings.json` файле. Например *BotTeamsAuthADv1*.
    1. **Поставщик услуг**. Выберите **Azure Active Directory**. После выбора этого поля Azure AD будут отображаться.
    1. **Идентификатор клиента**. Введите идентификатор приложения (клиента), который вы записали для приложения поставщика идентификационных данных Azure в вышеуказанных шагах.
    1. **Секрет клиента**. Введите секрет, записанный для приложения поставщика идентификационных данных Azure, в вышеуказанных шагах.
    1. **Тип гранта**. Введите `authorization_code` .
    1. **URL-адрес входа**. Введите `https://login.microsoftonline.com` .
    1. **Идентификатор арендатора,** введите **идентификатор каталога (арендатора), который вы записали** ранее для приложения для идентификации Azure или общее в зависимости от поддерживаемого типа учетной записи, выбранного при создания приложения поставщика идентификационных данных.  Чтобы решить, какое значение назначить следовать этим критериям:

        - Если вы выбрали либо *учетные записи в этом организационном каталоге (только Microsoft - Единый арендатор),* либо учетные записи в любом *организационном каталоге (каталог Microsoft AAD - Multi tenant) введите* **идентификатор арендатора, который** вы записали ранее для приложения AAD. Это будет арендатор, связанный с пользователями, которые могут быть проверены.

        - Если вы выбрали *Учетные записи в любом организационном каталоге (Любой каталог AAD - Multi tenant и личные учетные записи Майкрософт, например, Skype, Xbox, Outlook) введите слово,* **распространенное** вместо идентификатора арендатора. В противном случае приложение AAD проверит через арендатора, чей идентификатор был выбран, и исключит личные учетные записи Майкрософт.

    з. Для **ресурса URL**, введите `https://graph.microsoft.com/` . Это не используется в текущем образце кода.  
    и. Оставьте **области пустыми.** Примером может быть следующее изображение:

    ![команды ботов приложение Auth соединение строки adv1 зрения](../../../assets/images/authentication/auth-bot-identity-connection-adv1.png)

1. Нажмите **Сохранить**.

#### <a name="azure-ad-v2"></a>Лазурный АД V2

1. На портале [**Azure выберите**][azure-portal]группу ресурсов из панели мониторинга.
1. Выберите ссылку на регистрацию бот-канала.
1. Откройте страницу ресурса и выберите **конфигурацию** под **Параметры**. 
1. Выберите **Добавить OAuth Соединение Параметры**.  
Следующее изображение отображает соответствующий выбор на странице ресурса:        
![Конфигурация SampleAppdemoBot](~/assets/images/authentication/sample-app-demo-bot-configuration.png) 

1. Заполните форму следующим образом:

    1. **Имя**. Введите имя для соединения. Вы будете использовать это имя в вашем боте в `appsettings.json` файле. Например *BotTeamsAuthADv2*.
    1. **Поставщик услуг**. Выберите **Azure Active Directory v2**. После выбора этого поля Azure AD будут отображаться.
    1. **Идентификатор клиента**. Введите идентификатор приложения (клиента), который вы записали для приложения поставщика идентификационных данных Azure в вышеуказанных шагах.
    1. **Секрет клиента**. Введите секрет, записанный для приложения поставщика идентификационных данных Azure, в вышеуказанных шагах.
    1. **URL Exchange токенов.** Оставьте это пустым.
    1. **Идентификатор арендатора,** введите **идентификатор каталога (арендатора), который вы записали** ранее для приложения для идентификации Azure или общее в зависимости от поддерживаемого типа учетной записи, выбранного при создания приложения поставщика идентификационных данных.  Чтобы решить, какое значение назначить следовать этим критериям:

        - Если вы выбрали либо *учетные записи в этом организационном каталоге (только Microsoft - Единый арендатор),* либо учетные записи в любом *организационном каталоге (каталог Microsoft AAD - Multi tenant) введите* **идентификатор арендатора, который** вы записали ранее для приложения AAD. Это будет арендатор, связанный с пользователями, которые могут быть проверены.

        - Если вы выбрали *Учетные записи в любом организационном каталоге (Любой каталог AAD - Multi tenant и личные учетные записи Майкрософт, например, Skype, Xbox, Outlook) введите слово,* **распространенное** вместо идентификатора арендатора. В противном случае приложение AAD проверит через арендатора, чей идентификатор был выбран, и исключит личные учетные записи Майкрософт.

    1. Для **сферы**, введите пространство-делимитирован список разрешений графика это приложение требует, например: User.Read User.ReadBasic.All Mail.Read 

1. Нажмите **Сохранить**.

### <a name="test-the-connection"></a>Проверить соединение

1. Выберите вход соединения, чтобы открыть только что созданное соединение.
1. Выберите **тестовое** соединение в верхней части **панели настройки подключения поставщика** услуг.
1. При первом же открытии нового окна браузера вам будет отбирать учетную запись. Выберите тот, который вы хотите использовать.
1. Далее вас попросят разрешить поставщику идентификационных данных использовать ваши данные (учетные данные). Примером может быть следующее изображение:

    ![команды бота auth соединение строки adv1](../../../assets/images/authentication/auth-bot-connection-test-accept.PNG)

1. Выберите **Принять**.
1. Это должно перенаправить вас на **тестовое соединение на \<your-connection-name> страницу Успешно.** Обновите страницу, если вы получили ошибку. Примером может быть следующее изображение:

    ![команды ботов приложение Auth соединение str adv1](../../../assets/images/authentication/auth-bot-connection-test-token.PNG)

Имя соединения используется кодом бота для получения токенов проверки подлинности пользователя.

## <a name="prepare-the-bot-sample-code"></a>Подготовка кода образца бота

С предварительными настройками, давайте сосредоточимся на создании бота для использования в этой статье.

# <a name="cnet"></a>[C#/.NET](#tab/dotnet)

1. Клон [cs-auth-образец][teams-auth-bot-cs].
1. Запуск Visual Studio.
1. Из панели инструментов **выберите Файл -> Open -> Project/Solution** и откройте проект бота.
1. В обновлении **appsettings.jsна следующее:**

    - Установите `ConnectionName` на имя поставщика идентификационных данных соединение, добавленное к регистрации канала бота. Имя, которое мы использовали в этом *примере BotTeamsAuthADv1*.
    - Установите `MicrosoftAppId` на бот App ID **вы** сохранили во время регистрации канала бота.
    - Установите `MicrosoftAppPassword` в секрет клиента **вы** сохранили во время регистрации канала бота.

    В зависимости от символов в вашем бот секрет, вам может понадобиться XML избежать пароля. Например, любые амперсандры (&) должны быть закодированы как `&amp;` .

     [!code-json[appsettings](~/../botbuilder-samples/samples/csharp_dotnetcore/46.teams-auth/appsettings.json?range=1-5)]

1. В Solution Explorer перейдите к папке, откройте и установите и на `TeamsAppManifest` идентификатор приложения `manifest.json` `id` `botId` **бота, сохраненный** во время регистрации канала бота.

# <a name="javascript"></a>[JavaScript](#tab/node-js)

1. Узел [клонов-образец][teams-auth-bot-js].
1. В консоли перейдите к проекту: </br></br>
`cd samples/javascript_nodejs/46.teams`  
1. Установка модулей</br></br>
`npm install`
1. Обновление **конфигурации .env** следующим образом:

    - Установите `MicrosoftAppId` на бот App ID **вы** сохранили во время регистрации канала бота.
    - Установите `MicrosoftAppPassword` в секрет клиента **вы** сохранили во время регистрации канала бота.
    - Установите `connectionName` имя соединения поставщика идентификационных данных.
    В зависимости от символов в вашем бот секрет, вам может понадобиться XML избежать пароля. Например, любые амперсандры (&) должны быть закодированы как `&amp;` .

     [!code-javascript[settings](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/.env)]

1. В `teamsAppManifest` папке откройте и `manifest.json` установите `id`  на идентификатор Microsoft App ID **и** на идентификатор `botId` приложения **бота, сохраненный** во время регистрации канала бота.

# <a name="python"></a>[Python](#tab/python)

1. Клон [py-auth-образец][teams-auth-bot-py] из репозитория github.
1. Обновление **config.py**:

    - Установите `ConnectionName` имя настройки соединения OAuth, которую вы добавили в бот.
    - Установите `MicrosoftAppId` и на идентификатор приложения вашего `MicrosoftAppPassword` бота и приложение секрет.

      В зависимости от символов в вашем бот секрет, вам может понадобиться XML избежать пароля. Например, любые амперсандры (&) должны быть закодированы как `&amp;` .

      [!code-python[config](~/../botbuilder-samples/samples/python/46.teams-auth/config.py?range=14-16)]

---

### <a name="deploy-the-bot-to-azure"></a>Развертывание бота в Azure

Чтобы развернуть бота, следуйте шагам в том, как [развернуть бота в Azure.](https://aka.ms/azure-bot-deployment-cli)

Кроме того, в то Visual Studio, вы можете следовать этим шагам:

1. В Visual Studio *Solution Explorer выберите* и удерживайте (или нажмите правой кнопкой мыши) название проекта.
1. В меню высадки выберите **Publish**.
1. В отображаемом окне выберите **новую ссылку.**
1. В окне диалога выберите **Службу приложений** слева и **создайте новую** справа.
1. Выберите **кнопку Публикация.**
1. В следующем окне диалога введите необходимую информацию. Ниже приведен пример.

    ![auth-app-сервис](../../../assets/images/authentication/auth-bot-app-service.png)

1. Выберите пункт **Создать**.
1. Если развертывание завершается успешно, вы должны увидеть его отражение в Visual Studio. Кроме того, страница отображается в вашем браузере по умолчанию *говорят ваш бот готов!*. URL будет похож на это: `https://botteamsauth.azurewebsites.net/` . Сохраните его в файле.
1. В браузере перейдите на [**портал Azure.**][azure-portal]
1. Проверьте свою группу ресурсов, бот должен быть указан вместе с другими ресурсами. Примером может быть следующее изображение:

    ![команды-бот-аут-приложение-сервис-группа](../../../assets/images/authentication/auth-bot-app-service-in-group.png)

1. В группе ресурсов выберите имя регистрации бот-канала (ссылка).
1. В левой панели выберите **Параметры.**
1. В поле **конечной точки обмена** сообщениями введите URL, полученный выше, а затем `api/messages` . Вот пример: `https://botteamsauth.azurewebsites.net/api/messages` .
1. Выберите **кнопку** Сохранения в левом верхнем этаже.

## <a name="test-the-bot-using-the-emulator"></a>Проверьте бота с помощью эмулятора

Если вы еще не сделали это, установите [Microsoft Bot Framework Emulator](https://aka.ms/bot-framework-emulator-readme). Смотрите также [отладка с эмулятором](https://aka.ms/bot-framework-emulator-debug-with-emulator).

Для того, чтобы логин образца бота работал, необходимо настроить эмулятор.

### <a name="configure-the-emulator-for-authentication"></a>Настройка эмулятора для проверки подлинности

Если бот требует аутентификации, необходимо настроить эмулятор. Настройка:

1. Запустите эмулятор.
1. В эмуляторе выберите значок шестерни, &#9881; в левом нижнем углу, **или Параметры** вкладку в правом верхнем углу.
1. Проверьте поле с **помощью токенов аутентификации версии 1.0.**
1. Введите локальный путь **к инструменту ngrok.** *Смотрите* Bot Framework Emulator / ngrok туннелирования интеграции [Вики](https://github.com/Microsoft/BotFramework-Emulator/wiki/Tunneling-(ngrok)). Для получения дополнительной информации об инструменте [см.](https://ngrok.com/)
1. Проверьте поле **Run ngrok, когда эмулятор запускается.**
1. Выберите **кнопку Сохранения.**

Когда бот отображает карту в системе регистрации и пользователь выбирает кнопку ва-во, эмулятор открывает страницу, которую пользователь может использовать для регистрации в системе аутентификации.
Как только пользователь делает это, провайдер генерирует токен пользователя и отправляет его боту. После этого бот может действовать от имени пользователя.

### <a name="test-the-bot-locally"></a>Проверьте бота локально

После настройки механизма проверки подлинности можно выполнить тестирование бота.  

1. Запустите образец бота локально на вашей машине, Visual Studio например.
1. Запустите эмулятор.
1. Выберите **кнопку Открытый** бот.
1. В **URL-адрес Bot** введите локальный URL бота. Как правило, `http://localhost:3978/api/messages` .
1. В **идентификатор приложения Microsoft введите** идентификатор приложения бота с `appsettings.json` .
1. В **пароле Microsoft App** введите пароль приложения бота из `appsettings.json` .
1. Выберите **Подключение**.
1. После того, как бот запущен и запущен, введите любой текст для отображения карты входа.
1. Выберите **кнопку «Войти** в кнопку».
1. Всплывающий диалог отображается для подтверждения **открытого URL.** Это необходимо для проверки подлинности пользователя бота (вас).  
1. Выберите **Подтвердить**.
1. Если вас попросят, выберите учетную запись пользователя.
1. В зависимости от конфигурации, используемой для эмулятора, вы получаете одно из следующих:
    1. **Использование кода проверки ва-ге**  
      &#x2713; открывается окно, отображая код проверки.  
      &#x2713; Copy и введите код проверки в чат-бокс для завершения входа.
    1. **Использование токенов аутентификации**.  
      &#x2713;, что вы вошли в систему на основе ваших учетных данных.

    Следующее изображение является примером пользовательского интерфейса бота после вошли в систему:

    ![Аут бот логин эмулятор](../../../assets/images/authentication/auth-bot-login-emulator.PNG)

1. Если вы **выберете** Да, когда *бот спросит Вы хотите просмотреть ваш токен?,* Вы получите ответ, похожий на следующий:

    ![auth бот войти эмулятор маркер](../../../assets/images/authentication/auth-bot-login-emulator-token.png)

1. **Введите logout** в поле входного чата, чтобы выйти. Это освобождает токен пользователя, и бот не сможет действовать от вашего имени, пока вы не войнете снова.

> [!NOTE]
> Бот аутентификации требует использования **Bot Connector службы**. Сервис получает доступ к информации о регистрации бот-каналов для вашего бота.

## <a name="test-the-deployed-bot"></a>Проверьте развернутого бота

<!--There are several testing scenarios here. Ideally, we'd have a separate article on the what, why, 
and when for these, and just reference that from here, along with the set of steps that exercises the bot code.-->

1. В браузере перейдите на [**портал Azure.**][azure-portal]
1. Найдите свою ресурсную группу.
1. Выберите ссылку на ресурс. Отображается страница ресурса.
1. На странице ресурса выберите тест **в веб-чате.** Бот запускает и отображает предопределенные приветствия.
1. Ввеми что-нибудь в чате.
1. Выберите **знак в коробке.**
1. Всплывающий диалог отображается для подтверждения **открытого URL.** Это необходимо для проверки подлинности пользователя бота (вас).  
1. Выберите **Подтвердить**.
1. Если вас попросят, выберите учетную запись пользователя.
    Следующее изображение является примером пользовательского интерфейса бота после вошли в систему:

    ![auth бот логин развернуты](../../../assets/images/authentication/auth-bot-login-deployed.PNG).

1. Выберите **кнопку «Да»** для отображения маркера аутентификации. Примером может быть следующее изображение:

    ![auth бот логин развернутый маркер](../../../assets/images/authentication/auth-bot-login-deployed-token.PNG).

1. Введите logout, чтобы выйти.

    ![Аут бот развернуты logout](../../../assets/images/authentication/auth-bot-deployed-logout.PNG)

> [!NOTE]
> Если у вас возникли проблемы с войко-отношением, попробуйте проверить соединение снова, как описано в предыдущих шагах. Это может воссоздать маркер аутентификации.
> С клиентом Бот Рамочного веб-чата в Azure возможно, потребуется войти в систему несколько раз, прежде чем проверка подлинности будет установлена правильно.

## <a name="install-and-test-the-bot-in-teams"></a>Установка и тестирование бота в Teams

1. В вашем проекте бота убедитесь, что `TeamsAppManifest` папка содержит `manifest.json` вместе с `outline.png` файлами и `color.png` файлами.
1. В Solution Explorer перейдите к `TeamsAppManifest` папке. `manifest.json`Редактировать, назначая следующие значения:
    1. Убедитесь, **что бот App ID** вы получили во время регистрации канала бот назначен и `id` `botId` .
    1. Присвоить это значение: `validDomains: [ "token.botframework.com" ]` .
1. Выберите  и застегнуть `manifest.json` , и `outline.png` `color.png` файлы.
1. Открытый **Microsoft Teams**.
1. В левой панели, внизу, выберите **значок Apps.**
1. В правой панели, в нижней части, **выберите Upload пользовательского приложения**.
1. Перейдите в `TeamsAppManifest` папку и загрузите манифест на молнии.
Отображается следующий мастер:

    ![auth бот команды загрузить](../../../assets/images/authentication/auth-bot-teams-upload.png)

1. Нажмите кнопку **Добавить в группу**.
1. В следующем окне выберите команду, в которой вы хотите использовать бота.
1. Выберите **кнопку Настройка бота.**
1. Выберите три точки (&#x25cf;&#x25cf;&#x25cf;) в левой панели. Затем выберите **значок App Studio.**
1. Выберите **вкладку редактора** Manifest. Вы должны увидеть значок для бота вы загрузили.
1. Кроме того, вы должны быть в состоянии видеть бота, перечисленных в качестве контакта в списке чата, который можно использовать для обмена сообщениями с ботом.

### <a name="testing-the-bot-locally-in-teams"></a>Тестирование бота локально в Teams

Microsoft Teams полностью облачный продукт, он требует, чтобы все службы, к ним по доступу, были доступны из облака с помощью конечных точек HTTPS. Таким образом, чтобы бот (наш образец) работал в Teams году, вам нужно либо опубликовать код в облаке по вашему выбору, либо сделать локально работающий экземпляр внешне доступным с **помощью инструмента туннелирования.** Мы рекомендуем  [ngrok](https://ngrok.com/download), который создает внешне адресный URL для порта, который вы открываете локально на вашей машине.
Чтобы настроить ngrok в рамках подготовки к запуску приложения Microsoft Teams локально, следуйте этим шагам:

1. В окне терминала зайдите в каталог, где вы `ngrok.exe` установили. Мы предлагаем установить переменный *путь среды,* чтобы указать на него.
1. Запуск, например, `ngrok http 3978 --host-header=localhost:3978` . По мере необходимости замените номер порта.
Это запускает ngrok слушать на порт вы указываете. В свою очередь, он дает вам внешне адресный URL, действительный до тех пор, как ngrok работает. Примером может быть следующее изображение:

    ![команды бот приложение Auth соединение строки adv1](../../../assets/images/authentication/auth-bot-ngrok-start.PNG).

1. Копировать адрес переокамителя HTTPS. Она должна быть похожа на следующее: `https://dea822bf.ngrok.io/` .
1. Приложение для `/api/messages` получения `https://dea822bf.ngrok.io/api/messages` . Это конечная **точка сообщения для бота,** работающих локально на вашей машине и достижимых через Интернет в чате в Microsoft Teams.
1. Одним из последних шагов для выполнения является обновление конечной точки сообщения развернутого бота. В этом примере мы развернули бота в Azure. Итак, давайте выполнить следующие шаги:
    1. В браузере перейдите на [**портал Azure.**][azure-portal]
    1. Выберите **регистрацию канала Bot**.
    1. В левой панели выберите **Параметры.**
    1. В правой панели, в **поле конечной точки** обмена сообщениями, введите URL ngrok, в нашем примере. `https://dea822bf.ngrok.io/api/messages`
1. Запустите бот локально, например, в Visual Studio отладки.
1. Проверьте бота во время локального запуска с помощью тестового **веб-чата портала Bot Framework.** Как и эмулятор, этот тест не позволяет получить доступ Teams конкретной функциональности.
1. В окне терминала, где `ngrok` работает вы можете увидеть трафик HTTP между ботом и клиентом веб-чата. Если вы хотите более подробное представление, в окно браузера введите `http://127.0.0.1:4040` вы получили из предыдущего окна терминала. Примером может быть следующее изображение:

    ![Аут бот команды ngrok тестирования](../../../assets/images/authentication/auth-bot-teams-ngrok-testing.png).

> [!NOTE]
> Если вы остановитесь и перезапустите ngrok, URL-адрес изменится. Чтобы использовать ngrok в проекте, и в зависимости от возможностей, которые вы используете, вы должны обновить все ссылки URL.
 

## <a name="additional-information"></a>Дополнительные сведения

### <a name="teamsappmanifestmanifestjson"></a>TeamsAppManifest/manifest.jsна

Этот манифест содержит информацию, необходимую Microsoft Teams, чтобы связаться с ботом:  

```json
{
  "$schema": "https://developer.microsoft.com/json-schemas/teams/v1.8/MicrosoftTeams.schema.json",
  "manifestVersion": "1.5",
  "version": "1.0.0",
  "id": "",
  "packageName": "com.teams.auth.bot",
  "developer": {
    "name": "TeamsBotAuth",
    "websiteUrl": "https://www.microsoft.com",
    "privacyUrl": "https://www.teams.com/privacy",
    "termsOfUseUrl": "https://www.teams.com/termsofuse"
  },
  "icons": {
    "color": "color.png",
    "outline": "outline.png"
  },
  "name": {
    "short": "TeamsBotAuth",
    "full": "Teams Bot Authentication"
  },
  "description": {
    "short": "TeamsBotAuth",
    "full": "Teams Bot Authentication"
  },
  "accentColor": "#FFFFFF",
  "bots": [
    {
      "botId": "",
      "scopes": [
        "groupchat",
        "team"
      ],
      "supportsFiles": false,
      "isNotificationOnly": false
    }
  ],
  "permissions": [
    "identity",
    "messageTeamMembers"
  ],
  "validDomains": [ "token.botframework.com" ]
}
```

При проверке подлинности Teams ведет себя несколько иначе, чем другие каналы, как поясняется ниже.

### <a name="handling-invoke-activity"></a>Обработка действия вызова

Действие **вызова отправляется** боту, а не активности событий, используемой другими каналами.
Это делается путем подкласси классов **ActivityHandler**.

# <a name="cnet"></a>[C#/.NET](#tab/dotnet-sample)

**Боты/ДиалогБот.cs**

[!code-csharp[ActivityHandler](~/../botbuilder-samples/samples/csharp_dotnetcore/46.teams-auth/Bots/DialogBot.cs?range=19-51)]

**Боты/TeamsBot.cs**

Действие *вызова должно* быть перенаправлено в диалог, **если используется OAuthPrompt.**

[!code-csharp[ActivityHandler](~/../botbuilder-samples/samples/csharp_dotnetcore/46.teams-auth/Bots/TeamsBot.cs?range=34-42)]

#### <a name="teamsactivityhandlercs"></a>TeamsActivityHandler.cs

```csharp

protected virtual Task OnInvokeActivityAsync(ITurnContext<IInvokeActivity> turnContext, CancellationToken cancellationToken)
{
    switch (turnContext.Activity.Name)
    {
        case "signin/verifyState":
            return OnSigninVerifyStateAsync(turnContext, cancellationToken);

        default:
            return Task.CompletedTask;
    }
}

protected virtual Task OnSigninVerifyStateAsync(ITurnContext<IInvokeActivity> turnContext, CancellationToken cancellationToken)
{
    return Task.CompletedTask;
}
```

# <a name="javascript"></a>[JavaScript](#tab/node-js-dialog-sample)

**боты/dialogBot.js**

[!code-javascript[ActivityHandler](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/bots/dialogBot.js?range=4-46)]

**боты/teamsBot.js**

Действие *вызова должно* быть перенаправлено в диалог, **если используется OAuthPrompt.**

[!code-javascript[ActivityHandler](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/bots/teamsBot.js?range=4-33)]

**диалоги/mainDialog.js**

В рамках шага диалога `beginDialog` используйте для запуска подсказки OAuth, которая просит пользователя войти в нее.

- Если пользователь уже венся, это приведет к созданию события отклика токенов, не вызывая пользователя.
- В противном случае это покажет пользователю войти в нее. Служба Azure Bot отправляет событие отклика токена после попытки пользователя войти в систему.

[!code-javascript[AddOAuthPrompt](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/dialogs/mainDialog.js?range=50-52)]

В рамках следующего шага диалога проверьте наличие токена в результате предыдущего шага. Если он не является нулевым, пользователь успешно веннулся.

[!code-javascript[AddOAuthPrompt](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/dialogs/mainDialog.js?range=50-64)]

**боты/logoutDialog.js**

[!code-javascript[allow-logout](~/../botbuilder-samples/samples/javascript_nodejs/46.teams-auth/dialogs/logoutDialog.js?range=31-42&highlight=7)]

# <a name="python"></a>[Python](#tab/python-sample)

**боты/dialog_bot.py**

[!code-python[ActivityHandler](~/../botbuilder-samples/samples/python/46.teams-auth/bots/dialog_bot.py?range=10-42)]

**боты/teams_bot.py**

Действие *вызова должно* быть перенаправлено в диалог, **если используется OAuthPrompt.**

[!code-python[on_token_response_event](~/../botbuilder-samples/samples/python/46.teams-auth/bots/teams_bot.py?range=38-45)]

**диалоги/main_dialog.py**

В рамках шага диалога `begin_dialog` используйте для запуска подсказки OAuth, которая просит пользователя войти в нее.

- Если пользователь уже венся, это приведет к созданию события отклика токенов, не вызывая пользователя.
- В противном случае это покажет пользователю войти в нее. Служба Azure Bot отправляет событие отклика токена после попытки пользователя войти в систему.

[!code-python[Add OAuthPrompt](~/../botbuilder-samples/samples/python/46.teams-auth/dialogs/main_dialog.py?range=48-49)]

В рамках следующего шага диалога проверьте наличие токена в результате предыдущего шага. Если он не является нулевым, пользователь успешно веннулся.

[!code-python[Add OAuthPrompt](~/../botbuilder-samples/samples/python/46.teams-auth/dialogs/main_dialog.py?range=51-61)]

**диалоги/logout_dialog.py**

[!code-python[allow logout](~/../botbuilder-samples/samples/python/46.teams-auth/dialogs/logout_dialog.py?range=29-36&highlight=6)]

---

## <a name="see-also"></a>См. также

[Добавление аутентификации через службу Azure Bot](https://aka.ms/azure-bot-add-authentication)

<!-- Footnote-style links -->

[azure-portal]: https://ms.portal.azure.com

[concept-basics]: /azure/bot-service/bot-builder-basics?view=azure-bot-service-4.0&preserve-view=true
[concept-state]: /azure/bot-service/bot-builder-concept-state?view=azure-bot-service-4.0&preserve-view=true
[concept-dialogs]: /azure/bot-service/bot-builder-concept-dialog?view=azure-bot-service-4.0&preserve-view=true
[simple-dialog]: /azure/bot-service/bot-builder-dialog-manage-conversation-flow?view=azure-bot-service-4.0&preserve-view=true

[teams-auth-bot-cs]: https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/csharp_dotnetcore/46.teams-auth

[teams-auth-bot-py]: https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/python/46.teams-auth

[teams-auth-bot-js]: https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/javascript_nodejs/46.teams-auth

[azure-aad-blade]: https://ms.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview
[aad-registration-blade]: https://ms.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredAppsPreview
