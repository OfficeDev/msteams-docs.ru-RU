---
title: Поток проверки подлинности Microsoft Teams для ботов
description: Описывает поток проверки подлинности Microsoft Teams в ботах
keywords: боты потока проверки подлинности teams
ms.topic: overview
ms.openlocfilehash: 3d1d0055984de07b50a45015e062e6725279d1aa
ms.sourcegitcommit: b9771f8f4be9ac1ff8c85c2d7bd8d5c5408bc653
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "49768083"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a>Поток проверки подлинности для ботов в Microsoft Teams

OAuth 2.0 — это открытый стандарт проверки подлинности и авторизации, используемый Azure Active Directory (Azure AD) и многими другими поставщиками удостоверений. Базовое понимание OAuth 2.0 является необходимым условием для работы с проверкой подлинности в Teams; [Вот хороший обзор,](https://aaronparecki.com/oauth-2-simplified/) который проще выполнять, чем [формальный спецификации.](https://oauth.net/2/) Поток проверки подлинности для вкладок и ботов немного отличается — вкладки очень похожи на веб-сайты, поэтому они могут использовать OAuth 2.0 напрямую, в то время как боты не отличаются и должны по-разному делать что-то, но основные понятия идентичны.

См. пример проверки подлинности [Microsoft Teams](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) в репозитарии GitHub, демонстрируя поток проверки подлинности для ботов, использующих Node.js и тип предоставления кода авторизации [OAuth 2.0.](https://oauth.net/2/grant-types/authorization-code/)

![Схема последовательности проверки подлинности ботов](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. Пользователь отправляет сообщение боту.
2. Бот определяет, нужно ли пользователю войти.
   В этом примере бот сохраняет маркер доступа в хранилище пользовательских данных. Он просит пользователя войти, если у него нет проверенного маркера для выбранного поставщика удостоверений. ([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76)
3. Бот конструировать URL-адрес на начните страницу потока проверки подлинности и отправляет карточку пользователю с `signin` действием. ([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190)</br>
    Как и другие потоки авторизации приложений в Teams, начальная страница должна быть в домене, который есть в вашем списке, и в том же домене, что и страница перенаправления после `validDomains` входа.
    > [!IMPORTANT] 
    > Код авторизации OAuth 2.0 предоставляет поток вызовов для параметра в запросе проверки подлинности, который содержит уникальный маркер сеанса для предотвращения атаки подделки межсайтового `state` [запроса.](https://en.wikipedia.org/wiki/Cross-site_request_forgery) В этом примере используется случайным образом созданный GUID.
4. Когда пользователь нажал кнопку для *регистрации,* Teams открывает всплывающее окно и переходит на начните страницу.
   > [!NOTE]
   > Размером всплывающее окно можно управлять с помощью параметров строки запроса ширины и высоты в URL-адресе. Например, если добавить ширину=500 и высоту=500, размер всплывающее окно будет 500x500 пикселей. Teams отображает всплывающее окно с заданным размером пикселя до максимума, что в процентах от размера главного окна.

5. Начальная страница перенаправляет пользователя в конечную точку поставщика `authorize` удостоверений. ([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56)
6. На сайте поставщика пользователь войт и предоставляет доступ к боту.
7. Поставщик перенаправляет пользователя на страницу перенаправления OAuth бота с кодом авторизации.
8. Бот активировал код авторизации для маркера доступа и временно связывает маркер с пользователем, который инициировал поток входов.  Ниже мы называем это *временным маркером.*
    * В этом примере бот связывает значение параметра с идентификатором пользователя, который инициировал процесс регистрации, чтобы позже он соедиировал его со значением, возвращенным поставщиком `state` `state` удостоверений. ([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99)
      > [!IMPORTANT] 
      > Бот сохраняет маркер, который он получает от поставщика удостоверений, и связывает его с определенным пользователем, но помечен как "ожидающий проверки". 
    * Предварительный маркер нельзя использовать без дальнейшей проверки.
      1. **Проверьте, что получено от поставщика удостоверений.** Значение параметра `state` должно быть подтверждено с параметров, сохраненных ранее. 
      1. **Проверьте, что получено от Teams.** [Выполняется](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) двухшаговая проверка подлинности, чтобы пользователь, авторизованный ботом у поставщика удостоверений, был тем же пользователем, который общается с ботом. Эта схема защиты [от атак типа "человек в середине"](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) и [фишинговых](https://en.wikipedia.org/wiki/Phishing) атак. Бот создает код проверки и сохраняет его, связанный с пользователем. Код проверки автоматически отправляется Teams, как описано ниже. ([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113)
9. При вызове OAuth отрисовка страницы. `notifySuccess("<verification code>")` ([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs)
10. Teams закрывает всплывающее окно и отправляет `<verification code>` отправленное `notifySuccess()` боту. Бот получает сообщение об [вызове](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) с `name = signin/verifyState` .
11. Бот проверяет входящий код проверки на наличие кода проверки, хранимого с помощью пользовательского маркера. ([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140)
12. Если они совпадают, бот пометит маркер как проверенный и готовый к использованию. В противном случае поток auth не будет сбой, и бот удаляет временный маркер.

    > [!NOTE]
    > При проблемах с проверкой подлинности на мобильных устройствах убедитесь, что ваш javaScript SDK обновлен до версии 1.4.1 или более поздней.

## <a name="samples"></a>Примеры

Пример кода, показывающий процесс проверки подлинности бота, см. в:

[Пример проверки подлинности бота Microsoft Teams (Node.js)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a>Дополнительные сведения

Подробные по обзоры реализации для проверки подлинности ботов, нацеленной на Azure AD, см. в:

[Добавление проверки подлинности в бот Teams](add-authentication.md)
