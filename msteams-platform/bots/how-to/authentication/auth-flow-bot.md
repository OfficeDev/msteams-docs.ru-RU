---
title: Поток проверки подлинности Microsoft Teams для ботов
description: Описывает поток проверки подлинности Microsoft Teams в ботах
keywords: боты потока проверки подлинности teams
ms.topic: overview
ms.openlocfilehash: 3d1d0055984de07b50a45015e062e6725279d1aa
ms.sourcegitcommit: b9771f8f4be9ac1ff8c85c2d7bd8d5c5408bc653
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/06/2021
ms.locfileid: "49768083"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a><span data-ttu-id="4e242-104">Поток проверки подлинности для ботов в Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="4e242-104">Authentication flow for bots in Microsoft Teams</span></span>

<span data-ttu-id="4e242-105">OAuth 2.0 — это открытый стандарт проверки подлинности и авторизации, используемый Azure Active Directory (Azure AD) и многими другими поставщиками удостоверений.</span><span class="sxs-lookup"><span data-stu-id="4e242-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="4e242-106">Базовое понимание OAuth 2.0 является необходимым условием для работы с проверкой подлинности в Teams; [Вот хороший обзор,](https://aaronparecki.com/oauth-2-simplified/) который проще выполнять, чем [формальный спецификации.](https://oauth.net/2/)</span><span class="sxs-lookup"><span data-stu-id="4e242-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="4e242-107">Поток проверки подлинности для вкладок и ботов немного отличается — вкладки очень похожи на веб-сайты, поэтому они могут использовать OAuth 2.0 напрямую, в то время как боты не отличаются и должны по-разному делать что-то, но основные понятия идентичны.</span><span class="sxs-lookup"><span data-stu-id="4e242-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="4e242-108">См. пример проверки подлинности [Microsoft Teams](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) в репозитарии GitHub, демонстрируя поток проверки подлинности для ботов, использующих Node.js и тип предоставления кода авторизации [OAuth 2.0.](https://oauth.net/2/grant-types/authorization-code/)</span><span class="sxs-lookup"><span data-stu-id="4e242-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Схема последовательности проверки подлинности ботов](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="4e242-110">Пользователь отправляет сообщение боту.</span><span class="sxs-lookup"><span data-stu-id="4e242-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="4e242-111">Бот определяет, нужно ли пользователю войти.</span><span class="sxs-lookup"><span data-stu-id="4e242-111">The bot determines if the user needs to sign in.</span></span>
   <span data-ttu-id="4e242-112">В этом примере бот сохраняет маркер доступа в хранилище пользовательских данных.</span><span class="sxs-lookup"><span data-stu-id="4e242-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="4e242-113">Он просит пользователя войти, если у него нет проверенного маркера для выбранного поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="4e242-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="4e242-114">([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76)</span><span class="sxs-lookup"><span data-stu-id="4e242-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="4e242-115">Бот конструировать URL-адрес на начните страницу потока проверки подлинности и отправляет карточку пользователю с `signin` действием.</span><span class="sxs-lookup"><span data-stu-id="4e242-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="4e242-116">([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190)</span><span class="sxs-lookup"><span data-stu-id="4e242-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span></br>
    <span data-ttu-id="4e242-117">Как и другие потоки авторизации приложений в Teams, начальная страница должна быть в домене, который есть в вашем списке, и в том же домене, что и страница перенаправления после `validDomains` входа.</span><span class="sxs-lookup"><span data-stu-id="4e242-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    > [!IMPORTANT] 
    > <span data-ttu-id="4e242-118">Код авторизации OAuth 2.0 предоставляет поток вызовов для параметра в запросе проверки подлинности, который содержит уникальный маркер сеанса для предотвращения атаки подделки межсайтового `state` [запроса.](https://en.wikipedia.org/wiki/Cross-site_request_forgery)</span><span class="sxs-lookup"><span data-stu-id="4e242-118">The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="4e242-119">В этом примере используется случайным образом созданный GUID.</span><span class="sxs-lookup"><span data-stu-id="4e242-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="4e242-120">Когда пользователь нажал кнопку для *регистрации,* Teams открывает всплывающее окно и переходит на начните страницу.</span><span class="sxs-lookup"><span data-stu-id="4e242-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
   > [!NOTE]
   > <span data-ttu-id="4e242-121">Размером всплывающее окно можно управлять с помощью параметров строки запроса ширины и высоты в URL-адресе.</span><span class="sxs-lookup"><span data-stu-id="4e242-121">The size of the pop-up window can be controlled through width and height query string parameters in the URL.</span></span> <span data-ttu-id="4e242-122">Например, если добавить ширину=500 и высоту=500, размер всплывающее окно будет 500x500 пикселей.</span><span class="sxs-lookup"><span data-stu-id="4e242-122">For example, if you add width=500 and height=500, the size of the pop-up window is 500x500 pixels.</span></span> <span data-ttu-id="4e242-123">Teams отображает всплывающее окно с заданным размером пикселя до максимума, что в процентах от размера главного окна.</span><span class="sxs-lookup"><span data-stu-id="4e242-123">Teams displays the pop-up window with the given pixel size, up to a maximum that's a percentage of the size of the main window.</span></span>

5. <span data-ttu-id="4e242-124">Начальная страница перенаправляет пользователя в конечную точку поставщика `authorize` удостоверений.</span><span class="sxs-lookup"><span data-stu-id="4e242-124">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="4e242-125">([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56)</span><span class="sxs-lookup"><span data-stu-id="4e242-125">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="4e242-126">На сайте поставщика пользователь войт и предоставляет доступ к боту.</span><span class="sxs-lookup"><span data-stu-id="4e242-126">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="4e242-127">Поставщик перенаправляет пользователя на страницу перенаправления OAuth бота с кодом авторизации.</span><span class="sxs-lookup"><span data-stu-id="4e242-127">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="4e242-128">Бот активировал код авторизации для маркера доступа и временно связывает маркер с пользователем, который инициировал поток входов. </span><span class="sxs-lookup"><span data-stu-id="4e242-128">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="4e242-129">Ниже мы называем это *временным маркером.*</span><span class="sxs-lookup"><span data-stu-id="4e242-129">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="4e242-130">В этом примере бот связывает значение параметра с идентификатором пользователя, который инициировал процесс регистрации, чтобы позже он соедиировал его со значением, возвращенным поставщиком `state` `state` удостоверений.</span><span class="sxs-lookup"><span data-stu-id="4e242-130">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="4e242-131">([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99)</span><span class="sxs-lookup"><span data-stu-id="4e242-131">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
      > [!IMPORTANT] 
      > <span data-ttu-id="4e242-132">Бот сохраняет маркер, который он получает от поставщика удостоверений, и связывает его с определенным пользователем, но помечен как "ожидающий проверки".</span><span class="sxs-lookup"><span data-stu-id="4e242-132">The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> 
    * <span data-ttu-id="4e242-133">Предварительный маркер нельзя использовать без дальнейшей проверки.</span><span class="sxs-lookup"><span data-stu-id="4e242-133">The provisional token can't be used without further validation.</span></span>
      1. <span data-ttu-id="4e242-134">**Проверьте, что получено от поставщика удостоверений.**</span><span class="sxs-lookup"><span data-stu-id="4e242-134">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="4e242-135">Значение параметра `state` должно быть подтверждено с параметров, сохраненных ранее.</span><span class="sxs-lookup"><span data-stu-id="4e242-135">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="4e242-136">**Проверьте, что получено от Teams.**</span><span class="sxs-lookup"><span data-stu-id="4e242-136">**Validate what's received from Teams.**</span></span> <span data-ttu-id="4e242-137">[Выполняется](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) двухшаговая проверка подлинности, чтобы пользователь, авторизованный ботом у поставщика удостоверений, был тем же пользователем, который общается с ботом.</span><span class="sxs-lookup"><span data-stu-id="4e242-137">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="4e242-138">Эта схема защиты [от атак типа "человек в середине"](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) и [фишинговых](https://en.wikipedia.org/wiki/Phishing) атак.</span><span class="sxs-lookup"><span data-stu-id="4e242-138">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="4e242-139">Бот создает код проверки и сохраняет его, связанный с пользователем.</span><span class="sxs-lookup"><span data-stu-id="4e242-139">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="4e242-140">Код проверки автоматически отправляется Teams, как описано ниже.</span><span class="sxs-lookup"><span data-stu-id="4e242-140">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="4e242-141">([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113)</span><span class="sxs-lookup"><span data-stu-id="4e242-141">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="4e242-142">При вызове OAuth отрисовка страницы. `notifySuccess("<verification code>")`</span><span class="sxs-lookup"><span data-stu-id="4e242-142">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="4e242-143">([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs)</span><span class="sxs-lookup"><span data-stu-id="4e242-143">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="4e242-144">Teams закрывает всплывающее окно и отправляет `<verification code>` отправленное `notifySuccess()` боту.</span><span class="sxs-lookup"><span data-stu-id="4e242-144">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="4e242-145">Бот получает сообщение об [вызове](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) с `name = signin/verifyState` .</span><span class="sxs-lookup"><span data-stu-id="4e242-145">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="4e242-146">Бот проверяет входящий код проверки на наличие кода проверки, хранимого с помощью пользовательского маркера.</span><span class="sxs-lookup"><span data-stu-id="4e242-146">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="4e242-147">([Просмотреть код)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140)</span><span class="sxs-lookup"><span data-stu-id="4e242-147">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="4e242-148">Если они совпадают, бот пометит маркер как проверенный и готовый к использованию.</span><span class="sxs-lookup"><span data-stu-id="4e242-148">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="4e242-149">В противном случае поток auth не будет сбой, и бот удаляет временный маркер.</span><span class="sxs-lookup"><span data-stu-id="4e242-149">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

    > [!NOTE]
    > <span data-ttu-id="4e242-150">При проблемах с проверкой подлинности на мобильных устройствах убедитесь, что ваш javaScript SDK обновлен до версии 1.4.1 или более поздней.</span><span class="sxs-lookup"><span data-stu-id="4e242-150">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="samples"></a><span data-ttu-id="4e242-151">Примеры</span><span class="sxs-lookup"><span data-stu-id="4e242-151">Samples</span></span>

<span data-ttu-id="4e242-152">Пример кода, показывающий процесс проверки подлинности бота, см. в:</span><span class="sxs-lookup"><span data-stu-id="4e242-152">For sample code showing the bot authentication process see:</span></span>

[<span data-ttu-id="4e242-153">Пример проверки подлинности бота Microsoft Teams (Node.js)</span><span class="sxs-lookup"><span data-stu-id="4e242-153">Microsoft Teams bot authentication sample (Node.js)</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a><span data-ttu-id="4e242-154">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="4e242-154">More details</span></span>

<span data-ttu-id="4e242-155">Подробные по обзоры реализации для проверки подлинности ботов, нацеленной на Azure AD, см. в:</span><span class="sxs-lookup"><span data-stu-id="4e242-155">For detailed implementation walkthroughs for bot authentication targeting Azure AD see:</span></span>

[<span data-ttu-id="4e242-156">Добавление проверки подлинности в бот Teams</span><span class="sxs-lookup"><span data-stu-id="4e242-156">Add authentication to your Teams bot</span></span>](add-authentication.md)
