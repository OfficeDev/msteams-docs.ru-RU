---
title: Процесс проверки подлинности для Боты
description: Описание процесса проверки подлинности в Боты
keywords: Боты процесса проверки подлинности Teams
ms.date: 03/01/2018
ms.openlocfilehash: 40f34a3b51349cc1d11f819a92b479a92ebac149
ms.sourcegitcommit: 4329a94918263c85d6c65ff401f571556b80307b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2020
ms.locfileid: "41675576"
---
# <a name="microsoft-teams-authentication-flow-for-bots"></a><span data-ttu-id="da780-104">Процесс проверки подлинности Microsoft Teams для Боты</span><span class="sxs-lookup"><span data-stu-id="da780-104">Microsoft Teams authentication flow for bots</span></span>

<span data-ttu-id="da780-105">OAuth 2,0 — это открытый стандарт проверки подлинности и авторизации, используемый Azure Active Directory (Azure AD) и многими другими поставщиками удостоверений.</span><span class="sxs-lookup"><span data-stu-id="da780-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="da780-106">Основное понимание OAuth 2,0 является необходимым условием для работы с проверкой подлинности в Teams; [Вот хороший обзор](https://aaronparecki.com/oauth-2-simplified/) , который легче следовать, чем [формальное описание](https://oauth.net/2/).</span><span class="sxs-lookup"><span data-stu-id="da780-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="da780-107">Процесс проверки подлинности для вкладок и боты немного отличается — вкладки очень похожи на веб-сайты, поэтому они могут использовать OAuth 2,0 напрямую, в то время как боты не так и не должны выполнять несколько действий по-разному, но основные понятия идентичны.</span><span class="sxs-lookup"><span data-stu-id="da780-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="da780-108">Пример [проверки подлинности Microsoft Teams](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) , который демонстрирует процесс проверки подлинности для боты с помощью Node. js и [Тип предоставления кода авторизации OAuth 2,0](https://oauth.net/2/grant-types/authorization-code/), представлен в репозитории GitHub Microsoft Teams.</span><span class="sxs-lookup"><span data-stu-id="da780-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Схема последовательности проверки подлинности на Bot](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="da780-110">Пользователь отправляет сообщение в Bot.</span><span class="sxs-lookup"><span data-stu-id="da780-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="da780-111">Элемент Bot определяет, нужно ли выполнять вход в систему.</span><span class="sxs-lookup"><span data-stu-id="da780-111">The bot determines if the user needs to sign in.</span></span>
    * <span data-ttu-id="da780-112">В этом примере элемент Bot хранит маркер доступа в хранилище данных пользователя.</span><span class="sxs-lookup"><span data-stu-id="da780-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="da780-113">Он просит пользователя выполнить вход, если у него нет проверенного маркера для выбранного поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="da780-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="da780-114">([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="da780-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="da780-115">Элемент Bot создает URL-адрес начальной страницы для процесса проверки подлинности и отправляет карточку пользователю с `signin` действием.</span><span class="sxs-lookup"><span data-stu-id="da780-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="da780-116">([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="da780-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span>
    * <span data-ttu-id="da780-117">Как и в случае с другими потоками проверки подлинности приложений в Teams, начальная страница `validDomains` должна находиться в домене, который находится в списке, и в том же домене, что и страница перенаправления после входа.</span><span class="sxs-lookup"><span data-stu-id="da780-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    * <span data-ttu-id="da780-118">**Важно!** код авторизации OAuth 2,0 вызывает для `state` параметра в запросе на проверку подлинности, который содержит уникальный маркер сеанса для предотвращения атаки на [межсайтовый запрос на межсайтовую подделку](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span><span class="sxs-lookup"><span data-stu-id="da780-118">**IMPORTANT**: The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="da780-119">В этом примере используется идентификатор GUID, созданный случайным образом.</span><span class="sxs-lookup"><span data-stu-id="da780-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="da780-120">Когда пользователь нажимает кнопку *Signing (войти* ), Teams открывает всплывающее окно и переходит на начальную страницу.</span><span class="sxs-lookup"><span data-stu-id="da780-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
5. <span data-ttu-id="da780-121">Начальная страница перенаправляет пользователя на `authorize` конечную точку поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="da780-121">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="da780-122">([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="da780-122">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="da780-123">На сайте поставщика пользователь входит в систему и предоставляет доступ к Bot.</span><span class="sxs-lookup"><span data-stu-id="da780-123">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="da780-124">Поставщик переводит пользователя на страницу переадресации OAuth на Bot с кодом авторизации.</span><span class="sxs-lookup"><span data-stu-id="da780-124">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="da780-125">Bot пополняет код авторизации для маркера доступа **, а затем** связывает маркер с пользователем, который инициировал процесс входа.</span><span class="sxs-lookup"><span data-stu-id="da780-125">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="da780-126">Ниже мы вызываем этот *описатель подготовки*.</span><span class="sxs-lookup"><span data-stu-id="da780-126">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="da780-127">В этом примере с помощью Bot связывается значение `state` параметра с идентификатором пользователя, который инициировал процесс входа, поэтому он может впоследствии сопоставлять его со `state` значением, возвращенным поставщиком удостоверений.</span><span class="sxs-lookup"><span data-stu-id="da780-127">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="da780-128">([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="da780-128">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
    * <span data-ttu-id="da780-129">**Важно!** элемент Bot хранит маркер, который он получает от поставщика удостоверений, и связывает его с определенным пользователем, но отмечено как "Ожидание проверки".</span><span class="sxs-lookup"><span data-stu-id="da780-129">**IMPORTANT**: The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> <span data-ttu-id="da780-130">Вы пока не можете использовать предварительный маркер. необходимо выполнить дальнейшую проверку:</span><span class="sxs-lookup"><span data-stu-id="da780-130">The provisional token can't be used yet; it must be further validated:</span></span>
      1. <span data-ttu-id="da780-131">**Проверка того, что получено от поставщика удостоверений.**</span><span class="sxs-lookup"><span data-stu-id="da780-131">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="da780-132">Значение `state` параметра должно быть подтверждено относительно того, что было сохранено ранее.</span><span class="sxs-lookup"><span data-stu-id="da780-132">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="da780-133">**Проверка того, что получено от Teams.**</span><span class="sxs-lookup"><span data-stu-id="da780-133">**Validate what's received from Teams.**</span></span> <span data-ttu-id="da780-134">Проверка [подлинности выполняется в два этапа](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) с учетом того, что пользователь, уполномоченный с помощью поставщика удостоверений, — это тот же пользователь, что и в чате.</span><span class="sxs-lookup"><span data-stu-id="da780-134">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="da780-135">Это защищает от атак ["злоумышленник в середине"](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) и " [Фишинг](https://en.wikipedia.org/wiki/Phishing) ".</span><span class="sxs-lookup"><span data-stu-id="da780-135">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="da780-136">Bot создает код проверки и сохраняет его, связанный с пользователем.</span><span class="sxs-lookup"><span data-stu-id="da780-136">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="da780-137">Код проверки автоматически отправляется Teams, как описано ниже.</span><span class="sxs-lookup"><span data-stu-id="da780-137">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="da780-138">([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="da780-138">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="da780-139">Обратный вызов OAuth отображает страницу, которая вызывается `notifySuccess("<verification code>")`.</span><span class="sxs-lookup"><span data-stu-id="da780-139">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="da780-140">([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="da780-140">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="da780-141">Teams закрывает всплывающее окно и отправляет `<verification code>` `notifySuccess()` ответ на задний план.</span><span class="sxs-lookup"><span data-stu-id="da780-141">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="da780-142">Bot получает сообщение о [вызове](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) `name = signin/verifyState`.</span><span class="sxs-lookup"><span data-stu-id="da780-142">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="da780-143">Bot проверяет входящий код проверки относительно кода проверки, хранящегося в пользовательском маркере подготовки.</span><span class="sxs-lookup"><span data-stu-id="da780-143">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="da780-144">([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="da780-144">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="da780-145">Если они совпадают, элемент Bot помечает маркер как проверенный и готовый к использованию.</span><span class="sxs-lookup"><span data-stu-id="da780-145">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="da780-146">В противном случае произойдет сбой процесса проверки подлинности, а Bot будет удален.</span><span class="sxs-lookup"><span data-stu-id="da780-146">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

> [!NOTE]
> <span data-ttu-id="da780-147">При возникновении проблем с проверкой подлинности на мобильном устройстве убедитесь, что пакет SDK для JavaScript обновлен до версии 1.4.1 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="da780-147">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="samples"></a><span data-ttu-id="da780-148">Примеры</span><span class="sxs-lookup"><span data-stu-id="da780-148">Samples</span></span>

<span data-ttu-id="da780-149">Пример кода, демонстрирующий процесс создания подлинности на Bot, см.</span><span class="sxs-lookup"><span data-stu-id="da780-149">For sample code showing the bot authentication process see:</span></span>

* [<span data-ttu-id="da780-150">Пример проверки подлинности с помощью Microsoft Teams (Node. js)</span><span class="sxs-lookup"><span data-stu-id="da780-150">Microsoft Teams bot authentication sample (Node.js)</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a><span data-ttu-id="da780-151">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="da780-151">More details</span></span>

<span data-ttu-id="da780-152">Подробные пошаговые руководства по реализации проверки подлинности, нацеленной на Azure AD, приведены ниже.</span><span class="sxs-lookup"><span data-stu-id="da780-152">For detailed implementation walkthroughs for bot authentication targeting Azure AD see:</span></span>

* [<span data-ttu-id="da780-153">Добавление проверки подлинности для ленты Teams</span><span class="sxs-lookup"><span data-stu-id="da780-153">Add authentication to your Teams bot</span></span>](add-authentication.md)
