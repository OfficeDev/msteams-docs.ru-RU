---
title: Поток проверки подлинности Microsoft Teams для ботов
description: В этом модуле вы узнаете, как выполнить поток проверки подлинности для ботов в Microsoft Teams примере кода.
ms.localizationpriority: medium
ms.topic: overview
ms.openlocfilehash: de263a75b7b8077570dca2f94bf6937d9d339bbe
ms.sourcegitcommit: ca84b5fe5d3b97f377ce5cca41c48afa95496e28
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2022
ms.locfileid: "66143237"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a>Поток проверки подлинности для ботов в Microsoft Teams

OAuth 2.0 — это открытый стандарт проверки подлинности и авторизации, используемый Azure Active Directory и многими другими поставщиками удостоверений. Базовое представление OAuth 2.0 является необходимым условием для работы с проверкой подлинности в Teams. [Ниже представлен хороший обзор](https://aaronparecki.com/oauth-2-simplified/), который проще соблюдать, чем [формальную спецификацию](https://oauth.net/2/). Поток проверки подлинности для вкладок и ботов немного отличается — вкладки похожи на веб-сайты, поэтому они могут использовать OAuth 2.0 напрямую, тогда как боты не выполняют и должны выполнять несколько разных действий по-разному, но основные понятия идентичны.

См. [образец проверки подлинности Microsoft Teams](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) репозитория GitHub для примера, демонстрирующего процесс проверки подлинности для ботов с использованием Node.js и [типа предоставления кода авторизации OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/).

![Схема последовательностей проверки подлинности бота](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. Пользователь отправляет боту сообщение.
2. Бот определяет, нужно ли пользователю выполнять вход.
   В этом примере бот сохраняет маркер доступа в хранилище пользовательских данных. Он запрашивает вход пользователя, если у него нет проверенного маркера для выбранного поставщика удостоверений. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))
3. Бот создает URL-адрес начальной страницы потока проверки подлинности и отправляет карточку пользователю с действием `signin`. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</br>
    Как и другие потоки проверки подлинности приложений в Teams, начальная страница должна находиться в домене, указанном в вашем списке `validDomains`, и в том же домене, что и страница перенаправления после входа.
    > [!IMPORTANT]
    > Поток предоставления кода авторизации OAuth 2.0 вызывает параметр `state` в запросе на проверку подлинности, который содержит уникальный маркер сеанса для предотвращения [атаки подделки межсайтовых запросов](https://en.wikipedia.org/wiki/Cross-site_request_forgery). В примере используется случайно созданный глобальный уникальный идентификатор.
4. Когда пользователь нажимает кнопку *входа*, Teams открывает всплывающее окно и переходит на начальную страницу.
   > [!NOTE]
   > Размер всплывающего окна можно контролировать с помощью параметров строки запроса ширины и высоты в URL-адресе. Например, если добавить width=600 и height=600, размер всплывающего окна составит 600x600 пикселей. Фактический размер всплывающего окна ограничен процентом от размера главного окна Teams. Если окно Teams небольшое, всплывающее окно меньше указанных размеров.

5. Начальная страница перенаправляет пользователя в конечную точку `authorize` поставщика удостоверений. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))
6. На сайте поставщика пользователь выполняет вход и предоставляет доступ к боту.
7. Поставщик направляет пользователя на страницу перенаправления OAuth бота с кодом авторизации.
8. Бот активирует код авторизации на маркер доступа и **предварительно** связывает маркер с пользователем, инициировавшим процесс входа. Ниже мы называем это *маркером подготовки*.
    * В этом примере бот связывает значение параметра `state` с идентификатором пользователя, который инициировал процесс входа, чтобы впоследствии сопоставить его со значением `state`, возвращенным поставщиком удостоверений. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))
      > [!IMPORTANT]
      > Бот сохраняет маркер, полученный от поставщика удостоверений, и связывает его с конкретным пользователем, но помечает его как «ожидающий проверки».
    * Маркер подготовки нельзя использовать без дополнительной проверки.
      1. **Проверьте, что получено от поставщика удостоверений.** Значение параметра `state` необходимо сверить с тем, что было сохранено ранее.
      1. **Проверьте, что получено от Teams.** Выполняется [двухэтапная проверка подлинности](https://en.wikipedia.org/wiki/Man-in-the-middle_attack), чтобы убедиться, что пользователь, авторизовавший бота с помощью поставщика удостоверений, является тем же пользователем, который общается с ботом. Это защищает от атак типа [злоумышленник в середине](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) и [фишинга](https://en.wikipedia.org/wiki/Phishing). Бот создает код проверки и сохраняет его, связанный с пользователем. Код проверки автоматически отправляется Teams, как описано ниже. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))
9. Обратный вызов OAuth отображает страницу, которая вызывает `notifySuccess("<verification code>")`. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))
10. Teams закрывает всплывающее окно и отправляет `<verification code>`, отправленное `notifySuccess()` обратно в бот. Бот получает сообщение [вызова](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) с `name = signin/verifyState`.
11. Бот сравнивает входящий код подтверждения с кодом проверки, хранящимся в маркере подготовки пользователя. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))
12. Если они совпадают, бот помечает маркер как проверенный и готовый к использованию. В противном случае поток проверки подлинности завершится ошибкой, и бот удалит временный маркер.

    > [!NOTE]
    > Если у вас возникли проблемы с проверкой подлинности на мобильных устройствах, убедитесь, что ваш пакет SDK для JavaScript обновлен до версии 1.4.1 или более поздней.

## <a name="code-sample"></a>Пример кода

Пример кода, показывающий процесс проверки подлинности бота:

| **Название примера** | **Описание** | **Node.js** | **.NET** | **Python** |
|-----------------|----------------|--------------|----------|-----------|
| Проверка подлинности Teams | Этот пример иллюстрирует проверку подлинности в приложениях Microsoft Teams. | [View](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) | | |
| Проверка подлинности бота | В этом примере показано, как использовать проверку подлинности для бота, запущенного в Microsoft Teams | [View](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/javascript_nodejs/46.teams-auth) | [View](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/46.teams-auth) | [Просмотр](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python/46.teams-auth)

## <a name="see-also"></a>Дополнительные ресурсы

[Добавление проверки подлинности для бота Teams](add-authentication.md)
