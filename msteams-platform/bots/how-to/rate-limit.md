---
title: Оптимизация бота с ограничением скорости в Teams
description: Узнайте об ограничении скорости обработки для ботов с ограничением "На бота на ограничение потока" и "На ограничение" для всех ботов, использующих примеры кода. Кроме того, вы узнаете, как ограничить скорость в Microsoft Teams.
ms.topic: conceptual
ms.localizationpriority: medium
keywords: ограничение скорости ботов teams
ms.openlocfilehash: a864970bd837ef4af3ccebe0b09ca4d38ac7b76b
ms.sourcegitcommit: eeaa8cbb10b9dfa97e9c8e169e9940ddfe683a7b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2022
ms.locfileid: "65757152"
---
# <a name="optimize-your-bot-with-rate-limiting-in-teams"></a>Оптимизация бота с ограничением скорости в Teams

Ограничение скорости — это метод ограничения максимальной частоты сообщений. Как правило, приложение должно ограничить количество сообщений, которые оно публикует, в отдельном чате или беседе канала. Это гарантирует, что оптимальный интерфейс и сообщения не будут отображаться как спам для пользователей.

Чтобы защитить Microsoft Teams и его пользователей, API бота предоставляют ограничение скорости для входящих запросов. Приложения, которые превышают это ограничение, получают состояние ошибки `HTTP 429 Too Many Requests`. На все запросы налагается та же политика ограничения скорости, в том числе отправка сообщений, перечисления каналов и извлечение составов.

Так как точные значения пределов скорости могут изменяться, приложение должно реализовать соответствующее поведение отхода, когда API возвращает `HTTP 429 Too Many Requests`.

## <a name="handle-rate-limits"></a>Ограничения скорости обработки

При публикации операции SDK Bot Builder можно обработать `Microsoft.Rest.HttpOperationException` и проверить код состояния.

В следующем коде показан пример ограничения скорости обработки:

```csharp
try
{
    // Perform Bot Framework operation
    // for example, await connector.Conversations.UpdateActivityAsync(reply);
}
catch (HttpOperationException ex)
{
    if (ex.Response != null && (uint)ex.Response.StatusCode ==  429)
    {
        //Perform retry of the above operation/Action method
    }
}
```

После обработки ограничений скорости для ботов можно обрабатывать ответы (`HTTP 429`) с помощью экспоненциального отхода.

## <a name="handle-http-429-responses"></a>Обработка ответов (`HTTP 429`)

Как правило, необходимо соблюдать простые меры предосторожности, чтобы не получить много ответов (`HTTP 429`). Например, избегайте нескольких запросов к одной личной беседе или беседе канала. Вместо этого создайте пакет запросов API.

Для обработки 429-х рекомендуется использовать экспоненциальный отход с произвольным дрожанием. Это гарантирует, что несколько запросов не приводят к конфликтам при повторных попытках.

После обработки ответов (`HTTP 429`) можно перейти к примеру обнаружения временных исключений.

> [!NOTE]
> Помимо повторной попытке при коде ошибки **429**, при кодах ошибок **412**, **502** и **504** также следует выполнить повторную попытку.

## <a name="detect-transient-exceptions-example"></a>Пример обнаружения временных исключений

В следующем коде показан пример использования экспоненциального отхода с помощью блока приложения для обработки временных сбоев:

```csharp
public class BotSdkTransientExceptionDetectionStrategy : ITransientErrorDetectionStrategy
    {
        // List of error codes to retry on
        List<int> transientErrorStatusCodes = new List<int>() { 429 };

        public static bool IsTransient(Exception ex)
          {
              if (ex.Message.Contains("429"))
                  return true;

              HttpResponseMessageWrapper? response = null;
              if (ex is HttpOperationException httpOperationException)
              {
                  response = httpOperationException.Response;
              }
              else
              if (ex is ErrorResponseException errorResponseException)
              {
                  response = errorResponseException.Response;
              }
              return response != null && transientErrorStatusCodes.Contains((int)response.StatusCode);
          }
    }
```

Вы можете выполнить отход и повторную попытку с помощью [обработки временных сбоев](/previous-versions/msp-n-p/hh675232%28v%3dpandp.10%29). Рекомендации по получению и установке пакета NuGet см. в статье [Добавление в решение блока приложения обработки временных сбоев](/previous-versions/msp-n-p/dn440719(v=pandp.60)?redirectedfrom=MSDN). Также см. статью [Обработка временных сбоев](/azure/architecture/best-practices/transient-faults).

После того как вы пройдете пример обнаружения временных исключений, просмотрите пример экспоненциального отхода. При сбоях вы можете использовать экспоненциальный отход, а не повторять попытку.

## <a name="backoff-example"></a>Пример отхода

Помимо определения пределов скорости, вы также можете выполнить экспоненциальный отход.

В следующем коде показан пример экспоненциального отхода:

```csharp
/**
* The first parameter specifies the number of retries before failing the operation.
* The second parameter specifies the minimum and maximum backoff time respectively.
* The last parameter is used to add a randomized  +/- 20% delta to avoid numerous clients retrying simultaneously.
*/
var exponentialBackoffRetryStrategy = new ExponentialBackoff(3, TimeSpan.FromSeconds(2),
                        TimeSpan.FromSeconds(20), TimeSpan.FromSeconds(1));


// Define the Retry Policy
var retryPolicy = new RetryPolicy(new BotSdkTransientExceptionDetectionStrategy(), exponentialBackoffRetryStrategy);

//Execute any bot sdk action
await retryPolicy.ExecuteAsync(() => connector.Conversations.ReplyToActivityAsync( (Activity)reply) ).ConfigureAwait(false);
```

Вы также можете выполнить метод `System.Action` с помощью политики повторных попыток, описанной в этом разделе. Указанная библиотека также позволяет указать фиксированный интервал или линейный механизм отхода.

Храните значение и стратегию в файле конфигурации для точной настройки и настройки значений во время работы.

Дополнительные сведения см. в статье [Шаблоны повторных попыток](/azure/architecture/patterns/retry).

Вы также можете обрабатывать ограничение скорости с помощью ограничения на бота на поток.

## <a name="per-bot-per-thread-limit"></a>Ограничение на бота на поток

Ограничение на бота на поток управляет трафиком, который бот может создавать в одной беседе. Беседа — это личный диалог между ботом и пользователем, групповым чатом или каналом в команде. Таким образом, если приложение отправляет каждому пользователю одно сообщение бота, ограничение потока не будет регулироваться.

>[!NOTE]
>
> * Ограничение потока в 3600 секунд и 1800 операций применяется, только если одному пользователю отправляется несколько сообщений бота.
> * Глобальное ограничение на приложение для каждого клиента составляет 50 запросов в секунду (RPS). Таким образом, общее число сообщений бота в секунду не должно превышать ограничение потока.
> * Разделение сообщений на уровне службы приводит к большему значению RPS, чем ожидалось. Если вас беспокоит приближение к ограничению, необходимо реализовать [стратегию отхода](#backoff-example). Значения в этом разделе представлены только для оценки.

В следующей таблице содержатся ограничения на бота на поток.

| Сценарий | Период в секундах | Максимальное разрешенное количество операций |
| --- | --- | --- |
| Отправка в беседу | 1 | 7  |
| Отправка в беседу | 2 | 8  |
| Отправка в беседу | 30 | 60 |
| Отправка в беседу | 3600 | 1800 |
| Создание беседы | 1 | 7  |
| Создание беседы | 2 | 8  |
| Создание беседы | 30 | 60 |
| Создание беседы | 3600 | 1800 |
| Получить участников беседы| 1 | 14 |
| Получить участников беседы| 2 | 16 |
| Получить участников беседы| 30 | 120 |
| Получить участников беседы| 3600 | 3600 |
| Получить беседы | 1 | 14 |
| Получить беседы | 2 | 16 |
| Получить беседы | 30 | 120 |
| Получить беседы | 3600 | 3600 |

>[!NOTE]
> Предыдущие версии API `TeamsInfo.getMembers` и `TeamsInfo.GetMembersAsync` не рекомендуются. Они подвержены регулированию, ограничивая производительность пятью запросами в минуту, и возвращают не более 10 000 участников на команду. Чтобы обновить SDK Bot Framework и код для использования последних конечных точек API с разбивкой на страницы, см. [Изменения API-интерфейса бота для участников группы или чата](../../resources/team-chat-member-api-changes.md).

Вы также можете обрабатывать ограничение скорости с помощью ограничения на поток для всех ботов.

## <a name="per-thread-limit-for-all-bots"></a>Ограничение на поток для всех ботов

Ограничение на поток для всех ботов управляет трафиком, который все боты могут создавать в одной беседе. Ниже приведена беседа 1:1 между ботом и пользователем, групповым чатом или каналом в команде.

В следующей таблице содержатся ограничения на поток для всех ботов.

| Сценарий | Период в секундах | Максимальное разрешенное количество операций |
| --- | --- | --- |
| Отправка в беседу | 1 | 14 |
| Отправка в беседу | 2 | 16 |
| Создание беседы | 1 | 14 |
| Создание беседы | 2 | 16 |
| Создание беседы| 1 | 14 |
| Создание беседы| 2 | 16 |
| Получить участников беседы| 1 | 28 |
| Получить участников беседы| 2 | 32 |
| Получить беседы | 1 | 28 |
| Получить беседы | 2 | 32 |

## <a name="next-step"></a>Следующий этап

> [!div class="nextstepaction"]
> [Боты для звонков и собраний](~/bots/calls-and-meetings/calls-meetings-bots-overview.md)
