---
title: Оптимизация бота с ограничением скорости в Teams
description: Ограничение скорости и лучшие практики в Microsoft Teams
ms.topic: conceptual
localization_priority: Normal
keywords: ограничения скорости командных ботов
ms.openlocfilehash: 1ee98af7704baa066ad6ca7adbf0997879454a3c58e83d62ea4f5a2f17c20c36
ms.sourcegitcommit: 3ab1cbec41b9783a7abba1e0870a67831282c3b5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2021
ms.locfileid: "57705610"
---
# <a name="optimize-your-bot-with-rate-limiting-in-teams"></a>Оптимизация бота с ограничением скорости в Teams

Ограничение скорости — это метод, ограничивающий сообщения определенной максимальной частотой. В общем принципе ваше приложение должно ограничить количество сообщений, которые оно публикует, отдельным чатом или разговором по каналу. Это обеспечивает оптимальное впечатление и сообщения не отображаются в качестве нежелательной почты для пользователей.

Для защиты Microsoft Teams пользователей API-бота предоставляют ограничение скорости для входящих запросов. Приложения, которые преодолеют это ограничение, получают `HTTP 429 Too Many Requests` состояние ошибки. Все запросы подчиняются одной и той же политике ограничения скорости, включая отправку сообщений, список каналов и извлечение реестра.

Поскольку точные значения ограничений скорости могут изменяться, ваше приложение должно реализовать соответствующее поведение при возврате `HTTP 429 Too Many Requests` API.

## <a name="handle-rate-limits"></a>Ограничения скорости обработки

При выдаче SDK-операции Bot Builder можно обрабатывать и `Microsoft.Rest.HttpOperationException` проверять код состояния.

В следующем коде показан пример ограничения скорости обработки:

```csharp
try
{
    // Perform Bot Framework operation
    // for example, await connector.Conversations.UpdateActivityAsync(reply);
}
catch (HttpOperationException ex)
{
    if (ex.Response != null && (uint)ex.Response.StatusCode ==  429)
    {
        //Perform retry of the above operation/Action method
    }
}
```

После обработки ограничений скорости для ботов можно обрабатывать ответы с `HTTP 429` помощью экспоненциального отработки.

## <a name="handle-http-429-responses"></a>Обработка `HTTP 429` ответов

В общем, необходимо принять простые меры предосторожности, чтобы избежать получения `HTTP 429` ответов. Например, не следует выдавать несколько запросов в один и тот же личный или каналный разговор. Вместо этого создайте пакет запросов API.

Использование экспоненциального отработки со случайным испугом — это рекомендуемый способ обработки 429s. Это гарантирует, что в нескольких запросах не будут вводиться столкновения при повторном запросе.

После обработки ответов можно перейти к примеру для обнаружения `HTTP 429` временных исключений.

> [!NOTE]
> В дополнение к повторной ошибке код **429,** коды ошибок **412**, **502** и **504** также должны быть повторно.

## <a name="detect-transient-exceptions-example"></a>Обнаружение примера временных исключений

В следующем коде показан пример использования экспоненциального отработки с помощью преходящего блока обработки ошибок приложения:

```csharp
public class BotSdkTransientExceptionDetectionStrategy : ITransientErrorDetectionStrategy
    {
        // List of error codes to retry on
        List<int> transientErrorStatusCodes = new List<int>() { 429 };

        public bool IsTransient(Exception ex)
        {
            if (ex.Message.Contains("429"))
                return true;

            var httpOperationException = ex as HttpOperationException;
            if (httpOperationException != null)
            {
                return httpOperationException.Response != null &&
                        transientErrorStatusCodes.Contains((int)httpOperationException.Response.StatusCode);
            }

            return false;
        }
    }
```

Вы можете выполнять отработку и повторное выполнение с помощью [обработки временных ошибок.](/previous-versions/msp-n-p/hh675232%28v%3dpandp.10%29) Рекомендации по получению и установке пакета NuGet [](/previous-versions/msp-n-p/dn440719(v=pandp.60)?redirectedfrom=MSDN)см. в добавлении к решению блока обработки сбоя. См. [также переходную обработку с ошибками.](/azure/architecture/best-practices/transient-faults)

После того, как вы пройдите по примеру обнаружения временных исключений, перейдите по примеру экспоненциального обратного степеня. Вы можете использовать экспоненциальный отбой вместо повторной работы по сбоям.

## <a name="backoff-example"></a>Пример backoff

Помимо обнаружения ограничений скорости, вы также можете выполнить экспоненциальный отсев.

В следующем коде показан пример экспоненциального отсевов:

```csharp
/**
* The first parameter specifies the number of retries before failing the operation.
* The second parameter specifies the minimum and maximum backoff time respectively.
* The last parameter is used to add a randomized  +/- 20% delta to avoid numerous clients retrying simultaneously.
*/
var exponentialBackoffRetryStrategy = new ExponentialBackoff(3, TimeSpan.FromSeconds(2),
                        TimeSpan.FromSeconds(20), TimeSpan.FromSeconds(1));


// Define the Retry Policy
var retryPolicy = new RetryPolicy(new BotSdkTransientExceptionDetectionStrategy(), exponentialBackoffRetryStrategy);

//Execute any bot sdk action
await retryPolicy.ExecuteAsync(() => connector.Conversations.ReplyToActivityAsync( (Activity)reply) ).ConfigureAwait(false);
```

Можно также выполнить выполнение метода `System.Action` с помощью политики повторного выполнения, описанной в этом разделе. В ссылаемой библиотеке также можно указать фиксированный интервал или механизм линейного отсевов.

Храните значение и стратегию в файле конфигурации для настройки и настройки значений во время запуска.

Дополнительные сведения см. [в шаблонах повторного получения.](/azure/architecture/patterns/retry)

Вы также можете обрабатывать ограничение скорости с помощью каждого бота в потоке.

## <a name="per-bot-per-thread-limit"></a>Ограничение на один бот на поток

Ограничение для каждого бота в потоке управляет трафиком, который может создаваться ботом в одном разговоре. Беседа 1:1 между ботом и пользователем, групповым чатом или каналом в команде. Таким образом, если приложение отправляет по одному сообщению бота каждому пользователю, ограничение потока не затормажается.

>[!NOTE]
> * Ограничение потока в 3600 секунд и 1800 операций применяется только в том случае, если несколько сообщений бота отправляются одному пользователю. 
> * Глобальное ограничение для каждого клиента — 50 запросов в секунду (RPS). Таким образом, общее число сообщений бота в секунду не должно пересекать ограничение потока.
> * Разделение сообщений на уровне службы приводит к большему, чем ожидалось, RPS. Если вас беспокоит приближение к ограничениям, необходимо реализовать стратегию [обратного выхода.](#backoff-example) Значения, предоставляемые в этом разделе, являются только для оценки.

В следующей таблице содержится ограничение для каждого бота на поток:

| Сценарий | Период времени в секундах | Максимально допустимые операции |
| --- | --- | --- |
| Отправка в беседу | 1 | 7  |
| Отправка в беседу | 2 | 8  |
| Отправка в беседу | 30 | 60 |
| Отправка в беседу | 3600 | 1800 |
| Создание беседы | 1 | 7  |
| Создание беседы | 2 | 8  |
| Создание беседы | 30 | 60 |
| Создание беседы | 3600 | 1800 |
| Получить участников беседы| 1 | 14  |
| Получить участников беседы| 2 | 16  |
| Получить участников беседы| 30 | 120 |
| Получить участников беседы| 3600 | 3600 |
| Получать беседы | 1 | 14  |
| Получать беседы | 2 | 16  |
| Получать беседы | 30 | 120 |
| Получать беседы | 3600 | 3600 |

>[!NOTE]
> Предыдущие версии и `TeamsInfo.getMembers` `TeamsInfo.GetMembersAsync` API отстают. Они отлаговываются до пяти запросов в минуту и возвращают не более 10 000 участников на каждую команду. Чтобы обновить SDK bot Framework и код для использования последних конечных точек API с paginated, см. в рубрике Изменения API bot для членов команды и [чата.](../../resources/team-chat-member-api-changes.md)

Вы также можете обрабатывать ограничение скорости с помощью ограничения потока для всех ботов.

## <a name="per-thread-limit-for-all-bots"></a>Ограничение потока для всех ботов

Ограничение потока для всех ботов контролирует трафик, который всем ботам разрешено создавать в одном диалоге. Беседа здесь 1:1 между ботом и пользователем, групповой чат или канал в команде.

В следующей таблице содержится ограничение потока для всех ботов:

| Сценарий | Период времени в секундах | Максимально допустимые операции |
| --- | --- | --- |
| Отправка в беседу | 1 | 14  |
| Отправка в беседу | 2 | 16  |
| Создание беседы | 1 | 14  |
| Создание беседы | 2 | 16  |
| Создание беседы| 1 | 14  |
| Создание беседы| 2 | 16  |
| Получить участников беседы| 1 | 28 |
| Получить участников беседы| 2 | 32 |
| Получать беседы | 1 | 28 |
| Получать беседы | 2 | 32 |

## <a name="next-step"></a>Следующий этап

> [!div class="nextstepaction"]
> [Боты для звонков и собраний](~/bots/calls-and-meetings/calls-meetings-bots-overview.md)

