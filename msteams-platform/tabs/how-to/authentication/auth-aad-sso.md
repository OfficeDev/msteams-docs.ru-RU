---
title: Поддержка единого входов для вкладок
description: Описывает единый вход (SSO)
ms.topic: how-to
keywords: API единого входного AAD для проверки подлинности teams
ms.openlocfilehash: 72fbafe49e021b0cc23dcdaeee7eb5fe82ee23de
ms.sourcegitcommit: b99ed616db734371e4af4594b7e895c5b05737c3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/09/2021
ms.locfileid: "50162889"
---
# <a name="single-sign-on-sso-support-for-tabs"></a>Поддержка единого входов (SSO) для вкладок

Пользователи могут войти в Microsoft Teams с помощью своей работы, учебного заведения или учетных записей Майкрософт (Office 365, Outlook и т. д.). Вы можете воспользоваться этим, разрешив единый вход для авторизации вкладки Microsoft Teams (или модуля задач) на настольных компьютерах или мобильных клиентах. Таким образом, если пользователь соглашается использовать ваше приложение, он не должен будет повторно согласиться на другое устройство — он будет автоматически входить. Кроме того, мы предварительно загружаем маркер доступа, чтобы повысить производительность и время загрузки.

> [!NOTE]
> **Версии мобильных клиентов Teams, поддерживающие SSO**  
>
> ✔Темы для Android (1416/1.0.0.2020073101 и более поздних версий)
>
> ✔Темы для iOS (_версия_: 2.0.18 и более поздние)  
>
> Для лучшего использования Teams используйте последнюю версию iOS и Android.

> [!NOTE]
> **Быстрый запуск**  
>
> Самый простой путь к началу работы с SSO табули с помощью microsoft Teams набор средств для Visual Studio кода. [Подробнее](../../../toolkit/visual-studio-code-tab-sso.md)

## <a name="how-sso-works-at-runtime"></a>Принцип работы единого входа во время выполнения

На следующей схеме показано, как работает процесс SSO:

<!-- markdownlint-disable MD033 -->
<img src="~/assets/images/tabs/tabs-sso-diagram.png" alt="Tab single sign-on SSO diagram" width="75%"/>

1. На вкладке выполнен вызов `getAuthToken()` JavaScript. Это сообщает Teams, что необходимо получить маркер проверки подлинности для приложения вкладок.
2. Если текущий пользователь впервые использовал ваше приложение табуляции, будет предложено согласиться (если требуется согласие) или обработать проверку подлинности по мере необходимости (например, двух-факторную проверку подлинности).
3. Teams запрашивает маркер приложения табули из конечной точки Azure AD для текущего пользователя.
4. Azure AD отправляет маркер приложения табули в приложение Teams.
5. Teams отправляет маркер приложения табули на вкладку как часть объекта результата, возвращенного `getAuthToken()` вызовом.
6. Маркер будет разбор в приложении вкладок с помощью JavaScript для извлечения необходимых сведений, например адреса электронной почты пользователя.

> [!NOTE]
> Допустимо только для согласия на ограниченный набор API на уровне пользователя ( электронная почта, профиль, offline_access и OpenId), а не для других областей Microsoft Graph, таких как `getAuthToken()` `User.Read` или `Mail.Read` . Рекомендуемые обходные пути, если требуются дополнительные области Graph, см. в нашем разделе [в конце этого документа.](#apps-that-require-additional-microsoft-graph-scopes)

API SSO также будет работать в модулях [задач,](../../../task-modules-and-cards/what-are-task-modules.md) встраив веб-содержимое.

## <a name="develop-an-sso-microsoft-teams-tab"></a>Разработка вкладки "SSO Microsoft Teams"

В этом разделе описываются задачи, связанные с созданием вкладки Teams, использующей SSO. Здесь описаны такие задачи, как язык и структура, не зависит от языка и структуры.

### <a name="1-create-your-azure-active-directory-azure-ad-application"></a>1. Создайте приложение Azure Active Directory (Azure AD)

#### <a name="registering-your-application-in-theazure-ad-portal-overview"></a>Регистрация приложения на[портале Azure AD:](https://azure.microsoft.com/features/azure-portal/)

1. Получите свой [ИД приложения Azure AD.](/azure/active-directory/develop/howto-create-service-principal-portal#get-values-for-signing-in)
2. Укажите разрешения, необходимые приложению для конечной точки Azure AD и,при желании, Microsoft Graph.
3. [Предоставление разрешений для](/azure/active-directory/develop/howto-create-service-principal-portal#configure-access-policies-on-resources) классических, веб-и мобильных приложений Teams.
4. Предварительно авторизуйте Teams,  нажать кнопку "Добавить область" и в открываемой панели введите `access_as_user` имя **области.**

> [!NOTE]
> Следует помнить о некоторых важных ограничениях:
>
> * Мы поддерживаем только разрешения API Microsoft Graph на уровне пользователя, то есть электронную почту, профиль, offline_access, OpenId. Если вам нужен доступ к другим областьм Microsoft Graph (например, или к ним), см. рекомендуемое решение в конце `User.Read` `Mail.Read` этой документации. [](#apps-that-require-additional-microsoft-graph-scopes)
> * Важно, чтобы имя домена приложения было таким же, как доменное имя, которое вы зарегистрировали для приложения Azure AD.
> * В настоящее время мы не поддерживаем несколько доменов для каждого приложения.
> * Мы не поддерживаем приложения, которые используют домен, так как он слишком распространен и может быть `azurewebsites.net` угрозой безопасности. Однако мы активно стремимся снять это ограничение.

#### <a name="registering-your-app-through-the-azure-active-directory-portal-in-depth"></a>Подробно зарегистрируйте свое приложение на портале Azure Active Directory:

1. Зарегистрируйте новое приложение на [портале Регистрации приложений Azure Active Directory.](https://go.microsoft.com/fwlink/?linkid=2083908)
2. Выберите **новую регистрацию** и *зарегистрируйте на странице приложения* следующие значения:
    * **Задайте** имя приложения.
    * Выберите **поддерживаемые типы учетных** записей (любой тип учетной записи будет работать) ¹
    * Оставьте поле **URI перенаправления** пустым.
    * Нажмите кнопку **Зарегистрировать**.
3. На странице обзора скопируйте и сохраните ИД приложения **(клиента).** Оно понадобится вам позже при обновлении манифеста приложения Teams.
4. В разделе **Управление** выберите **Предоставление API**. 
5. Выберите **ссылку "Установить",** чтобы создать URI для ИД приложения в виде `api://{AppID}` . Вставьте полное доменное имя (с косой чертой "/" в конце) между двойной косой чертой и GUID. Весь ИД должен иметь форму: `api://fully-qualified-domain-name.com/{AppID}` 1
    * ex: `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` .
    
    Полное доменное имя — это понятное человеку доменное имя, из которого обслуживается ваше приложение. Если вы используете службу туннелинга, например ngrok, вам потребуется обновлять это значение при изменениях поддомена ngrok. 
6. Нажмите кнопку **Добавить область**. В открывшейся панели введите `access_as_user` в качестве параметра **Имя области**.
7. Кому **можно дать согласие?**`Admins and users`
8. Заполните поля для настройки запроса согласия администратора и пользователя значениями, подходящими для `access_as_user` области:
    * **Заголовок согласия администратора:** Teams может получить доступ к профилю пользователя.
    * **Описание согласия администратора:** позволяет Teams вызывать веб-API приложения в качестве текущего пользователя.
    * **Название согласия пользователя:** Teams может получать доступ к профилю пользователя и делать запросы от имени пользователя.
    * **Описание согласия пользователя:** В teams можно вызывать API этого приложения с правами пользователя.
9. **Убедитесь, что** установлено состояние **"Включено"**
10. Выберите **кнопку "Добавить область"** для сохранения 
    * Доменная часть  имени области, отображаемая сразу под текстовым полем, должна автоматически совпадать с **URI-** именем приложения, заданным на предыдущем шаге, и в конце: `/access_as_user`
        * `api://subdomain.example.com/00000000-0000-0000-0000-000000000000/access_as_user`
11. В разделе **"Авторизованные** клиентские приложения" определите приложения, которые необходимо авторизировать для веб-приложения приложения. Выберите *"Добавить клиентские приложения".* Введите каждый из следующих ИД клиента и выберите авторизованную область, созданную на предыдущем шаге:
    * `1fec8e78-bce4-4aaf-ab1b-5451cc387264` (Мобильное или настольное приложение Teams)
    * `5e3ce6c0-2b1f-4285-8d4b-75ee78787346` (Веб-приложение Teams)
12. Перейдите **к разрешениям API.** Выберите *"Добавить разрешения microsoft*  >  *Graph*  >  *Delegated permissions",* а затем добавьте следующие разрешения из API Microsoft Graph:
    * User.Read (включен по умолчанию)
    * email
    * offline_access
    * OpenId
    * profile

13. Переход к **проверке подлинности**

    Если приложению не предоставлено согласие ИТ-администратора, пользователям придется предоставить согласие при первом использовании приложения.

    За установите URI перенаправления:
    * Выберите **"Добавить платформу".**
    * Выберите **"Интернет"**.
    * Введите **URI перенаправления** для вашего приложения. На этой странице успешный неявный поток предоставления перенаправляет пользователя. Это будет то же полное доменное имя, которое вы ввели на шаге 5, за которым следует маршрут API, куда должен быть отправлен ответ проверки подлинности. Если вы следуете любому из примеров Teams, это будет: `https://subdomain.example.com/auth-end`

    Затем в включить неявное предоставление, проверив следующие поля:  
    ✔ ID Token  
    ✔ доступа  
    
Поздравляем! Вы выполнили необходимые условия для регистрации приложения, чтобы продолжить работу с приложением с SSO-приложением tab.     

> [!NOTE]
>
> * ¹ Если ваше приложение Azure AD  зарегистрировано в том же клиенте, где вы делаете запрос на проверку подлинности в Teams, пользователь не получит запрос на согласие и сразу получит маркер доступа. Пользователям необходимо согласиться на эти разрешения, только если приложение Azure AD зарегистрировано в другом клиенте.
> * 1 Если вы получите сообщение об ошибке, указывав, что домен уже принадлежит вам и вы владелец, выполните процедуру на кратком примере: добавьте пользовательское имя домена в [Azure Active Directory](/azure/active-directory/fundamentals/add-custom-domain) для регистрации домена, а затем повторите шаг 5 выше. (Эта ошибка также может возникнуть, если вы не вошел с помощью учетных данных администратора в области аренды Office 365).
> * Если вы не получаете имя upn (имя-пользователя) в возвращенном маркере доступа, вы можете добавить его как необязательное утверждение [в](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) Azure AD.

### <a name="2-update-your-microsoft-teams-application-manifest"></a>2. Обновление манифеста приложения Microsoft Teams

Добавьте новые свойства в манифест Microsoft Teams:

* **WebApplicationInfo —** родительский элемент следующих элементов:

> [!div class="checklist"]
> * **id** — ИД клиента приложения. Это ИД приложения, полученный при регистрации приложения в Azure AD.
>* **resource** — домен и поддомен приложения. Это тот же URI (включая протокол), который вы зарегистрировали при создании на `api://` `scope` шаге 6 выше. Не следует включать путь `access_as_user` в ресурс. Доменная часть этого URI должна соответствовать домену, в том числе поддоменам, используемым в URL-адресах манифеста приложения Teams.

```json
"webApplicationInfo": {
  "id": "00000000-0000-0000-0000-000000000000",
  "resource": "api://subdomain.example.com/00000000-0000-0000-0000-000000000000"
}
```

> [!NOTE]
>
>* Ресурс приложения AAD обычно является корневым url-адресом сайта и appID (например, `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` ). Мы также используем это значение, чтобы убедиться, что ваш запрос приходит из того же домена. Поэтому убедитесь, что вкладка использует те же домены, что `contentURL` и свойство ресурса.
>* Для реализации поля необходимо использовать манифест версии 1.5 или `webApplicationInfo` выше.

### <a name="3-get-an-authentication-token-from-your-client-side-code"></a>3. Получите маркер проверки подлинности из клиентского кода

Вот как выглядит API проверки подлинности:

```javascript
var authTokenRequest = {
  successCallback: function(result) { console.log("Success: " + result); },
  failureCallback: function(error) { console.log("Failure: " + error); }
};
microsoftTeams.authentication.getAuthToken(authTokenRequest);
```

Когда вы звоните и требуется дополнительное согласие пользователя (для разрешений на уровне пользователя), пользователю будет покажите диалоговое окно с запросом на предоставление `getAuthToken` дополнительного согласия. 

Получив маркер доступа в ответе на успешный вызов, вы можете декодировать маркер доступа, чтобы просмотреть утверждения, связанные с этим маркером. (При желании вы можете вручную скопировать или вкопировать [](https://jwt.io/) маркер доступа в средство, например JWT.io для проверки его содержимого). Если вы не получаете имя upn (имя-пользователя) в возвращенном маркере доступа, вы можете добавить его как необязательное утверждение [в](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) Azure AD.

<p>
    <img src="~/assets/images/tabs/tabs-sso-prompt.png" alt="Tab single sign-on SSO dialog prompt" width="75%"/>
</p>

## <a name="code-sample"></a>Пример кода

|**Имя примера**|**Описание**|**C#**|**TypeScript**|
|---------------|---------------|------|--------------|
| Tab SSO |Пример приложения Microsoft Teams для вкладки Azure AD SSO| [View](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/tab-sso/csharp)|[View](https://github.com/OfficeDev/Microsoft-Teams-Samples/blob/main/samples/tab-sso/nodejs), </br>[Teams набор средств](../../../toolkit/visual-studio-code-tab-sso.md)|

## <a name="known-limitations"></a>Известные ограничения

### <a name="apps-that-require-additional-microsoft-graph-scopes"></a>Приложения, которые требуют дополнительных областей Microsoft Graph

Наша текущая реализация для SSO предоставляет согласие только на разрешения на уровне пользователя ( электронная почта, профиль, offline_access, OpenId), а не для других API (например, User.Read или Mail.Read). Если вашему приложению необходимы дополнительные области Microsoft Graph, вот несколько включающих обходных пути:

#### <a name="tenant-admin-consent"></a>Согласие администратора клиента

Самый простой подход — получить предварительное согласие администратора клиента от имени организации. Это означает, что пользователям не придется соглашаться на использование этих областей, и вы сможете свободно обмениваться данными на стороне сервера маркеров с помощью потока "от имени" Azure [AD.](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow) Это решение приемлемо для внутренних бизнес-приложений, но может быть недостаточно для сторонних разработчиков, которые могут не иметь возможности полагаться на утверждение администратора клиента.

Простой способ получения согласия от имени организации (как администратор клиента) — посетить:

* `https://login.microsoftonline.com/common/adminconsent?client_id=<AAD_App_ID>`

#### <a name="asking-for-additional-consent-using-the-auth-api"></a>Запрос дополнительного согласия с помощью API проверки

Другой подход для получения дополнительных областей Microsoft Graph — представить диалоговое окно согласия с использованием существующего веб-подхода к проверке подлинности [Azure AD,](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-popup-page) который включает создание диалоговое окно согласия Azure AD. Существуют некоторые важные дополнения:

1. Чтобы получить доступ к этим дополнительным API Microsoft Graph, маркер, полученный с помощью сервера, должен быть exchanged на стороне сервера с помощью потока Azure AD от `getAuthToken()` имени. [](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow)
    * Не забудьте использовать конечную точку Microsoft Graph v2 для этого exchange
2. В случае сбой обмена данными Azure AD возвратит недопустимое исключение предоставления. Обычно существует одно из двух сообщений об ошибке: `invalid_grant` или `interaction_required`
3. При сбойе обмена необходимо запросить дополнительное согласие. Мы рекомендуем показывать пользовательский интерфейс, запрашивая у пользователя дополнительное согласие. Этот пользовательский интерфейс должен включать кнопку, которая запускает диалоговое окно согласия Azure AD с помощью нашего API проверки подлинности [Azure AD.](~/concepts/authentication/auth-silent-aad.md)
4. При запросе дополнительного согласия от Azure AD необходимо включить в параметр `prompt=consent` [query-string-parameter](~/tabs/how-to/authentication/auth-silent-aad.md#get-the-user-context) в Azure AD, иначе Azure AD не будет запрашивать дополнительные области.
    * Вместо: `?scope={scopes}`
    * Используйте: `?prompt=consent&scope={scopes}`
    * Убедитесь, что включены все области, которые вы запросит у пользователя `{scopes}` (например, Mail.Read или User.Read).
5. После того как пользователь предоставил дополнительное разрешение, повторить попытку потока от имени, чтобы получить доступ к этим дополнительным API.

### <a name="non-azure-ad-authentication"></a>Проверка подлинности, не относячная к Azure AD

Вышеуказанное решение проверки подлинности работает только для приложений и служб, которые поддерживают Azure AD в качестве поставщика удостоверений. Приложения, которые хотят проверить подлинность с помощью служб, не использующих Azure AD, должны продолжать использовать всплывающий поток [веб-проверки подлинности.](~/concepts/authentication.md)

> [!NOTE] 
> SSO поддерживается для приложений, которые принадлежат клиенту, в клиентах B2C Azure AD.
