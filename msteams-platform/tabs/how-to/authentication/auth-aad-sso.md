---
title: Поддержка единого входного знака для вкладок
description: Описывает один вход (SSO)
ms.topic: how-to
localization_priority: Normal
keywords: группы проверки подлинности SSO AAD единого api для входов
ms.openlocfilehash: 65e8d5e5387ec727e9ce02967516d8672bf67931
ms.sourcegitcommit: 825abed2f8784d2bab7407ba7a4455ae17bbd28f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/26/2021
ms.locfileid: "52019610"
---
# <a name="single-sign-on-sso-support-for-tabs"></a>Поддержка единого входного знака (SSO) для вкладок

Пользователи впишутся в Microsoft Teams через свои учетные записи, в том числе Office 365, Outlook и так далее. Вы можете воспользоваться этим, разрешив одному входу авторизировать вкладку Teams или модуль задач на настольных компьютерах или мобильных клиентах. Если пользователь соглашается использовать ваше приложение, он не должен снова соглашаться на другое устройство, так как он подписан автоматически. Кроме того, маркер доступа предварительно загружен для повышения производительности и времени загрузки.

> [!NOTE]
> **Команды мобильных клиентских версий, поддерживающих SSO**  
>
> ✔Teams для Android (1416/1.0.0.2020073101 и более поздней версии)
>
> ✔Teams для iOS _(Версия_: 2.0.18 и более поздней версии)  
>
> Чтобы лучше работать с Teams, используйте последнюю версию iOS и Android.

> [!NOTE]
> **Быстрый запуск**  
>
> Самый простой путь к началу работы с SSO вкладки — это набор средств Teams для Visual Studio Code. Дополнительные сведения см. в [тексте SSO с набором](../../../toolkit/visual-studio-code-tab-sso.md) инструментов Teams и Visual Studio кода для вкладок

## <a name="how-sso-works-at-runtime"></a>Принцип работы единого входа во время выполнения

На следующем изображении показано, как работает процесс SSO:

<!-- markdownlint-disable MD033 -->
<img src="~/assets/images/tabs/tabs-sso-diagram.png" alt="Tab single sign-on SSO diagram" width="75%"/>

1. На вкладке выполнен вызов JavaScript для `getAuthToken()` . Это указывает Teams на получение маркера проверки подлинности для приложения вкладки.
2. Если это первый раз, когда текущий пользователь использовал приложение вкладки, есть запрос на согласие, если требуется согласие или обработка этапной проверки подлинности, например двух факторов проверки подлинности.
3. Teams запрашивает маркер приложения вкладок из конечной точки Azure Active Directory (AAD) для текущего пользователя.
4. AAD отправляет маркер приложения вкладок в приложение Teams.
5. Teams отправляет маркер приложения вкладок на вкладку как часть объекта результатов, возвращаемого `getAuthToken()` вызовом.
6. Маркер разборается в приложении вкладок с помощью JavaScript для извлечения необходимых сведений, например адреса электронной почты пользователя.

> [!NOTE]
> Допустимо только для согласия на ограниченный набор API на уровне пользователя, который является электронной почтой, профилем, offline_access `getAuthToken()` и OpenId. Он не используется для дополнительных областей Graph, таких как `User.Read` или `Mail.Read` . Дополнительные области Graph см. в предлагаемых [обходных решениях.](#apps-that-require-additional-graph-scopes)

API SSO также работает в [модулях задач,](../../../task-modules-and-cards/what-are-task-modules.md) встраив веб-контент.

## <a name="develop-an-sso-microsoft-teams-tab"></a>Разработка вкладки SSO Microsoft Teams

В этом разделе описываются задачи, связанные с созданием вкладки Teams, использующей SSO. Эти задачи являются языковыми и framework-agnostic.

### <a name="1-create-your-aad-application"></a>1. Создание приложения AAD

**Регистрация приложения в обзоре [портала AAD](https://azure.microsoft.com/features/azure-portal/)**

1. Получите [AAD-ID приложения.](/azure/active-directory/develop/howto-create-service-principal-portal#get-values-for-signing-in)
2. Укажите разрешения, необходимые приложению для конечной точки AAD и, необязательно, Graph.
3. [Предоставление разрешений](/azure/active-directory/develop/howto-create-service-principal-portal#configure-access-policies-on-resources) для настольных, веб-приложений и мобильных приложений Teams.
4. Предварительно уполномозить Teams, выбрав кнопку **Добавить** область и в открываемой **панели** введите access_as_user в качестве **имени Scope.**

> [!NOTE]
> Необходимо знать несколько важных ограничений:
>
> * Поддерживаются только разрешения API графа на уровне пользователей, то есть электронная почта, профиль, offline_access, OpenId. Если вы должны иметь доступ к другим сферам Graph, таким как или `User.Read` `Mail.Read` , см. [рекомендуемое обходное решение.](#apps-that-require-additional-graph-scopes)
> * Важно, чтобы доменное имя вашего приложения было таким же, как и доменное имя, которое вы зарегистрировали для приложения AAD.
> * В настоящее время несколько доменов в приложении не поддерживаются.

**Регистрация приложения на портале AAD**

1. Регистрация нового приложения на портале регистрации приложений [AAD.](https://go.microsoft.com/fwlink/?linkid=2083908)
2. Выберите **новую регистрацию.** Появится **страница "Регистрация** приложения".
3. На странице **Регистрация приложения** введите следующие значения:
    1. Введите **имя** приложения.
    2. Выберите **поддерживаемые типы учетных записей,** выберите один клиент или многотенантный тип учетной записи. ¹
    * Оставьте поле **URI перенаправления** пустым.
    3. Нажмите кнопку **Зарегистрировать**.
4. На странице обзор скопируйте и сохраните ID приложения **(клиента).** Она должна быть позднее при обновлении манифеста приложения Teams.
5. В разделе **Управление** выберите **Предоставление API**.
6. Выберите **ссылку Set** для создания URI ID приложения в виде `api://{AppID}` . Вставьте полностью квалифицированное доменное имя с переназначенной чертой "/" с добавлением до конца между двойными полосами вперед и GUID. Весь ID должен иметь форму `api://fully-qualified-domain-name.com/{AppID}` . ² Например, `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` . Полностью квалифицированное доменное имя — это доступное для чтения имя домена, из которого обслуживается ваше приложение. Если вы используете службу тоннелей, например ngrok, необходимо обновить это значение всякий раз, когда изменяется поддомен ngrok.
7. Выберите **Добавить область**. На открываемой панели **введите access_as_user** имя **Scope**.
8. В поле **Кто может дать согласие?** введите **администраторов и пользователей**.
9. Введите сведения в полях для настройки подсказок согласия администратора и пользователя со значениями, подходящими для `access_as_user` области:
    * **Название согласия администратора:** Команды могут получить доступ к профилю пользователя.
    * **Описание согласия администратора.** Команды могут вызывать веб-API приложения в качестве текущего пользователя.
    * **Название согласия пользователя.** Команды могут получать доступ к вашему профилю и делать запросы от вашего имени.
    * **Описание согласия пользователя:** Команды могут вызывать API этого приложения с тем же правами, что и у вас.
10. Убедитесь, что параметру **Состояние** присвоено значение **Включено**.
11. Выберите **Добавить область,** чтобы сохранить сведения. Доменная часть имени **Scope,** отображаемая ниже текстового поля, должна автоматически соответствовать набору URI **ID** приложения на предыдущем шаге с приложением до `/access_as_user` `api://subdomain.example.com/00000000-0000-0000-0000-000000000000/access_as_user` конца.
12. В разделе **Авторизованные клиентские приложения** определите приложения, которые необходимо авторизировать для веб-приложения вашего приложения. Выберите **Добавление клиентского приложения.** Введите каждый из следующих клиентских ИД и выберите авторизованную область, созданную на предыдущем шаге:
    * `1fec8e78-bce4-4aaf-ab1b-5451cc387264` для мобильного или настольного приложения Teams.
    * `5e3ce6c0-2b1f-4285-8d4b-75ee78787346` для веб-приложения Teams.
13. Перейдите **к разрешениям API.** Выберите **Добавить**  >  **разрешения, делегированные Microsoft Graph,** а затем добавьте следующие разрешения  >  из API Graph:
    * User.Read включен по умолчанию
    * email
    * offline_access
    * OpenId
    * profile

14. Переход к **проверке подлинности.**

    Если приложению не было предоставлено согласие ИТ-администратора, пользователи должны предоставить согласие при первом использовании приложения.

    Чтобы ввести URI перенаправления:
    * Выберите **Добавить платформу.**
    * Выберите **веб.**
    * Введите **URI перенаправления** для приложения. Это страница, на которой успешный неявный поток грантов перенаправляет пользователя. Это то же полное доменное имя, которое вы ввели на шаге 5, а затем маршрут API, куда отправляется ответ на проверку подлинности. Если вы следуете примеру Teams, это `https://subdomain.example.com/auth-end` .

    Включить неявный грант, проверив следующие поля: ✔ маркера ID ✔ Access Token

Поздравляем! Вы выполнили необходимые условия регистрации приложений для работы с приложением SSO вкладки.

> [!NOTE]
>
> * ¹ Если ваше приложение AAD зарегистрировано в том же клиенте, где вы делаете запрос на проверку подлинности в Teams, пользователю не может быть предложено дать согласие и ему сразу же будет предоставлен маркер доступа. Пользователи соглашаются на эти разрешения только в том случае, если приложение AAD зарегистрировано в другом клиенте.
> * ² Если настраиваемый домен не добавлен в AAD, вы получите ошибку, указывав, что имя хост не должно основываться на уже собственном домене. Чтобы добавить настраиваемый домен в AAD и зарегистрировать его, выполните добавление пользовательского доменного имени в процедуру [AAD,](/azure/active-directory/fundamentals/add-custom-domain) а затем повторите шаг 5. Вы также можете получить эту ошибку, если вы не подписаны с учетными данными администратора в аренде Office 365.
> * Если вы не получаете основное имя пользователя (UPN)) в маркере возвращенного доступа, вы можете добавить его в качестве необязательных утверждений [в](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) AAD.

### <a name="2-update-your-teams-application-manifest"></a>2. Обновление манифеста приложения Teams

Чтобы добавить новые свойства в манифест Teams, используйте следующий код:

```json
"webApplicationInfo": {
  "id": "00000000-0000-0000-0000-000000000000",
  "resource": "api://subdomain.example.com/00000000-0000-0000-0000-000000000000"
}
```

* **WebApplicationInfo** является родителем следующих элементов:

> [!div class="checklist"]
> * **id** — ID клиента приложения. Это ИД приложения, полученный в рамках регистрации приложения в Azure AD.
>* **ресурс** — домен и поддомен приложения. Это тот же URI (включая протокол), который вы зарегистрировали при создании вашего шага `api://` `scope` 6. Не следует включать путь `access_as_user` в ресурс. Доменная часть этого URI должна соответствовать домену, в том числе любым поддоменам, используемым в URL-адресах манифеста приложения Teams.

> [!NOTE]
>
>* Ресурс приложения AAD обычно является корнем URL-адреса сайта и приложения `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` (например). Это значение также используется для обеспечения того, чтобы ваш запрос был исходя из того же домена. Убедитесь, `contentURL` что вкладка использует те же домены, что и свойство ресурса.
>* Для реализации поля необходимо использовать манифестную версию 1.5 или `webApplicationInfo` более.

### <a name="3-get-an-authentication-token-from-your-client-side-code"></a>3. Получите маркер проверки подлинности из клиентского кода

Используйте следующий API проверки подлинности:

```javascript
var authTokenRequest = {
  successCallback: function(result) { console.log("Success: " + result); },
  failureCallback: function(error) { console.log("Failure: " + error); }
};
microsoftTeams.authentication.getAuthToken(authTokenRequest);
```

Когда вы звоните , и для получения разрешений на уровне пользователя требуется дополнительное согласие пользователя, пользователю отображается диалоговое окно для `getAuthToken` предоставления дополнительного согласия.

После получения маркера доступа в вызове успешного вызова можно расшифровать маркер доступа для просмотра утверждений, связанных с этим маркером. Необязательно можно вручную скопировать и вклеить маркер доступа [](https://jwt.ms/) в средство, например jwt.ms для проверки его содержимого. Если вы не получаете upN в маркере возвращенного доступа, вы можете добавить его в качестве необязательных [утверждений](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) в AAD.

<p>
    <img src="~/assets/images/tabs/tabs-sso-prompt.png" alt="Tab single sign-on SSO dialog prompt" width="75%"/>
</p>

## <a name="code-sample"></a>Пример кода

|**Пример имени**|**Описание**|**C#**|**Node.js**|
|---------------|---------------|------|--------------|
| Tab SSO |Пример приложения Microsoft Teams для вкладок Azure AD SSO| [View](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/tab-sso/csharp)|[Просмотр](https://github.com/OfficeDev/Microsoft-Teams-Samples/blob/main/samples/tab-sso/nodejs), </br>[Teams набор средств](../../../toolkit/visual-studio-code-tab-sso.md)|

## <a name="known-limitations"></a>Известные ограничения

### <a name="apps-that-require-additional-graph-scopes"></a>Приложения, которые требуют дополнительных областей Graph

Наша текущая реализация для SSO предоставляет согласие только для разрешений на уровне пользователей, таких как электронная почта, профиль, offline_access, OpenId, а не для других API, таких как User.Read или Mail.Read. Если вашему приложению необходимы дополнительные области Graph, в следующем разделе предусмотрены некоторые разрешимые обходные пути.

#### <a name="tenant-admin-consent"></a>Согласие администратора клиента

Самый простой подход — получить предварительное согласие администратора клиента от имени организации. Это означает, что пользователям не нужно соглашаться на эти области, и вы можете [](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow)свободно обмениваться стороной сервера маркеров с помощью потока от имени AAD. Это решение приемлемо для внутренних бизнес-приложений, но недостаточно для сторонних разработчиков, которые не могут полагаться на утверждение администратора клиента.

Простой способ согласия от имени организации в качестве администратора клиента — обратиться к `https://login.microsoftonline.com/common/adminconsent?client_id=<AAD_App_ID>` .

#### <a name="ask-for-additional-consent-using-the-auth-api"></a>Запрос дополнительного согласия с помощью API Auth

Другой подход для получения дополнительных областей Graph заключается в том, чтобы представить диалоговое окно согласия с помощью существующего веб-подхода проверки подлинности [Azure AD,](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-popup-page) который включает в себя создание диалогового окна согласия Azure AD. 

**Запрос дополнительного согласия с помощью API Auth**

1. Полученный с помощью маркера маркер должен быть обменяно на стороне сервера с помощью AAD от имени потока, чтобы получить доступ к этим дополнительным `getAuthToken()` API Graph. [](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow) Убедитесь, что для этого обмена используется конечная точка v2 Graph.
2. В случае сбой обмена AAD возвращает недействительные исключения гранта. Обычно существует одно из двух сообщений об ошибке или `invalid_grant` `interaction_required` .
3. В случае сбой обмена необходимо получить дополнительное согласие. Покажите какой-либо пользовательский интерфейс (пользовательский интерфейс) с просьбой предоставить дополнительное согласие. Этот пользовательский интерфейс должен включать кнопку, которая запускает диалоговое окно согласия AAD с помощью [AAD API проверки подлинности.](~/concepts/authentication/auth-silent-aad.md)
4. При запросе дополнительного согласия от AAD необходимо включить в AAD параметр `prompt=consent` [query-string-parameter,](~/tabs/how-to/authentication/auth-silent-aad.md#get-the-user-context) в противном случае AAD не запрашивает дополнительные области.
    * Вместо `?scope={scopes}`
    * Используйте это `?prompt=consent&scope={scopes}`
    * Убедитесь, что включает все области, которые вы подсказывая `{scopes}` пользователю, например, Mail.Read или User.Read.
5. После предоставления пользователем дополнительных разрешений повторно обнажь поток от имени, чтобы получить доступ к этим дополнительным API.

### <a name="non-aad-authentication"></a>Проверка подлинности без AAD

Вышеуказанное решение проверки подлинности работает только для приложений и служб, поддерживаюющих AAD в качестве поставщика удостоверений. Приложения, которые хотят проверить подлинность с помощью служб, не использующих AAD, должны продолжать использовать поток веб-проверки подлинности на основе всплывающих [данных.](~/concepts/authentication.md)

> [!NOTE]
> SSO поддерживается для приложений, которые принадлежат клиентам в клиентах AAD B2C.
