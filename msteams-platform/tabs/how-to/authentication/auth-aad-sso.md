---
title: Поддержка единого входа для вкладок
description: Описание единого входа (SSO)
keywords: API единого входа для проверки подлинности Teams AAD
ms.openlocfilehash: 9691c4190697b3f53a9ce76921375101e762263a
ms.sourcegitcommit: 64acd30eee8af5fe151e9866c13226ed3f337c72
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "49346793"
---
# <a name="single-sign-on-sso-support-for-tabs"></a>Поддержка единого входа (SSO) для вкладок

Пользователи входят в Microsoft Teams с помощью рабочих, учебных заведений или учетных записей Майкрософт (Office 365, Outlook и т. д.). Вы можете воспользоваться этой возможностью, разрешая единый вход для авторизации вкладки Microsoft Teams (или модуля задач) на настольных или мобильных клиентах. Таким образом, если пользователь будет использовать ваше приложение, ему не придется доставлять свое согласие на другое устройство — они будут автоматически входить в систему. Кроме того, мы предоставим свой маркер доступа, чтобы увеличить производительность и время загрузки.

>[!NOTE]
> **Версии клиента Teams для мобильных устройств, поддерживающие единый вход**  
>
> ✔ Teams для Android (1416/1.0.0.2020073101 и более поздних версий)
>
> ✔ Teams для iOS (_версия_: 2.0.18 и более поздняя)  
>
> Для оптимальной работы с Teams используйте последнюю версию iOS и Android.

## <a name="how-sso-works-at-runtime"></a>Принцип работы единого входа во время выполнения

На следующей схеме показано, как работает процесс единого входа.

<!-- markdownlint-disable MD033 -->
<img src="~/assets/images/tabs/tabs-sso-diagram.png" alt="Tab single sign-on SSO diagram" width="75%"/>

1. На вкладке выполняется вызов JavaScript `getAuthToken()` . Это указывает Teams получить маркер проверки подлинности для приложения вкладки.
2. Если в первый раз текущий пользователь использовал вкладку приложения, будет выдаваться запрос на получение согласия (если требуется согласие) или обрабатывается поэтапная проверка подлинности (например, двухфакторная проверка подлинности).
3. Teams запрашивает маркер приложения Tab из конечной точки Azure AD для текущего пользователя.
4. Azure AD отправляет маркер приложения "Вкладка" приложению Teams.
5. Teams отправляет маркер приложения на вкладку в составе объекта результата, возвращенного `getAuthToken()` вызовом.
6. Маркер будет проанализирован в приложении Tab с помощью JavaScript, чтобы извлечь необходимые сведения, такие как адрес электронной почты пользователя.

> [!NOTE]
> `getAuthToken()`Допускается только для тех, кто может быть отправлен в ограниченный набор API уровня пользователя: Электронная почта, профиль, offline_access и OpenId, а не другие области Microsoft Graph, такие как `User.Read` или `Mail.Read` . Предлагаемые решения можно найти в конце этого документа, если вам нужны [Дополнительные области диаграммы](#apps-that-require-additional-microsoft-graph-scopes).

API единого входа также будет работать в [модулях задач](../../../task-modules-and-cards/what-are-task-modules.md) , которые внедряют веб-контент.

## <a name="develop-an-sso-microsoft-teams-tab"></a>Разработка вкладки Microsoft Teams единого входа

В этом разделе описываются задачи, связанные с созданием вкладок Teams, использующих единый вход. Описанные здесь задачи не зависят от языка и платформы.

### <a name="1-create-your-azure-active-directory-azure-ad-application"></a>1. Создание приложения Azure Active Directory (Azure AD)

#### <a name="registering-your-application-in-theazure-ad-portal-overview"></a>Регистрация приложения на[портале Azure AD](https://azure.microsoft.com/features/azure-portal/) Обзор:

1. Получение [идентификатора приложения Azure AD](/azure/active-directory/develop/howto-create-service-principal-portal#get-values-for-signing-in).
2. Укажите разрешения, необходимые вашему приложению для конечной точки Azure AD, и (при необходимости) Microsoft Graph.
3. [Предоставление разрешений](/azure/active-directory/develop/howto-create-service-principal-portal#configure-access-policies-on-resources) для настольных приложений, веб-приложений и мобильных приложений Teams.
4. Предварительная авторизация Teams, нажав кнопку **Добавить область** и на открывшейся панели, введите `access_as_user` **имя области**.

> [!NOTE]
> Вы должны знать о некоторых важных ограничениях:
>
> * Поддерживаются только разрешения API Microsoft Graph на уровне пользователя, например, электронная почта, профиль, offline_access, OpenId. Если вам требуется доступ к другим областям Microsoft Graph (например `User.Read` `Mail.Read` , или), ознакомьтесь с [рекомендуемым обходным способом](#apps-that-require-additional-microsoft-graph-scopes) в конце этой документации.
> * Важно, чтобы доменное имя вашего приложения совпадало с именем домена, зарегистрированным для вашего приложения Azure AD.
> * В настоящее время не поддерживается несколько доменов для каждого приложения.
> * Мы не поддерживаем приложения, использующие `azurewebsites.net` домен, так как он слишком распространен и может представлять угрозу безопасности. Однако мы активно используем, чтобы удалить это ограничение.

#### <a name="registering-your-app-through-the-azure-active-directory-portal-in-depth"></a>Подробное регистрация приложения с помощью портала Azure Active Directory:

1. Зарегистрируйте новое приложение в портале [регистрации приложений Azure Active Directory —](https://go.microsoft.com/fwlink/?linkid=2083908) .
2. Нажмите кнопку **создать регистрацию** и на *странице Регистрация приложения* задайте следующие значения:
    * Задайте **имя** приложения.
    * Выбор **поддерживаемых типов учетных записей** (любой тип учетной записи будет работать) ¹
    * Оставьте поле **URI перенаправления** пустым.
    * Нажмите кнопку **Зарегистрировать**.
3. На странице Обзор скопируйте и сохраните **идентификатор приложения (клиента)**. Он понадобится позже при обновлении манифеста приложения Teams.
4. В разделе **Управление** выберите **Предоставление API**. 
5. Выберите ссылку **задать** , чтобы создать URI идентификатора приложения в виде `api://{AppID}` . Вставьте полное доменное имя (с символом косой черты "/") между двумя косыми чертами и GUID. Весь идентификатор должен иметь вид: `api://fully-qualified-domain-name.com/{AppID}` ²
    * Пример: `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` .
    
    Полное доменное имя — это понятное для человека доменное имя, из которого обслуживается ваше приложение. Если вы используете службу туннелирования, такую как ngrok, вам потребуется обновить это значение при каждом изменении дочернего домена ngrok. 
6. Нажмите кнопку **Добавить область**. В открывшейся панели введите `access_as_user` в качестве параметра **Имя области**.
7. Как определить **, кому разрешено согласие?**`Admins and users`
8. Заполните поля для настройки приглашений администратора и согласия пользователя со значениями, подходящими для `access_as_user` области:
    * **Заголовок согласия администратора:** Teams может получить доступ к профилю пользователя.
    * **Описание согласия администратора**: позволяет Teams вызывать API приложения в качестве текущего пользователя.
    * **Заголовок согласия пользователя**: teams могут получать доступ к профилю пользователя и делать запросы от имени пользователя.
    * **Описание согласия пользователя:** Разрешите Teams вызывать API этого приложения с теми же правами, что и у пользователя.
9. Убедитесь, **State** что для параметра состояние **Включено значение включено** .
10. Нажмите кнопку **Добавить область** , чтобы сохранить 
    * Доменная часть **имени области** , отображаемая непосредственно под текстовым полем, должна автоматически СОПОСТАВЛЯТЬ URI **идентификатора приложения** , заданный на предыдущем шаге, с `/access_as_user` добавлением в конец:
        * `api://subdomain.example.com/00000000-0000-0000-0000-000000000000/access_as_user`
11. В разделе **Авторизованные клиентские приложения** Определите приложения, которые требуется авторизовать для веб-приложения приложения. Выберите *добавить клиентское приложение*. Введите каждый из следующих идентификаторов клиентов и выберите авторизованную область, созданную на предыдущем шаге:
    * `1fec8e78-bce4-4aaf-ab1b-5451cc387264` (Приложение Teams для мобильных устройств и настольных приложений)
    * `5e3ce6c0-2b1f-4285-8d4b-75ee78787346` (Веб-приложение Teams)
12. Перейдите к разделу **разрешения API**. Выберите *Добавить разрешение с*  >  *Microsoft Graph*  >  *делегированными разрешениями* Microsoft Graph, а затем добавьте следующие разрешения из API Microsoft Graph:
    * User. Read (включено по умолчанию)
    * рассылка
    * offline_access
    * OpenId
    * profile

13. Переход к **проверке подлинности**

    Если приложению не было предоставлено согласие администратора, пользователям потребуется предоставить согласие при первом использовании приложения.

    Задайте URI перенаправления:
    * Выберите **элемент добавить платформу**.
    * Выберите **веб**.
    * Введите **универсальный код ресурса (URI) перенаправления** для вашего приложения. Это будет страница, на которой успешный неявный поток предоставления перенаправит пользователя. Это будет одно и то же полное доменное имя, введенное на шаге 5, за которым следует маршрут API, в котором нужно отправить ответ на проверку подлинности. Если вы подписаны на один из примеров Teams, будут выполняться следующие действия: `https://subdomain.example.com/auth-end`

    Затем включите неявное предоставление, установив следующие флажки:  
    Маркер идентификатора ✔  
    Маркер доступа ✔  
    
Поздравляем! Вы выполнили необходимые условия регистрации приложений, чтобы перейти к приложению единого входа для вкладки.     

> [!NOTE]
>
> * ¹ если ваше приложение Azure AD зарегистрировано в Teams _, в_ котором вы размещаете запрос проверки подлинности в Teams, пользователю не будет предложено согласие, а маркер доступа будет выдан сразу. Пользователям необходимо только согласие с этими разрешениями, если приложение Azure AD зарегистрировано в другом клиенте.
> * ² при получении сообщения об ошибке, указывающей на то, что домен уже владеет и вы являетесь его владельцем, выполните процедуру, описанную в статье [Краткое руководство: Добавление настраиваемого имени домена в Azure Active Directory](/azure/active-directory/fundamentals/add-custom-domain) для регистрации домена, а затем повторите шаг 5. (Эта ошибка также может возникать, если вы не вошли в учетную запись администратора в Office 365.
> * Если имя участника-пользователя (имя участника-пользователя) не получено в возвращенном маркере доступа, его можно добавить в качестве [необязательного утверждения](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) в Azure AD.

### <a name="2-update-your-microsoft-teams-application-manifest"></a>2. Обновление манифеста приложения Microsoft Teams

Добавьте новые свойства в манифест Microsoft teams:

* **WebApplicationInfo** — родительский элемент следующих элементов:

> [!div class="checklist"]
> * **ID** — идентификатор клиента приложения. Это идентификатор приложения, полученный в ходе регистрации приложения с помощью Azure AD.
>* **Resource** — домен и поддомен приложения. Это тот же URI (включая `api://` протокол), который вы зарегистрировали при создании `scope` на шаге 6. Не следует включать `access_as_user` путь в ресурс. Доменная часть этого URI должна быть соотнесена с доменом, включая все поддомены, используемые в URL-адресах манифеста приложения Teams.

```json
"webApplicationInfo": {
  "id": "00000000-0000-0000-0000-000000000000",
  "resource": "api://subdomain.example.com/00000000-0000-0000-0000-000000000000"
}
```

> [!NOTE]
>
>* Ресурс для приложения AAD обычно является корнем URL-адреса сайта и appID (например, `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` ). Кроме того, мы используем это значение, чтобы убедиться, что ваш запрос поступает из того же домена. Поэтому убедитесь, что на `contentURL` вкладке используются те же домены, что и в свойстве ресурса.
>* Для реализации этого поля необходимо использовать манифест версии 1,5 или более поздней `webApplicationInfo` .

### <a name="3-get-an-authentication-token-from-your-client-side-code"></a>3. получение маркера проверки подлинности из клиентского кода

Вот как выглядит API проверки подлинности:

```javascript
var authTokenRequest = {
  successCallback: function(result) { console.log("Success: " + result); },
  failureCallback: function(error) { console.log("Failure: " + error); }
};
microsoftTeams.authentication.getAuthToken(authTokenRequest);
```

Если `getAuthToken` требуется согласие пользователя на вызовы (для разрешений на уровне пользователей), будет отображаться диалоговое окно, позволяющее пользователю предоставить дополнительное согласие. 

После получения маркера доступа в обратном вызове для успешного выполнения можно декодировать маркер доступа для просмотра утверждений, связанных с этим маркером. (При необходимости можно вручную скопировать или вставить маркер доступа в средство, например [JWT.IO](https://jwt.io/) , чтобы проверить его содержимое). Если имя участника-пользователя (имя участника-пользователя) не получено в возвращенном маркере доступа, его можно добавить в качестве [необязательного утверждения](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) в Azure AD.

<p>
    <img src="~/assets/images/tabs/tabs-sso-prompt.png" alt="Tab single sign-on SSO dialog prompt" width="75%"/>
</p>

## <a name="sample-code"></a>Пример кода

Посетите наш пример приложения: [Пример использования мстеамс на вкладках SSO — NodeJS](https://github.com/OfficeDev/msteams-tabs-sso-sample-nodejs)

В этом файле содержатся сведения о настройке среды разработки и настройке приложения в Azure AD. Кроме того, вы можете получить дополнительные сведения о том, как пример структурирован в [разделе Структура приложения](https://github.com/OfficeDev/msteams-tabs-sso-sample-nodejs#app-structure) , чтобы помочь вам ознакомиться с базой кода.

## <a name="known-limitations"></a>Известные ограничения

### <a name="apps-that-require-additional-microsoft-graph-scopes"></a>Приложения, для которых требуются дополнительные области Microsoft Graph

Наша текущая реализация SSO только предоставляет согласие на доступ на уровне пользователей: Электронная почта, профиль, offline_access, OpenId — не для других API (например, User. Read или mail. Read). Если ваше приложение нуждается в дальнейших областях Microsoft Graph, вот несколько способов решения этих проблем:

#### <a name="tenant-admin-consent"></a>Согласие администратора клиента

Самый простой подход — предоставить администратору клиента предварительное согласие от имени Организации. Это означает, что пользователям не нужно будет согласиться с этими областями, и вы сможете бесплатно обмениваться [данными на стороне](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow)сервера маркеров с помощью Azure AD. Это решение является приемлемым для внутренних бизнес-приложений, но может быть недостаточно для сторонних разработчиков, которые могут не полагаться на утверждение администратором клиента.

Простой способ отправки от имени Организации (в качестве администратора клиента):

* `https://login.microsoftonline.com/common/adminconsent?client_id=<AAD_App_ID>`

#### <a name="asking-for-additional-consent-using-the-auth-api"></a>Запрос дополнительного согласия с помощью API проверки подлинности

Другой способ получить дополнительные области Microsoft Graph — Показать диалоговое окно согласия, используя существующий [подход проверки подлинности Azure AD на основе веб-службы](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-popup-page) . Вот некоторые важные дополнения:

1. Для `getAuthToken()` получения доступа к дополнительным API Microsoft Graph необходимо, чтобы полученный [на](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow) сервере маркер был на сервере с помощью Azure AD.
    * Обязательно используйте конечную точку V2 Microsoft Graph для этого Exchange
2. В случае сбоя Exchange Azure AD возвратит недопустимое исключение granting. Как правило, существует одно из двух сообщений об `invalid_grant` ошибках. `interaction_required`
3. При сбое Exchange необходимо запросить дополнительное разрешение. Мы рекомендуем отобразить пользовательский интерфейс, который просит пользователя предоставить дополнительное согласие. Этот пользовательский интерфейс должен включать кнопку, которая запускает диалоговое окно согласия Azure AD с помощью [API проверки подлинности Azure AD](~/concepts/authentication/auth-silent-aad.md).
4. При получении запроса на получение дополнительного согласия от Azure AD необходимо включить `prompt=consent` [параметр запроса с параметром строки запроса](~/tabs/how-to/authentication/auth-silent-aad.md#get-the-user-context) в Azure AD, в противном случае Azure AD не запрашивает дополнительные области.
    * Вместо: `?scope={scopes}`
    * Используйте следующую команду: `?prompt=consent&scope={scopes}`
    * Убедитесь, что `{scopes}` включены все области, на которые вы запрашиваете пользователя (пример: mail. Read или User. Read).
5. После того как пользователь выдает дополнительное разрешение, повторите запрос от имени "от имени", чтобы получить доступ к этим дополнительным API.

### <a name="non-azure-ad-authentication"></a>Проверка подлинности без Azure AD

Описанное выше решение для проверки подлинности работает только для приложений и служб, поддерживающих Azure AD в качестве поставщика удостоверений. Приложения, которые хотят пройти проверку подлинности с помощью служб на основе Azure AD, должны продолжать использовать веб- [процесс проверки подлинности](~/concepts/authentication.md)на основе всплывающих окон.
