---
title: Поддержка единого входа для ботов
description: Описание единого входа (SSO)
ms.topic: how-to
ms.localizationpriority: high
keywords: группы проверки подлинности SSO Microsoft Azure Active Directory (Azure AD) единого api для входов
ms.openlocfilehash: edd7e08167c0efb93b7a578de12b7e1873aa193f
ms.sourcegitcommit: b9af51e24c9befcf46945400789e750c34723e56
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/15/2022
ms.locfileid: "62821726"
---
# <a name="single-sign-on-sso-support-for-tabs"></a>Поддержка единого входа (SSO) для вкладок

Пользователи, которые входят в Microsoft Teams с помощью учетной записи Office 365, Outlook или учебной учетной записи Майкрософт, могут воспользоваться преимуществами, разрешив единый вход для авторизации вкладок Teams или модуля задачи в настольных или мобильных клиентах. Если пользователь входит один раз, уже не нужно повторно входить на другом устройстве, так как вход осуществляется автоматически. Кроме того, маркер доступа предварительно загружается для повышения производительности и времени загрузки.

> [!NOTE]
> **Версии мобильных клиентов Teams, поддерживающие SSO**  
>
> ✔Teams для Android (1416/1.0.0.2020073101 и более поздние версии)
>
> ✔Teams для iOS (_Версия_: 2.0.18 и более поздние версии)  
> 
> ✔SDK JavaScript Teams (_Версия_: 1.10 и более поздние версии) для работы единого входа на боковой панели собрания. 
>
> Для лучшего взаимодействия с Teams используйте последнюю версию iOS и Android.

> [!NOTE]
> **Быстрый запуск**  
>
> Самый простой способ начала работы с единым входом для вкладок — это набор средств Teams для Microsoft Visual Studio Code. Дополнительные сведения см. в статье [Единый вход с помощью набора инструментов Teams и Visual Studio Code для вкладок](../../../toolkit/visual-studio-code-tab-sso.md)

## <a name="how-sso-works-at-runtime"></a>Принцип работы единого входа во время выполнения

На приведенном ниже изображении показано, как работает единый вход.

<!-- markdownlint-disable MD033 -->
<img src="~/assets/images/tabs/tabs-sso-diagram.png" alt="Tab single sign-on SSO diagram" width="75%"/>

1. На вкладке выполняется вызов JavaScript в `getAuthToken()`. `getAuthToken()` сообщает Teams, что нужно получить маркер доступа для приложения на вкладке.
2. Если текущий пользователь использует приложение на вкладке в первый раз, будет предложено дать согласие, если оно требуется. Кроме того, появляется запрос на обработку пошаговой проверки подлинности, например, двухфакторную проверку подлинности.
3. Teams запрашивает маркер доступа вкладки у конечной точки Azure AD для текущего пользователя.
4. Azure AD отправляет маркер доступа вкладки в приложение Teams.
5. Teams отправляет маркер доступа вкладки на вкладку как часть объекта результата, возвращаемого вызовом `getAuthToken()`.
6. Маркер анализируется в приложении вкладки с помощью JavaScript для извлечения необходимых сведений, например адреса электронной почты пользователя.

> [!NOTE]
> Метод `getAuthToken()` является допустимым только для согласия на ограниченный набор API на уровне пользователя, а именно email, profile, offline_access и OpenId. Он не используется для дополнительных областей Graph, таких как `User.Read` или `Mail.Read`. Рекомендуемые обходные пути см. в статье [Получение маркера доступа с помощью разрешений Graph](#get-an-access-token-with-graph-permissions).

API единого входа также работает в [модулях задач](../../../task-modules-and-cards/what-are-task-modules.md), которые встраивают веб-содержимое.

## <a name="develop-an-sso-microsoft-teams-tab"></a>Разработка вкладки Microsoft Teams с единым входом

В этом разделе описаны задачи, необходимые для создания вкладки Teams с единым входом. Эти задачи не зависит от языка и структуры.

### <a name="1-create-your-azure-ad-application"></a>1. Создание приложения Azure AD

> [!NOTE]
> Необходимо знать о некоторых важных ограничениях.
>
> * Поддерживаются только разрешения API Graph на уровне пользователя, а именно email, profile, offline_access и OpenId.. Если вам требуется доступ к другим областям Graph, таким как `User.Read` или `Mail.Read`, см. статью [Получение маркера доступа с помощью разрешений Graph](#get-an-access-token-with-graph-permissions).
> * Важно, чтобы доменное имя приложения было таким же, как и доменное имя, которое вы зарегистрировали для приложения Azure AD.
> * В настоящее время несколько доменов для приложения не поддерживаются.
> * Пользователь должен установить для `accessTokenAcceptedVersion` нового приложения значение `2`.

**Регистрация приложения через портал Azure AD**

1. Зарегистрируйте новое приложение на портале [Регистрация приложений Azure AD](https://go.microsoft.com/fwlink/?linkid=2083908).
1. Выберите **Новая регистрация**. Появится страница **Регистрация приложения**.
1. На странице **Регистрация приложения** задайте следующие значения параметров.
    1. Введите **Название** приложения.
    2. Выберите **Поддерживаемые типы учетных записей**, выберите тип учетной записи одного клиента или нескольких клиентов. ¹
    * Оставьте поле **URI перенаправления** пустым.
    3. Нажмите кнопку **Зарегистрировать**.
1. На странице обзора скопируйте и сохраните **идентификатор приложения (клиента)**. Он потребуется вам позже при обновлении манифеста приложения Teams.
1. В разделе **Управление** выберите **Предоставление API**.

    > [!NOTE]
    > Если вы создаете приложение с ботом и вкладкой, введите URI идентификатора приложения в качестве `api://fully-qualified-domain-name.com/botid-{YourBotId}`.

1. Щелкните ссылку **Задать**, чтобы создать URI идентификатора приложения в следующем формате: "`api://{AppID}`". Вставьте свое полное доменное имя с косой чертой "/" в конце между двойной косой чертой и GUID. Весь идентификатор должен иметь следующий формат: "`api://fully-qualified-domain-name.com/{AppID}`". ² Например, `api://subdomain.example.com/00000000-0000-0000-0000-000000000000`. Полное доменное имя — это понятно человеку имя домена, из которого обслуживается ваше приложение. Если вы используете службу туннелирования, например ngrok, это значение необходимо обновлять при изменениях поддомена ngrok.
1. Нажмите **Добавить область**. В открывшейся панели введите **access_as_user** в качестве параметра **Имя области**.
1. В поле **Кто может давать согласие?** укажите **Администраторы и пользователи**.
1. Введите сведения в поля для настройки запроса согласия у администраторов и пользователей со значениями, подходящими для области `access_as_user`.
    * **Название согласия администратора:** Teams может получить доступ к профилю пользователя.
    * **Описание согласия администратора**: Teams может вызывать веб-API приложения в качестве текущего пользователя.
    * **Название согласия пользователя**: Teams может получать доступ к вашему профилю и делать запросы от вашего имени.
    * **Описание согласия пользователя:** Teams может вызывать API этого приложения с вашими правами.
1. Убедитесь, что параметру **Состояние** присвоено значение **Включено**.
1. Выберите **Добавить область**, чтобы сохранить сведения. Доменная часть параметра **Имя области**, отображаемая под текстовым полем, должна автоматически соответствовать URI **идентификатора приложения**, заданного на предыдущем шаге, с добавлением `/access_as_user` в конце `api://subdomain.example.com/00000000-0000-0000-0000-000000000000/access_as_user`.
1. В разделе **Авторизованные клиентские приложения** укажите приложения, которые необходимо авторизовать для веб-приложения вашего приложения. Выберите **Добавить клиентское приложение**. Введите каждый из следующих идентификаторов клиента и выберите авторизованную область, созданную на предыдущем шаге.
    * `1fec8e78-bce4-4aaf-ab1b-5451cc387264` для мобильного или настольного приложения Teams.
    * `5e3ce6c0-2b1f-4285-8d4b-75ee78787346` для веб-приложения Teams.
1. Перейдите в **Разрешения API**. Выберите **Добавить разрешение** > **Microsoft Graph** > **Делегированные разрешения**, затем добавьте следующие разрешения из API Graph:
    * User.Read, включенное по умолчанию
    * email
    * offline_access
    * OpenId
    * profile

1. Перейдите к параметру **Аутентификация**.

    > [!IMPORTANT]
    > Если приложению не предоставлено согласие ИТ-администратора, пользователи должны дать согласие при первом использовании приложения.

    Чтобы ввести URI перенаправления, сделайте следующее.
    * Выберите **Добавить платформу**.
    * Выберите **web**.
    * Введите **URI перенаправления** для вашего приложения. Этот URI — это полное доменное имя, которое вы ввели на шаге 5. За ним также следует маршрут API, на который отправляется ответ проверки подлинности. Если вы следуете любому из примеров Teams, URI будет `https://subdomain.example.com/auth-end`. Дополнительные сведения см. в статье [Поток кода авторизации OAuth 2.0](/azure/active-directory/develop/v2-oauth2-auth-code-flow).

    > [!NOTE]
    > Неявное предоставление разрешения не требуется для единого входа вкладки.

Поздравляем! Вы выполнили необходимые условия для регистрации приложения, чтобы продолжить работу с приложением для единого входа на вкладке.

> [!NOTE]
>
> * ¹ Если ваше приложение Azure AD зарегистрировано в том же клиенте, в котором вы делаете запрос на проверку подлинности в Teams, пользователю не будет предлагаться дать согласие, а сразу будет предоставлен маркер доступа. Пользователи дают согласие на эти разрешения только в том случае, если приложение Azure AD зарегистрировано в другом клиенте.
> * ² Если личный домен не добавлен в Azure AD, вы получите сообщение об ошибке, указывающее, что имя узла не должно быть основано на домене, которым вы уже владеете. Чтобы добавить личный домен в Azure AD и зарегистрировать его, выполните процедуру по [добавлению имени личного домена в Azure AD](/azure/active-directory/fundamentals/add-custom-domain) и повторите шаг 5. Эту ошибку также можно получить, если вы не вошли в область клиента Office 365 с помощью учетных данных администратора.
> * Если вы не получили имя субъекта-пользователя (UPN) в возвращенном маркере доступа, вы можете добавить его как [необязательное утверждение](/azure/active-directory/develop/active-directory-optional-claims) в Azure AD.

### <a name="2-update-your-teams-application-manifest"></a>2. Обновите манифест приложения Teams

Чтобы добавить новые свойства в манифест Teams, используйте следующий код.

```json
"webApplicationInfo": {
  "id": "00000000-0000-0000-0000-000000000000",
  "resource": "api://subdomain.example.com/00000000-0000-0000-0000-000000000000"
}
```

* **WebApplicationInfo** — родительский элемент для указанных ниже элементов.

> [!div class="checklist"]
> * **id** — это идентификатор клиента приложения. Это идентификатор приложения, полученный при регистрации приложения в Azure AD.
>* **resource** — домен и поддомен вашего приложения. Это тот же URI (включая протокол `api://`), который вы зарегистрировали при создании `scope` на шаге 6. Не следует включать в ресурс путь к `access_as_user`. Доменная часть этого URI должна соответствовать домену, включая все поддомены, используемые в URL-адресах манифеста приложения Teams.

> [!NOTE]
>
>* Ресурс для приложения Azure AD обычно является корнем URL-адреса сайта и appID (например, `api://subdomain.example.com/00000000-0000-0000-0000-000000000000`). Это значение также используется для обеспечения получения запроса из того же домена. Убедитесь, что `contentURL` для вкладки использует те же домены, что и свойство ресурса.
>* Для реализации поля `webApplicationInfo` необходимо использовать манифест версии 1.5 или более новой версии.

### <a name="3-get-an-access-token-from-your-client-side-code"></a>3. Получите маркер доступа из клиентского кода

Используйте следующий API проверки подлинности.

```javascript
var authTokenRequest = {
  successCallback: function(result) { console.log("Success: " + result); },
  failureCallback: function(error) { console.log("Failure: " + error); }
};
microsoftTeams.authentication.getAuthToken(authTokenRequest);
```

Когда вы вызываете `getAuthToken` и для разрешений на уровне пользователя требуется согласие пользователя, пользователю отображается диалоговое окно для предоставления согласия.

Получив маркер доступа при успешном обратном вызове, расшифруйте маркер доступа, чтобы просмотреть утверждения для этого маркера. При желании вручную скопируйте и вставьте маркер доступа в средство, например [jwt.ms](https://jwt.ms/). Если вы не получили имя субъекта-пользователя в возвращенном маркере доступа, добавьте его как [необязательное утверждение](/azure/active-directory/develop/active-directory-optional-claims) в Azure AD. Дополнительные сведения см. в разделе о [маркерах доступа](/azure/active-directory/develop/access-tokens).

<p>
    <img src="~/assets/images/tabs/tabs-sso-prompt.png" alt="Tab single sign-on SSO dialog prompt" width="75%"/>
</p>

## <a name="code-snippets"></a>Фрагменты кода

В следующем коде приводится пример потока On-Behalf-Of для получения маркера доступа с помощью библиотеки MSAL:

### <a name="c"></a>[C#](#tab/dotnet)

```csharp

IConfidentialClientApplication app = ConfidentialClientApplicationBuilder.Create(<"Client id">)
                                                .WithClientSecret(<"Client secret">)
                                                .WithAuthority($"https://login.microsoftonline.com/<"Tenant id">")
                                                .Build();
 
            try
            {
                var idToken = <"Client side token">;
                UserAssertion assert = new UserAssertion(idToken);
                List<string> scopes = new List<string>();
                scopes.Add("https://graph.microsoft.com/User.Read");
                var responseToken = await app.AcquireTokenOnBehalfOf(scopes, assert).ExecuteAsync();
                return responseToken.AccessToken.ToString();
            }
            catch (Exception ex)
            {
                return ex.Message;
            }
        }
```

### <a name="nodejs"></a>[Node.js](#tab/nodejs)

```javascript

// Exchange cliend side token with server token
  app.post('/getProfileOnBehalfOf', function(req, res) {
        var tid = < "Tenand id" >
    var token = < "Client side token" >
    var scopes = ["https://graph.microsoft.com/User.Read"];

        // Creating MSAL client
        const msalClient = new msal.ConfidentialClientApplication({
            auth: {
                clientId: < "Client ID" >,
                clientSecret: < "Client Secret" >
      }
        });

        var oboPromise = new Promise((resolve, reject) => {
            msalClient.acquireTokenOnBehalfOf({
                authority: `https://login.microsoftonline.com/${tid}`,
                oboAssertion: token,
                scopes: scopes,
                skipCache: true
            }).then(result => {
                console.log("Token is: " + result.accessToken);
            }).catch(error => {
                reject({ "error": error.errorCode });
            });
        });
```
---

## <a name="code-sample"></a>Пример кода

|**Название примера**|**Описание**|**C#**|**Node.js**|
|---------------|---------------|------|--------------|
| Единый вход на вкладке |Пример приложения Microsoft Teams для единого входа на вкладках Azure AD| [View](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/tab-sso/csharp)|[View](https://github.com/OfficeDev/Microsoft-Teams-Samples/blob/main/samples/tab-sso/nodejs), </br>[Набор средств Teams](../../../toolkit/visual-studio-code-tab-sso.md)|

## <a name="known-limitations"></a>Известные ограничения

### <a name="get-an-access-token-with-graph-permissions"></a>Получение маркера доступа с разрешениями Graph

Текущая реализация для единого входа дает согласие только на разрешения на уровне пользователя, которые нельзя использовать для выполнения вызовов Graph. Чтобы получить разрешения (области), необходимые для вызова Graph, решения для SSO должны реализовать настраиваемую веб-службу для обмена маркера, полученного из SDK JavaScript Teams, на маркер, который включает необходимые области. Это выполняется с помощью [потока On-Behalf-Of](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow) Azure AD.

### <a name="tenant-admin-consent"></a>Согласие администратора клиента

Простой способ получения согласия от имени организации в качестве администратора клиента — обратиться к `https://login.microsoftonline.com/common/adminconsent?client_id=<AAD_App_ID>`.

#### <a name="ask-for-consent-using-the-auth-api"></a>Запрос согласия с помощью API Auth

Другой способ получения областей Graph — представить диалоговое окно для получения согласия с использованием нашего существующего [веб-подхода к проверке подлинности Azure AD](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-pop-up-page). Этот подход включает в себя отображение всплывающего диалогового окна Azure AD для получения согласия.

**Запрос дополнительного согласия с помощью API Auth**

1. Маркер, полученный с помощью `getAuthToken()`, следует обменять на стороне сервера с помощью [потока On-Behalf-Of](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow) Azure AD для получения доступа к другим API Graph. Убедитесь, что для этого обмена вы используете конечную точку Graph v2.
2. В случае ошибки обмена Azure AD возвращает исключение недопустимого предоставления. Обычно появляется одно из двух сообщений об ошибке, `invalid_grant` или `interaction_required`.
3. В случае сбоя обмена необходимо запросить согласие. Отобразите пользовательский интерфейс с просьбой предоставить другое согласие. Этот пользовательский интерфейс должен включать кнопку, которая запускает диалоговое окно согласия Azure AD с помощью нашего [API проверки подлинности Azure AD](~/concepts/authentication/auth-silent-aad.md).
4. При запросе дополнительного согласия от Azure AD следует включить `prompt=consent` в [query-string-parameter](~/tabs/how-to/authentication/auth-silent-aad.md#get-the-user-context) в Azure AD, иначе Azure AD не запросит другие области.
    * Вместо `?scope={scopes}`
    * Используйте `?prompt=consent&scope={scopes}`
    * Убедитесь, что `{scopes}` включает все области, которые вы запросили у пользователя, например Mail.Read или User.Read.
5. После того как пользователь предоставил больше разрешений, попробуйте повторно применить поток on-behalf-of, чтобы получить доступ к другим API.

### <a name="non-azure-ad-authentication"></a>Проверка подлинности не на основе Azure AD

Описанное выше решение для проверки подлинности работает только для приложений и служб, которые поддерживают Azure AD в качестве поставщика удостоверений. Приложениям, которые хотят пройти проверку подлинности с помощью служб, не основанных на Azure AD, следует продолжать использовать [веб-поток проверки подлинности](~/concepts/authentication.md) со всплывающими элементами.

> [!NOTE]
> Единый вход поддерживается приложениями клиентов в клиентах Azure AD B2C.

## <a name="step-by-step-guides"></a>Пошаговые руководства

* Следуйте [инструкциям в руководстве](../../../sbs-tabs-and-messaging-extensions-with-sso.yml) для проверки подлинности вкладок и расширений обмена сообщениями.
* Следуйте [инструкциям в руководстве](../../../sbs-tab-with-adaptive-cards.yml) для создания вкладки с адаптивными карточками.

## <a name="see-also"></a>См. также
[Бот Teams с единым входом](../../../sbs-bots-with-sso.yml)
