---
title: Единый вход
description: Описание единого входа (SSO)
keywords: API единого входа для проверки подлинности Teams AAD
ms.openlocfilehash: 503d5ff9779224d922ab0d45c6e2a3b33d7e0de7
ms.sourcegitcommit: 52732714105fac07c331cd31e370a9685f45d3e1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/25/2020
ms.locfileid: "46874858"
---
# <a name="single-sign-on-sso"></a><span data-ttu-id="8ece3-104">Единый вход (SSO)</span><span class="sxs-lookup"><span data-stu-id="8ece3-104">Single Sign-On (SSO)</span></span>

<span data-ttu-id="8ece3-105">Пользователи входят в Microsoft Teams с помощью рабочих, учебных заведений или учетных записей Майкрософт (Office 365, Outlook и т. д.).</span><span class="sxs-lookup"><span data-stu-id="8ece3-105">Users sign in to Microsoft Teams via their work, school, or Microsoft accounts (Office 365, Outlook, etc).</span></span> <span data-ttu-id="8ece3-106">Вы можете воспользоваться этой возможностью, разрешая единый вход для авторизации вкладки Microsoft Teams (или модуля задач) на настольных или мобильных клиентах.</span><span class="sxs-lookup"><span data-stu-id="8ece3-106">You can take advantage of this by allowing a single sign-on to authorize your Microsoft Teams tab (or task module) on desktop or mobile clients.</span></span> <span data-ttu-id="8ece3-107">Таким образом, если пользователь, который будет использовать ваше приложение, не будет иметь согласия на другом устройстве, он будет автоматически выполнен вход.</span><span class="sxs-lookup"><span data-stu-id="8ece3-107">Thus, if a user consents to use your app, they won’t have to consent again on another device — they will signed in be automatically.</span></span> <span data-ttu-id="8ece3-108">Кроме того, мы предоставим свой маркер доступа, чтобы увеличить производительность и время загрузки.</span><span class="sxs-lookup"><span data-stu-id="8ece3-108">In addition, we prefetch your access token to improve performance and load times.</span></span>

>[!NOTE]
> <span data-ttu-id="8ece3-109">**Версии клиента Teams для мобильных устройств, поддерживающие единый вход**</span><span class="sxs-lookup"><span data-stu-id="8ece3-109">**Teams mobile client versions supporting SSO**</span></span>  
>
> <span data-ttu-id="8ece3-110">✔ Teams для Android (1416/1.0.0.2020073101 и более поздних версий)</span><span class="sxs-lookup"><span data-stu-id="8ece3-110">✔Teams for Android (1416/1.0.0.2020073101 and later)</span></span>
>
> <span data-ttu-id="8ece3-111">✔ Teams для iOS (_версия_: 2.0.18 и более поздняя)</span><span class="sxs-lookup"><span data-stu-id="8ece3-111">✔Teams for iOS (_Version_: 2.0.18 and later)</span></span>  
>
> <span data-ttu-id="8ece3-112">Для оптимальной работы с Teams используйте последнюю версию iOS и Android.</span><span class="sxs-lookup"><span data-stu-id="8ece3-112">For the best experience with Teams, please use the latest version of iOS and Android.</span></span>

## <a name="how-sso-works-at-runtime"></a><span data-ttu-id="8ece3-113">Принцип работы единого входа во время выполнения</span><span class="sxs-lookup"><span data-stu-id="8ece3-113">How SSO works at runtime</span></span>

<span data-ttu-id="8ece3-114">На следующей схеме показано, как работает процесс единого входа.</span><span class="sxs-lookup"><span data-stu-id="8ece3-114">The following diagram shows how the SSO process works:</span></span>

<!-- markdownlint-disable MD033 -->
<img src="~/assets/images/tabs/tabs-sso-diagram.png" alt="Tab single sign-on SSO diagram" width="75%"/>

1. <span data-ttu-id="8ece3-115">На вкладке выполняется вызов JavaScript `getAuthToken()` .</span><span class="sxs-lookup"><span data-stu-id="8ece3-115">In the tab, a JavaScript call is made to `getAuthToken()`.</span></span> <span data-ttu-id="8ece3-116">Это указывает Teams получить маркер проверки подлинности для приложения вкладки.</span><span class="sxs-lookup"><span data-stu-id="8ece3-116">This tells Teams to obtain an authentication token for the tab application.</span></span>
2. <span data-ttu-id="8ece3-117">Если в первый раз текущий пользователь использовал вкладку приложения, будет выдаваться запрос на получение согласия (если требуется согласие) или обрабатывается поэтапная проверка подлинности (например, двухфакторная проверка подлинности).</span><span class="sxs-lookup"><span data-stu-id="8ece3-117">If this is the first time the current user has used your tab application, there will be a request prompt to consent (if consent is required) or to handle step-up authentication (such as two-factor authentication).</span></span>
3. <span data-ttu-id="8ece3-118">Teams запрашивает маркер приложения Tab из конечной точки Azure AD для текущего пользователя.</span><span class="sxs-lookup"><span data-stu-id="8ece3-118">Teams requests the tab application token from the Azure AD endpoint for the current user.</span></span>
4. <span data-ttu-id="8ece3-119">Azure AD отправляет маркер приложения "Вкладка" приложению Teams.</span><span class="sxs-lookup"><span data-stu-id="8ece3-119">Azure AD sends the tab application token to the Teams application.</span></span>
5. <span data-ttu-id="8ece3-120">Teams отправляет маркер приложения на вкладку в составе объекта результата, возвращенного `getAuthToken()` вызовом.</span><span class="sxs-lookup"><span data-stu-id="8ece3-120">Teams sends the tab application token to the tab as part of the result object returned by the `getAuthToken()` call.</span></span>
6. <span data-ttu-id="8ece3-121">Маркер будет проанализирован в приложении Tab с помощью JavaScript, чтобы извлечь необходимые сведения, такие как адрес электронной почты пользователя.</span><span class="sxs-lookup"><span data-stu-id="8ece3-121">The token will be parsed in the tab application, via JavaScript, to extract the needed information, such as the user's email address.</span></span>

> [!NOTE]
> <span data-ttu-id="8ece3-122">`getAuthToken()`Допускается только для тех, кто может быть отправлен в ограниченный набор API уровня пользователя: Электронная почта, профиль, offline_access и OpenId, а не другие области Microsoft Graph, такие как `User.Read` или `Mail.Read` .</span><span class="sxs-lookup"><span data-stu-id="8ece3-122">The `getAuthToken()` is only valid for consenting to a limited set of user-level APIs — email, profile, offline_access and OpenId — and not for further Microsoft Graph scopes such as `User.Read` or `Mail.Read`.</span></span> <span data-ttu-id="8ece3-123">Предлагаемые решения можно найти в конце этого документа, если вам нужны [Дополнительные области диаграммы](#apps-that-require-additional-microsoft-graph-scopes).</span><span class="sxs-lookup"><span data-stu-id="8ece3-123">See our section at the end of this document for suggested workarounds if you require [additional Graph scopes](#apps-that-require-additional-microsoft-graph-scopes).</span></span>

<span data-ttu-id="8ece3-124">API единого входа также будет работать в [модулях задач](../../../task-modules-and-cards/what-are-task-modules.md) , которые внедряют веб-контент.</span><span class="sxs-lookup"><span data-stu-id="8ece3-124">The SSO API will also work in [Task Modules](../../../task-modules-and-cards/what-are-task-modules.md) that embed web content.</span></span>

## <a name="develop-an-sso-microsoft-teams-tab"></a><span data-ttu-id="8ece3-125">Разработка вкладки Microsoft Teams единого входа</span><span class="sxs-lookup"><span data-stu-id="8ece3-125">Develop an SSO Microsoft Teams tab</span></span>

<span data-ttu-id="8ece3-126">В этом разделе описываются задачи, связанные с созданием вкладок Teams, использующих единый вход.</span><span class="sxs-lookup"><span data-stu-id="8ece3-126">This section describes the tasks involved in creating a Teams tab that uses SSO.</span></span> <span data-ttu-id="8ece3-127">Описанные здесь задачи не зависят от языка и платформы.</span><span class="sxs-lookup"><span data-stu-id="8ece3-127">These tasks are described here are language- and framework-agnostic.</span></span>

### <a name="1-create-your-azure-active-directory-azure-ad-application"></a><span data-ttu-id="8ece3-128">1. Создание приложения Azure Active Directory (Azure AD)</span><span class="sxs-lookup"><span data-stu-id="8ece3-128">1. Create your Azure Active Directory (Azure AD) application</span></span>

#### <a name="registering-your-application-in-theazure-ad-portal-overview"></a><span data-ttu-id="8ece3-129">Регистрация приложения на[портале Azure AD](https://azure.microsoft.com/features/azure-portal/) Обзор:</span><span class="sxs-lookup"><span data-stu-id="8ece3-129">Registering your application in the[Azure AD portal](https://azure.microsoft.com/features/azure-portal/) overview:</span></span>

1. <span data-ttu-id="8ece3-130">Получение [идентификатора приложения Azure AD](/azure/active-directory/develop/howto-create-service-principal-portal#get-values-for-signing-in).</span><span class="sxs-lookup"><span data-stu-id="8ece3-130">Get your [Azure AD Application ID](/azure/active-directory/develop/howto-create-service-principal-portal#get-values-for-signing-in).</span></span>
2. <span data-ttu-id="8ece3-131">Укажите разрешения, необходимые вашему приложению для конечной точки Azure AD, и (при необходимости) Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="8ece3-131">Specify the permissions that your application needs for the Azure AD endpoint and, optionally, Microsoft Graph.</span></span>
3. <span data-ttu-id="8ece3-132">[Предоставление разрешений](/azure/active-directory/develop/howto-create-service-principal-portal#configure-access-policies-on-resources) для настольных приложений, веб-приложений и мобильных приложений Teams.</span><span class="sxs-lookup"><span data-stu-id="8ece3-132">[Grant permissions](/azure/active-directory/develop/howto-create-service-principal-portal#configure-access-policies-on-resources) for Teams desktop, web, and mobile applications.</span></span>
4. <span data-ttu-id="8ece3-133">Предварительная авторизация Teams, нажав кнопку **Добавить область** и на открывшейся панели, введите `access_as_user` **имя области**.</span><span class="sxs-lookup"><span data-stu-id="8ece3-133">Pre-authorize Teams by selecting the **Add a scope** button and in the panel that opens, enter `access_as_user` as the **Scope name**.</span></span>

> [!NOTE]
> <span data-ttu-id="8ece3-134">Вы должны знать о некоторых важных ограничениях:</span><span class="sxs-lookup"><span data-stu-id="8ece3-134">There are some important restrictions you should be aware of:</span></span>
>
> * <span data-ttu-id="8ece3-135">Поддерживаются только разрешения API Microsoft Graph на уровне пользователя, например, электронная почта, профиль, offline_access, OpenId.</span><span class="sxs-lookup"><span data-stu-id="8ece3-135">We only support user-level Microsoft Graph API permissions, i.e., email, profile, offline_access, OpenId.</span></span> <span data-ttu-id="8ece3-136">Если вам требуется доступ к другим областям Microsoft Graph (например `User.Read` `Mail.Read` , или), ознакомьтесь с [рекомендуемым обходным способом](#apps-that-require-additional-microsoft-graph-scopes) в конце этой документации.</span><span class="sxs-lookup"><span data-stu-id="8ece3-136">If you need access to other Microsoft Graph scopes (such as `User.Read` or `Mail.Read`), see our [recommended workaround](#apps-that-require-additional-microsoft-graph-scopes) at the end of this documentation.</span></span>
> * <span data-ttu-id="8ece3-137">Важно, чтобы доменное имя вашего приложения совпадало с именем домена, зарегистрированным для вашего приложения Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8ece3-137">It's important that your application's domain name is the same as the domain name you've registering for your Azure AD application.</span></span>
> * <span data-ttu-id="8ece3-138">В настоящее время не поддерживается несколько доменов для каждого приложения.</span><span class="sxs-lookup"><span data-stu-id="8ece3-138">We don't currently support multiple domains per app.</span></span>
> * <span data-ttu-id="8ece3-139">Мы не поддерживаем приложения, использующие `azurewebsites.net` домен, так как он слишком распространен и может представлять угрозу безопасности.</span><span class="sxs-lookup"><span data-stu-id="8ece3-139">We don't support applications that use the `azurewebsites.net` domain because it is too common and may be a security risk.</span></span> <span data-ttu-id="8ece3-140">Однако мы активно используем, чтобы удалить это ограничение.</span><span class="sxs-lookup"><span data-stu-id="8ece3-140">However, we're actively seeking to remove this restriction.</span></span>

#### <a name="registering-your-app-through-the-azure-active-directory-portal-in-depth"></a><span data-ttu-id="8ece3-141">Подробное регистрация приложения с помощью портала Azure Active Directory:</span><span class="sxs-lookup"><span data-stu-id="8ece3-141">Registering your app through the Azure Active Directory portal in-depth:</span></span>

1. <span data-ttu-id="8ece3-142">Зарегистрируйте новое приложение в портале [регистрации приложений Azure Active Directory —](https://go.microsoft.com/fwlink/?linkid=2083908) .</span><span class="sxs-lookup"><span data-stu-id="8ece3-142">Register a new application in the [Azure Active Directory – App Registrations](https://go.microsoft.com/fwlink/?linkid=2083908) portal.</span></span>
2. <span data-ttu-id="8ece3-143">Нажмите кнопку **создать регистрацию** и на *странице Регистрация приложения*задайте следующие значения:</span><span class="sxs-lookup"><span data-stu-id="8ece3-143">Select **New Registration** and on the *register an application page*, set following values:</span></span>
    * <span data-ttu-id="8ece3-144">Задайте **имя** приложения.</span><span class="sxs-lookup"><span data-stu-id="8ece3-144">Set **name** to your app name.</span></span>
    * <span data-ttu-id="8ece3-145">Выбор **поддерживаемых типов учетных записей** (любой тип учетной записи будет работать) ¹</span><span class="sxs-lookup"><span data-stu-id="8ece3-145">Choose the **supported account types** (any account type will work) ¹</span></span>
    * <span data-ttu-id="8ece3-146">Оставьте поле **URI перенаправления** пустым.</span><span class="sxs-lookup"><span data-stu-id="8ece3-146">Leave **Redirect URI** empty.</span></span>
    * <span data-ttu-id="8ece3-147">Нажмите кнопку **Зарегистрировать**.</span><span class="sxs-lookup"><span data-stu-id="8ece3-147">Choose **Register**.</span></span>
3. <span data-ttu-id="8ece3-148">На странице Обзор скопируйте и сохраните **идентификатор приложения (клиента)**.</span><span class="sxs-lookup"><span data-stu-id="8ece3-148">On the overview page, copy and save the **Application (client) ID**.</span></span> <span data-ttu-id="8ece3-149">Он понадобится позже при обновлении манифеста приложения Teams.</span><span class="sxs-lookup"><span data-stu-id="8ece3-149">You’ll need it later when updating your Teams application manifest.</span></span>
4. <span data-ttu-id="8ece3-150">В разделе **Управление** выберите **Предоставление API**.</span><span class="sxs-lookup"><span data-stu-id="8ece3-150">Under **Manage**, select **Expose an API**.</span></span> 
5. <span data-ttu-id="8ece3-151">Выберите ссылку **задать** , чтобы создать URI идентификатора приложения в виде `api://{AppID}` .</span><span class="sxs-lookup"><span data-stu-id="8ece3-151">Select the **Set** link to generate the Application ID URI in the form of `api://{AppID}`.</span></span> <span data-ttu-id="8ece3-152">Вставьте полное доменное имя (с символом косой черты "/") между двумя косыми чертами и GUID.</span><span class="sxs-lookup"><span data-stu-id="8ece3-152">Insert your fully qualified domain name (with a forward slash "/" appended to the end) between the double forward slashes and the GUID.</span></span> <span data-ttu-id="8ece3-153">Весь идентификатор должен иметь вид: `api://fully-qualified-domain-name.com/{AppID}` ²</span><span class="sxs-lookup"><span data-stu-id="8ece3-153">The entire ID should have the form of: `api://fully-qualified-domain-name.com/{AppID}` ²</span></span>
    * <span data-ttu-id="8ece3-154">Пример: `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` .</span><span class="sxs-lookup"><span data-stu-id="8ece3-154">ex: `api://subdomain.example.com/00000000-0000-0000-0000-000000000000`.</span></span>
    
    <span data-ttu-id="8ece3-155">Полное доменное имя — это понятное для человека доменное имя, из которого обслуживается ваше приложение.</span><span class="sxs-lookup"><span data-stu-id="8ece3-155">The fully qualified domain name is the human readable domain name from which your app is served.</span></span> <span data-ttu-id="8ece3-156">Если вы используете службу туннелирования, такую как ngrok, вам потребуется обновить это значение при каждом изменении дочернего домена ngrok.</span><span class="sxs-lookup"><span data-stu-id="8ece3-156">If you are using a tunneling service such as ngrok, you will need to update     this value whenever your ngrok subdomain changes.</span></span> 
6. <span data-ttu-id="8ece3-157">Нажмите кнопку **Добавить область**.</span><span class="sxs-lookup"><span data-stu-id="8ece3-157">Select the **Add a scope** button.</span></span> <span data-ttu-id="8ece3-158">В открывшейся панели введите `access_as_user` в качестве параметра **Имя области**.</span><span class="sxs-lookup"><span data-stu-id="8ece3-158">In the panel that opens, enter `access_as_user` as the **Scope name**.</span></span>
7. <span data-ttu-id="8ece3-159">Как определить **, кому разрешено согласие?**`Admins and users`</span><span class="sxs-lookup"><span data-stu-id="8ece3-159">Set **Who can consent?** to `Admins and users`</span></span>
8. <span data-ttu-id="8ece3-160">Заполните поля для настройки приглашений администратора и согласия пользователя со значениями, подходящими для `access_as_user` области:</span><span class="sxs-lookup"><span data-stu-id="8ece3-160">Fill in the fields for configuring the admin and user consent prompts with values that are appropriate for the `access_as_user` scope:</span></span>
    * <span data-ttu-id="8ece3-161">**Заголовок согласия администратора:** Teams может получить доступ к профилю пользователя.</span><span class="sxs-lookup"><span data-stu-id="8ece3-161">**Admin consent title:** Teams can access the user’s profile.</span></span>
    * <span data-ttu-id="8ece3-162">**Описание согласия администратора**: позволяет Teams вызывать API приложения в качестве текущего пользователя.</span><span class="sxs-lookup"><span data-stu-id="8ece3-162">**Admin consent description**: Allows Teams to call the app’s web APIs as the current user.</span></span>
    * <span data-ttu-id="8ece3-163">**Заголовок согласия пользователя**: teams могут получать доступ к профилю пользователя и делать запросы от имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="8ece3-163">**User consent title**: Teams can access the user profile and make requests on the user's behalf.</span></span>
    * <span data-ttu-id="8ece3-164">**Описание согласия пользователя:** Разрешите Teams вызывать API этого приложения с теми же правами, что и у пользователя.</span><span class="sxs-lookup"><span data-stu-id="8ece3-164">**User consent description:** Enable Teams to call this app’s APIs with the same rights as the user.</span></span>
9. <span data-ttu-id="8ece3-165">Убедитесь, **State** что для параметра состояние **Включено значение включено** .</span><span class="sxs-lookup"><span data-stu-id="8ece3-165">Ensure that **State** is set to **Enabled**</span></span>
10. <span data-ttu-id="8ece3-166">Нажмите кнопку **Добавить область** , чтобы сохранить</span><span class="sxs-lookup"><span data-stu-id="8ece3-166">Select the **Add scope** button to save</span></span> 
    * <span data-ttu-id="8ece3-167">Доменная часть **имени области** , отображаемая непосредственно под текстовым полем, должна автоматически СОПОСТАВЛЯТЬ URI **идентификатора приложения** , заданный на предыдущем шаге, с `/access_as_user` добавлением в конец:</span><span class="sxs-lookup"><span data-stu-id="8ece3-167">The domain part of the **Scope name** displayed just below the text field should automatically match the **Application ID** URI set in the previous step, with `/access_as_user` appended to the end:</span></span>
        * `api://subdomain.example.com/00000000-0000-0000-0000-000000000000/access_as_user`
11. <span data-ttu-id="8ece3-168">В разделе **Авторизованные клиентские приложения** Определите приложения, которые требуется авторизовать для веб-приложения приложения.</span><span class="sxs-lookup"><span data-stu-id="8ece3-168">In the **Authorized client applications** section, identify the applications that you want to authorize for your app’s web application.</span></span> <span data-ttu-id="8ece3-169">Выберите *добавить клиентское приложение*.</span><span class="sxs-lookup"><span data-stu-id="8ece3-169">Select *Add a client application*.</span></span> <span data-ttu-id="8ece3-170">Введите каждый из следующих идентификаторов клиентов и выберите авторизованную область, созданную на предыдущем шаге:</span><span class="sxs-lookup"><span data-stu-id="8ece3-170">Enter each of the following client IDs and select the authorized scope you created in the previous step:</span></span>
    * <span data-ttu-id="8ece3-171">`1fec8e78-bce4-4aaf-ab1b-5451cc387264` (Приложение Teams для мобильных устройств и настольных приложений)</span><span class="sxs-lookup"><span data-stu-id="8ece3-171">`1fec8e78-bce4-4aaf-ab1b-5451cc387264` (Teams mobile/desktop application)</span></span>
    * <span data-ttu-id="8ece3-172">`5e3ce6c0-2b1f-4285-8d4b-75ee78787346` (Веб-приложение Teams)</span><span class="sxs-lookup"><span data-stu-id="8ece3-172">`5e3ce6c0-2b1f-4285-8d4b-75ee78787346` (Teams web application)</span></span>
12. <span data-ttu-id="8ece3-173">Перейдите к разделу **разрешения API**.</span><span class="sxs-lookup"><span data-stu-id="8ece3-173">Navigate to **API Permissions**.</span></span> <span data-ttu-id="8ece3-174">Выберите *Добавить разрешение*,  >  *Microsoft Graph*  >  *делегированные разрешения*Microsoft Graph, а затем добавьте следующие разрешения:</span><span class="sxs-lookup"><span data-stu-id="8ece3-174">Select *Add a permission* > *Microsoft Graph* > *Delegated permissions*, then add the following permissions:</span></span>
    * <span data-ttu-id="8ece3-175">User. Read (включено по умолчанию)</span><span class="sxs-lookup"><span data-stu-id="8ece3-175">User.Read (enabled by default)</span></span>
    * <span data-ttu-id="8ece3-176">рассылка</span><span class="sxs-lookup"><span data-stu-id="8ece3-176">email</span></span>
    * <span data-ttu-id="8ece3-177">offline_access</span><span class="sxs-lookup"><span data-stu-id="8ece3-177">offline_access</span></span>
    * <span data-ttu-id="8ece3-178">OpenId</span><span class="sxs-lookup"><span data-stu-id="8ece3-178">OpenId</span></span>
    * <span data-ttu-id="8ece3-179">profile</span><span class="sxs-lookup"><span data-stu-id="8ece3-179">profile</span></span>

13. <span data-ttu-id="8ece3-180">Переход к **проверке подлинности**</span><span class="sxs-lookup"><span data-stu-id="8ece3-180">Navigate to **Authentication**</span></span>

    <span data-ttu-id="8ece3-181">Если приложению не было предоставлено согласие администратора, пользователям потребуется предоставить согласие при первом использовании приложения.</span><span class="sxs-lookup"><span data-stu-id="8ece3-181">If an app hasn't been granted IT admin consent, users will have to provide consent the first time they use an app.</span></span>

    <span data-ttu-id="8ece3-182">Задайте URI перенаправления:</span><span class="sxs-lookup"><span data-stu-id="8ece3-182">Set a redirect URI:</span></span>
    * <span data-ttu-id="8ece3-183">Выберите **элемент добавить платформу**.</span><span class="sxs-lookup"><span data-stu-id="8ece3-183">Select **Add a platform**.</span></span>
    * <span data-ttu-id="8ece3-184">Выберите **веб**.</span><span class="sxs-lookup"><span data-stu-id="8ece3-184">Select **web**.</span></span>
    * <span data-ttu-id="8ece3-185">Введите **универсальный код ресурса (URI) перенаправления** для вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="8ece3-185">Enter the **redirect URI** for your app.</span></span> <span data-ttu-id="8ece3-186">Это будет страница, на которой успешный неявный поток предоставления перенаправит пользователя.</span><span class="sxs-lookup"><span data-stu-id="8ece3-186">This will be the page where a successful implicit grant flow will redirect the user.</span></span> <span data-ttu-id="8ece3-187">Это будет одно и то же полное доменное имя, введенное на шаге 5, за которым следует маршрут API, в котором нужно отправить ответ на проверку подлинности.</span><span class="sxs-lookup"><span data-stu-id="8ece3-187">This will be same fully qualified domain name that you entered in step 5 followed by the API route where a authentication response should be sent.</span></span> <span data-ttu-id="8ece3-188">Если вы подписаны на один из примеров Teams, будут выполняться следующие действия: `https://subdomain.example.com/auth-end`</span><span class="sxs-lookup"><span data-stu-id="8ece3-188">If you are following any of the Teams samples, this will be: `https://subdomain.example.com/auth-end`</span></span>

    <span data-ttu-id="8ece3-189">Затем включите неявное предоставление, установив следующие флажки:</span><span class="sxs-lookup"><span data-stu-id="8ece3-189">Next, enable implicit grant by checking the following boxes:</span></span>  
    <span data-ttu-id="8ece3-190">Маркер идентификатора ✔</span><span class="sxs-lookup"><span data-stu-id="8ece3-190">✔ ID Token</span></span>  
    <span data-ttu-id="8ece3-191">Маркер доступа ✔</span><span class="sxs-lookup"><span data-stu-id="8ece3-191">✔ Access Token</span></span>  
    
<span data-ttu-id="8ece3-192">Поздравляем!</span><span class="sxs-lookup"><span data-stu-id="8ece3-192">Congratulations!</span></span> <span data-ttu-id="8ece3-193">Вы завершили регистрацию приложения пререкуситиес, чтобы перейти к приложению единого входа для вкладки.</span><span class="sxs-lookup"><span data-stu-id="8ece3-193">You have completed the app registration prerequsities to proceed with your tab SSO app.</span></span>     

> [!NOTE]
>
> * <span data-ttu-id="8ece3-194">¹ если ваше приложение Azure AD зарегистрировано в Teams _, в_ котором вы размещаете запрос проверки подлинности в Teams, пользователю не будет предложено согласие, а маркер доступа будет выдан сразу.</span><span class="sxs-lookup"><span data-stu-id="8ece3-194">¹ If your Azure AD app is registered in the _same_ tenant where you're making an authentication request in Teams, the user won't be asked to consent and will be granted an access token right away.</span></span> <span data-ttu-id="8ece3-195">Пользователям необходимо только согласие с этими разрешениями, если приложение Azure AD зарегистрировано в другом клиенте.</span><span class="sxs-lookup"><span data-stu-id="8ece3-195">Users only need to consent to these permissions if the Azure AD app is registered in a different tenant.</span></span>
> * <span data-ttu-id="8ece3-196">² при получении сообщения об ошибке, указывающей на то, что домен уже владеет и вы являетесь его владельцем, выполните процедуру, описанную в статье [Краткое руководство: Добавление настраиваемого имени домена в Azure Active Directory](/azure/active-directory/fundamentals/add-custom-domain) для регистрации домена, а затем повторите шаг 5.</span><span class="sxs-lookup"><span data-stu-id="8ece3-196">² If you get an error stating that the domain is already owned and you are the owner, follow the procedure at [Quickstart: Add a custom domain name to Azure Active Directory](/azure/active-directory/fundamentals/add-custom-domain) to register the domain, and then repeat step 5, above.</span></span> <span data-ttu-id="8ece3-197">(Эта ошибка также может возникать, если вы не вошли в учетную запись администратора в Office 365.</span><span class="sxs-lookup"><span data-stu-id="8ece3-197">(This error can also occur if you aren't signed in with Admin credentials in the Office 365 tenancy).</span></span>
> * <span data-ttu-id="8ece3-198">Если имя участника-пользователя (имя участника-пользователя) не получено в возвращенном маркере доступа, его можно добавить в качестве [необязательного утверждения](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8ece3-198">If you are not receiving the UPN (User Principal Name) in the returned access token, you can add it as an [optional claim](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) in Azure AD.</span></span>

### <a name="2-update-your-microsoft-teams-application-manifest"></a><span data-ttu-id="8ece3-199">2. Обновление манифеста приложения Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="8ece3-199">2. Update your Microsoft Teams application manifest</span></span>

<span data-ttu-id="8ece3-200">Добавьте новые свойства в манифест Microsoft teams:</span><span class="sxs-lookup"><span data-stu-id="8ece3-200">Add new properties to your Microsoft Teams manifest:</span></span>

* <span data-ttu-id="8ece3-201">**WebApplicationInfo** — родительский элемент следующих элементов:</span><span class="sxs-lookup"><span data-stu-id="8ece3-201">**WebApplicationInfo** - The parent of the following elements:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="8ece3-202">**ID** — идентификатор клиента приложения.</span><span class="sxs-lookup"><span data-stu-id="8ece3-202">**id** - The client ID of the application.</span></span> <span data-ttu-id="8ece3-203">Это идентификатор приложения, полученный в ходе регистрации приложения с помощью Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8ece3-203">This is the application ID that you obtained as part of registering the application with Azure AD.</span></span>
>* <span data-ttu-id="8ece3-204">**Resource** — домен и поддомен приложения.</span><span class="sxs-lookup"><span data-stu-id="8ece3-204">**resource** - The domain and subdomain of your application.</span></span> <span data-ttu-id="8ece3-205">Это тот же URI (включая `api://` протокол), который вы зарегистрировали при создании `scope` на шаге 6.</span><span class="sxs-lookup"><span data-stu-id="8ece3-205">This is the same URI (including the `api://` protocol) that you registered when creating your `scope` in step 6 above.</span></span> <span data-ttu-id="8ece3-206">Не следует включать `access_as_user` путь в ресурс.</span><span class="sxs-lookup"><span data-stu-id="8ece3-206">You shouldn't include the `access_as_user` path in your resource.</span></span> <span data-ttu-id="8ece3-207">Доменная часть этого URI должна быть соотнесена с доменом, включая все поддомены, используемые в URL-адресах манифеста приложения Teams.</span><span class="sxs-lookup"><span data-stu-id="8ece3-207">The domain part of this URI should match the domain, including any subdomains, used in the URLs of your Teams application manifest.</span></span>

```json
"webApplicationInfo": {
  "id": "00000000-0000-0000-0000-000000000000",
  "resource": "api://subdomain.example.com/00000000-0000-0000-0000-000000000000"
}
```

> [!NOTE]
>
>* <span data-ttu-id="8ece3-208">Ресурс для приложения AAD обычно является корнем URL-адреса сайта и appID (например, `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` ).</span><span class="sxs-lookup"><span data-stu-id="8ece3-208">The resource for an AAD app will usually be the root of its site URL and the appID (e.g. `api://subdomain.example.com/00000000-0000-0000-0000-000000000000`).</span></span> <span data-ttu-id="8ece3-209">Кроме того, мы используем это значение, чтобы убедиться, что ваш запрос поступает из того же домена.</span><span class="sxs-lookup"><span data-stu-id="8ece3-209">We also use this value to ensure your request is coming from the same domain.</span></span> <span data-ttu-id="8ece3-210">Поэтому убедитесь, что на `contentURL` вкладке используются те же домены, что и в свойстве ресурса.</span><span class="sxs-lookup"><span data-stu-id="8ece3-210">Therefore, make sure that the `contentURL` for your tab uses the same domains as your resource property.</span></span>
>* <span data-ttu-id="8ece3-211">Для реализации этого поля необходимо использовать манифест версии 1,5 или более поздней `webApplicationInfo` .</span><span class="sxs-lookup"><span data-stu-id="8ece3-211">You need to use manifest version 1.5 or higher to implement the `webApplicationInfo` field.</span></span>

### <a name="3-get-an-authentication-token-from-your-client-side-code"></a><span data-ttu-id="8ece3-212">3. получение маркера проверки подлинности из клиентского кода</span><span class="sxs-lookup"><span data-stu-id="8ece3-212">3. Get an authentication token from your client-side code</span></span>

<span data-ttu-id="8ece3-213">Вот как выглядит API проверки подлинности:</span><span class="sxs-lookup"><span data-stu-id="8ece3-213">Here's what the authentication API looks like:</span></span>

```javascript
var authTokenRequest = {
  successCallback: function(result) { console.log("Success: " + result); },
  failureCallback: function(error) { console.log("Failure: " + error); },
};
microsoftTeams.authentication.getAuthToken(authTokenRequest);
```

<span data-ttu-id="8ece3-214">Если `getAuthToken` требуется согласие пользователя на вызовы (для разрешений на уровне пользователей), будет отображаться диалоговое окно, позволяющее пользователю предоставить дополнительное согласие.</span><span class="sxs-lookup"><span data-stu-id="8ece3-214">When you call `getAuthToken` - and additional user consent is required (for user-level permissions) - we will show a dialog to the user encouraging them to grant additional consent.</span></span> 

<span data-ttu-id="8ece3-215">После получения маркера доступа в обратном вызове для успешного выполнения можно декодировать маркер доступа для просмотра утверждений, связанных с этим маркером.</span><span class="sxs-lookup"><span data-stu-id="8ece3-215">Once you've received the access token in the success callback you can decode the access token to view the claims associated with that token.</span></span> <span data-ttu-id="8ece3-216">(При необходимости можно вручную скопировать или вставить маркер доступа в средство, например [JWT.IO](https://jwt.io/) , чтобы проверить его содержимое).</span><span class="sxs-lookup"><span data-stu-id="8ece3-216">(Optionally, you can manually copy/paste the access token into a tool such as [JWT.io](https://jwt.io/) to inspect its contents).</span></span> <span data-ttu-id="8ece3-217">Если имя участника-пользователя (имя участника-пользователя) не получено в возвращенном маркере доступа, его можно добавить в качестве [необязательного утверждения](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8ece3-217">If you are not receiving the UPN (User Principal Name) in the returned access token, you can add it as an [optional claim](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) in Azure AD.</span></span>

<p>
    <img src="~/assets/images/tabs/tabs-sso-prompt.png" alt="Tab single sign-on SSO dialog prompt" width="75%"/>
</p>

## <a name="sample-code"></a><span data-ttu-id="8ece3-218">Пример кода</span><span class="sxs-lookup"><span data-stu-id="8ece3-218">Sample code</span></span>

<span data-ttu-id="8ece3-219">Посетите наш пример приложения: [Пример использования мстеамс на вкладках SSO — NodeJS](https://github.com/OfficeDev/msteams-tabs-sso-sample-nodejs)</span><span class="sxs-lookup"><span data-stu-id="8ece3-219">Visit our sample application: [MSTeams Tabs SSO Sample - Nodejs](https://github.com/OfficeDev/msteams-tabs-sso-sample-nodejs)</span></span>

<span data-ttu-id="8ece3-220">В этом файле содержатся сведения о настройке среды разработки и настройке приложения в Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8ece3-220">The README explains how to set up your development environment and how to configure your application in Azure AD.</span></span> <span data-ttu-id="8ece3-221">Кроме того, вы можете получить дополнительные сведения о том, как пример структурирован в [разделе Структура приложения](https://github.com/OfficeDev/msteams-tabs-sso-sample-nodejs#app-structure) , чтобы помочь вам ознакомиться с базой кода.</span><span class="sxs-lookup"><span data-stu-id="8ece3-221">You can also find further information on how the sample is structured in the [app structure section](https://github.com/OfficeDev/msteams-tabs-sso-sample-nodejs#app-structure) to help familiarize yourself with the codebase.</span></span>

## <a name="known-limitations"></a><span data-ttu-id="8ece3-222">Известные ограничения</span><span class="sxs-lookup"><span data-stu-id="8ece3-222">Known Limitations</span></span>

### <a name="apps-that-require-additional-microsoft-graph-scopes"></a><span data-ttu-id="8ece3-223">Приложения, для которых требуются дополнительные области Microsoft Graph</span><span class="sxs-lookup"><span data-stu-id="8ece3-223">Apps that require additional Microsoft Graph Scopes</span></span>

<span data-ttu-id="8ece3-224">Наша текущая реализация SSO только предоставляет согласие на доступ на уровне пользователей: Электронная почта, профиль, offline_access, OpenId — не для других API (например, User. Read или mail. Read).</span><span class="sxs-lookup"><span data-stu-id="8ece3-224">Our current implementation for SSO only grants consent for user-level permissions — email, profile, offline_access, OpenId — not for other APIs (such as User.Read or Mail.Read).</span></span> <span data-ttu-id="8ece3-225">Если ваше приложение нуждается в дальнейших областях Microsoft Graph, вот несколько способов решения этих проблем:</span><span class="sxs-lookup"><span data-stu-id="8ece3-225">If your app needs further Microsoft Graph scopes, here are some enabling workarounds:</span></span>

#### <a name="tenant-admin-consent"></a><span data-ttu-id="8ece3-226">Согласие администратора клиента</span><span class="sxs-lookup"><span data-stu-id="8ece3-226">Tenant Admin Consent</span></span>

<span data-ttu-id="8ece3-227">Самый простой подход — предоставить администратору клиента предварительное согласие от имени Организации.</span><span class="sxs-lookup"><span data-stu-id="8ece3-227">The simplest approach is to get a tenant admin to pre-consent on behalf of the organization.</span></span> <span data-ttu-id="8ece3-228">Это означает, что пользователям не нужно будет согласиться с этими областями, и вы сможете бесплатно обмениваться [данными на стороне](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow)сервера маркеров с помощью Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8ece3-228">This means users won’t have to consent to these scopes and you can then be free to exchange the token server side using Azure AD’s [on-behalf-of flow](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow).</span></span> <span data-ttu-id="8ece3-229">Это решение является приемлемым для внутренних бизнес-приложений, но может быть недостаточно для сторонних разработчиков, которые могут не полагаться на утверждение администратором клиента.</span><span class="sxs-lookup"><span data-stu-id="8ece3-229">This workaround is acceptable for internal line-of-business applications but may not be enough for third-party developers who may not be able to rely on tenant admin approval.</span></span>

<span data-ttu-id="8ece3-230">Простой способ отправки от имени Организации (в качестве администратора клиента):</span><span class="sxs-lookup"><span data-stu-id="8ece3-230">A simple way of consenting on behalf of an organization (as a tenant admin) is to visit:</span></span>

* `https://login.microsoftonline.com/common/adminconsent?client_id=<AAD_App_ID>`

#### <a name="asking-for-additional-consent-using-the-auth-api"></a><span data-ttu-id="8ece3-231">Запрос дополнительного согласия с помощью API проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="8ece3-231">Asking for additional consent using the Auth API</span></span>

<span data-ttu-id="8ece3-232">Другой способ получить дополнительные области Microsoft Graph — Показать диалоговое окно согласия, используя существующий [подход проверки подлинности Azure AD на основе веб-службы](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-popup-page) .</span><span class="sxs-lookup"><span data-stu-id="8ece3-232">Another approach for getting additional Microsoft Graph scopes is to present a consent dialog using our existing [web-based Azure AD authentication approach](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-popup-page) which involves popping up an Azure AD consent dialog.</span></span> <span data-ttu-id="8ece3-233">Вот некоторые важные дополнения:</span><span class="sxs-lookup"><span data-stu-id="8ece3-233">There are some notable additions:</span></span>

1. <span data-ttu-id="8ece3-234">Для `getAuthToken()` получения доступа к дополнительным API Microsoft Graph необходимо, чтобы полученный [на](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow) сервере маркер был на сервере с помощью Azure AD.</span><span class="sxs-lookup"><span data-stu-id="8ece3-234">The token retrieved using `getAuthToken()` needs to be exchanged server-side using Azure AD [on-behalf-of flow](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow) to get access to those additional Microsoft Graph APIs.</span></span>
    * <span data-ttu-id="8ece3-235">Обязательно используйте конечную точку V2 Microsoft Graph для этого Exchange</span><span class="sxs-lookup"><span data-stu-id="8ece3-235">Be sure to use the v2 Microsoft Graph endpoint for this exchange</span></span>
2. <span data-ttu-id="8ece3-236">В случае сбоя Exchange Azure AD возвратит недопустимое исключение granting.</span><span class="sxs-lookup"><span data-stu-id="8ece3-236">If the exchange fails, Azure AD will return an invalid grant exception.</span></span> <span data-ttu-id="8ece3-237">Как правило, существует одно из двух сообщений об `invalid_grant` ошибках. `interaction_required`</span><span class="sxs-lookup"><span data-stu-id="8ece3-237">There are usually one of two error messages: `invalid_grant` or `interaction_required`</span></span>
3. <span data-ttu-id="8ece3-238">При сбое Exchange необходимо запросить дополнительное разрешение.</span><span class="sxs-lookup"><span data-stu-id="8ece3-238">When the exchange fails, then you need to ask for additional consent.</span></span> <span data-ttu-id="8ece3-239">Мы рекомендуем отобразить пользовательский интерфейс, который просит пользователя предоставить дополнительное согласие.</span><span class="sxs-lookup"><span data-stu-id="8ece3-239">We recommend showing some UI asking the user to grant additional consent.</span></span> <span data-ttu-id="8ece3-240">Этот пользовательский интерфейс должен включать кнопку, которая запускает диалоговое окно согласия Azure AD с помощью [API проверки подлинности Azure AD](~/concepts/authentication/auth-silent-aad.md).</span><span class="sxs-lookup"><span data-stu-id="8ece3-240">This UI should include a button that triggers an Azure AD consent dialog using our [Azure AD authentication API](~/concepts/authentication/auth-silent-aad.md).</span></span>
4. <span data-ttu-id="8ece3-241">При получении запроса на получение дополнительного согласия от Azure AD необходимо включить `prompt=consent` [параметр запроса с параметром строки запроса](~/tabs/how-to/authentication/auth-silent-aad.md#get-the-user-context) в Azure AD, в противном случае Azure AD не запрашивает дополнительные области.</span><span class="sxs-lookup"><span data-stu-id="8ece3-241">When asking for additional consent from Azure AD, you need to include `prompt=consent` in your [query-string-parameter](~/tabs/how-to/authentication/auth-silent-aad.md#get-the-user-context) to Azure AD otherwise Azure AD will not ask for the additional scopes.</span></span>
    * <span data-ttu-id="8ece3-242">Вместо: `?scope={scopes}`</span><span class="sxs-lookup"><span data-stu-id="8ece3-242">Instead of: `?scope={scopes}`</span></span>
    * <span data-ttu-id="8ece3-243">Используйте следующую команду: `?prompt=consent&scope={scopes}`</span><span class="sxs-lookup"><span data-stu-id="8ece3-243">Use this: `?prompt=consent&scope={scopes}`</span></span>
    * <span data-ttu-id="8ece3-244">Убедитесь, что `{scopes}` включены все области, на которые вы запрашиваете пользователя (пример: mail. Read или User. Read).</span><span class="sxs-lookup"><span data-stu-id="8ece3-244">Be sure that `{scopes}` includes all the scopes you are prompting the user for (ex: Mail.Read or User.Read).</span></span>
5. <span data-ttu-id="8ece3-245">После того как пользователь выдает дополнительное разрешение, повторите запрос от имени "от имени", чтобы получить доступ к этим дополнительным API.</span><span class="sxs-lookup"><span data-stu-id="8ece3-245">Once the user has granted additional permission, retry the on-behalf-of-flow to get access to these additional APIs.</span></span>

### <a name="non-azure-ad-authentication"></a><span data-ttu-id="8ece3-246">Проверка подлинности без Azure AD</span><span class="sxs-lookup"><span data-stu-id="8ece3-246">Non-Azure AD Authentication</span></span>

<span data-ttu-id="8ece3-247">Описанное выше решение для проверки подлинности работает только для приложений и служб, поддерживающих Azure AD в качестве поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="8ece3-247">The above-described authentication solution only works for apps and services that support Azure AD as an identity provider.</span></span> <span data-ttu-id="8ece3-248">Приложения, которые хотят пройти проверку подлинности с помощью служб на основе Azure AD, должны продолжать использовать веб- [процесс проверки подлинности](~/concepts/authentication.md)на основе всплывающих окон.</span><span class="sxs-lookup"><span data-stu-id="8ece3-248">Apps that want to authenticate using non-Azure AD based services need to continue using the pop-up-based [web authentication flow](~/concepts/authentication.md).</span></span>
