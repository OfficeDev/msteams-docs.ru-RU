---
title: Поддержка единого входного знака для вкладок
description: Описывает один вход (SSO)
ms.topic: how-to
ms.localizationpriority: medium
keywords: группы проверки подлинности SSO AAD api с одним входом
ms.openlocfilehash: f935b9632c083fe3c78f0b134c398e51d88b9cdc
ms.sourcegitcommit: a2d7d2bdf4b056b35f29c6fdb315bc7dc28b6f6f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/20/2021
ms.locfileid: "61569506"
---
# <a name="single-sign-on-sso-support-for-tabs"></a>Поддержка единого входного знака (SSO) для вкладок

Пользователи во время Microsoft Teams с помощью своей учетной записи Office 365, Outlook или microsoft, вы можете воспользоваться преимуществами, разрешив одному входу авторизировать вкладку Teams или модуль задач на настольных компьютерах или мобильных клиентах. Если пользователь включит один раз, он не должен снова входить на другом устройстве, так как он автоматически входит. Кроме того, маркер доступа предварительно загружается для повышения производительности и времени загрузки.

> [!NOTE]
> **Teams клиентских версий, поддерживающих SSO**  
>
> ✔Teams для Android (1416/1.0.0.2020073101 и более поздней версии)
>
> ✔Teams для iOS _(Версия_: 2.0.18 и более поздней версии)  
> 
> ✔Teams JavaScript SDK _(Версия_: 1.10 и более поздней версии) для SSO для работы в боковой панели собраний. 
>
> Для наилучшего использования Teams используйте последнюю версию iOS и Android.

> [!NOTE]
> **Быстрый запуск**  
>
> Самый простой путь для начала работы с вкладками SSO — это Teams для Visual Studio Code. Дополнительные сведения см. в [ссылке SSO с Teams и Visual Studio Code для вкладок](../../../toolkit/visual-studio-code-tab-sso.md)

## <a name="how-sso-works-at-runtime"></a>Принцип работы единого входа во время выполнения

На следующем изображении показано, как работает процесс SSO:

<!-- markdownlint-disable MD033 -->
<img src="~/assets/images/tabs/tabs-sso-diagram.png" alt="Tab single sign-on SSO diagram" width="75%"/>

1. На вкладке выполняется вызов JavaScript в `getAuthToken()`. `getAuthToken()`сообщает Teams, чтобы получить маркер доступа для приложения вкладки.
2. Если текущий пользователь впервые использует приложение вкладки, в случае необходимости требуется запрос на согласие. Кроме того, существует запрос на обработку этапной проверки подлинности, например двух факторов проверки подлинности.
3. Teams запрашивает маркер доступа к вкладке из конечной точки Azure Active Directory (AAD) для текущего пользователя.
4. AAD отправляет маркер доступа к вкладке в Teams приложение.
5. Teams отправляет маркер доступа на вкладку как часть объекта результатов, возвращаемого `getAuthToken()` вызовом.
6. Маркер разборается в приложении вкладок с помощью JavaScript для извлечения необходимых сведений, например адреса электронной почты пользователя.

> [!NOTE]
> Допустимо только для согласия на ограниченный набор API на уровне пользователя, который является электронной почтой, профилем, offline_access `getAuthToken()` и OpenId. Он не используется для дальнейших Graph областей, таких как `User.Read` или `Mail.Read` . Предлагаемые обходные пути см. в примере [Get an access token with Graph разрешений.](#get-an-access-token-with-graph-permissions)

API SSO также работает в [модулях задач,](../../../task-modules-and-cards/what-are-task-modules.md) встраив веб-контент.

## <a name="develop-an-sso-microsoft-teams-tab"></a>Разработка вкладки SSO Microsoft Teams

В этом разделе описываются задачи, связанные с созданием вкладки Teams, использующей SSO. Эти задачи являются языковыми и framework-agnostic.

### <a name="1-create-your-aad-application"></a>1. Создание AAD приложения

> [!NOTE]
> Необходимо знать несколько важных ограничений:
>
> * Поддерживаются только разрешения Graph API на уровне пользователей, то есть электронная почта, профиль, offline_access, OpenId. Если вы должны иметь доступ к другим Graph области, такие как или , см. статью Получить маркер доступа с `User.Read` `Mail.Read` Graph [разрешений](#get-an-access-token-with-graph-permissions).
> * Важно, чтобы доменное имя вашего приложения было таким же, как и доменное имя, которое вы зарегистрировали для AAD приложения.
> * В настоящее время несколько доменов в приложении не поддерживаются.
> * Пользователь должен `accessTokenAcceptedVersion` настроиться `2` на новое приложение.

**Регистрация приложения на портале AAD**

1. Регистрация нового приложения на [портале AAD app Registrations.](https://go.microsoft.com/fwlink/?linkid=2083908)
1. Выберите **новую регистрацию.** Появится **страница "Регистрация** приложения".
1. На странице **Регистрация приложения** введите следующие значения:
    1. Введите **имя** приложения.
    2. Выберите **поддерживаемые типы учетных записей,** выберите один клиент или многотенантный тип учетной записи. ¹
    * Оставьте поле **URI перенаправления** пустым.
    3. Нажмите кнопку **Зарегистрировать**.
1. На странице обзор скопируйте и сохраните ID приложения **(клиента).** Вы должны иметь его позже при обновлении манифеста Teams приложения.
1. В разделе **Управление** выберите **Предоставление API**.

    > [!NOTE]
    > Если вы строите приложение с помощью бота и вкладки, введите URI ID приложения как `api://fully-qualified-domain-name.com/botid-{YourBotId}` .

1. Выберите **ссылку Set** для создания URI ID приложения в виде `api://{AppID}` . Вставьте полностью квалифицированное доменное имя с переназначенной чертой "/" с добавлением до конца между двойными полосами вперед и GUID. Весь ID должен иметь форму `api://fully-qualified-domain-name.com/{AppID}` . ² Например, `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` . Полностью квалифицированное доменное имя — это доступное для чтения имя домена, из которого обслуживается ваше приложение. Если вы используете службу тоннелей, например ngrok, необходимо обновлять это значение всякий раз, когда изменяется поддомен ngrok.
1. Нажмите **Добавить область**. На открываемой панели **введите access_as_user** имя **Scope**.
1. В поле **Кто можно дать согласие?** введите **администраторов и пользователей**.
1. Введите сведения в полях для настройки подсказок согласия администратора и пользователя со значениями, подходящими для `access_as_user` области:
    * **Название согласия администратора:** Teams может получить доступ к профилю пользователя.
    * **Описание согласия администратора:** Teams может вызывать веб-API приложения в качестве текущего пользователя.
    * **Название согласия пользователя:** Teams получить доступ к вашему профилю и сделать запросы от вашего имени.
    * **Описание согласия пользователя:** Teams может вызывать API этого приложения с тем же правам, что и у вас.
1. Убедитесь, что параметру **Состояние** присвоено значение **Включено**.
1. Выберите **Добавить область,** чтобы сохранить сведения. Доменная часть имени **Scope,** отображаемая ниже текстового поля, должна автоматически соответствовать набору URI **ID** приложения на предыдущем шаге с приложением до `/access_as_user` `api://subdomain.example.com/00000000-0000-0000-0000-000000000000/access_as_user` конца.
1. В разделе **Авторизованные клиентские приложения** определите приложения, которые необходимо авторизировать для веб-приложения вашего приложения. Выберите **Добавление клиентского приложения.** Введите каждый из следующих клиентских ИД и выберите авторизованную область, созданную на предыдущем шаге:
    * `1fec8e78-bce4-4aaf-ab1b-5451cc387264`для Teams или настольного приложения.
    * `5e3ce6c0-2b1f-4285-8d4b-75ee78787346`для Teams веб-приложения.
1. Перейдите **к разрешениям API.** Выберите **Добавить разрешение** Microsoft  >  **Graph**  >  **делегирования** разрешений, а затем добавьте следующие разрешения из Graph API:
    * User.Read включен по умолчанию
    * email
    * offline_access
    * OpenId
    * profile

1. Переход к **проверке подлинности.**

    > [!IMPORTANT]
    > Если приложению не было предоставлено согласие ИТ-администратора, пользователи должны предоставить согласие при первом использовании приложения.

    Чтобы ввести URI перенаправления:
    * Выберите **Добавить платформу.**
    * Выберите **веб.**
    * Введите **URI перенаправления** для приложения. Это полное доменное имя, которое вы ввели в шаге 5. Далее следует маршрут API, куда отправляется ответ на проверку подлинности. Если вы следуете любому из Teams, URI `https://subdomain.example.com/auth-end` — это . Дополнительные сведения см. в потоке кода авторизации [OAuth 2.0.](/azure/active-directory/develop/v2-oauth2-auth-code-flow)

    > [!NOTE]
    > Неявный грант не требуется для вкладки SSO.

Поздравляем! Вы выполнили необходимые условия регистрации приложений для продолжения работы с приложением SSO вкладки.

> [!NOTE]
>
> * ¹ Если ваше AAD зарегистрировано в том же клиенте, где вы делаете запрос на проверку подлинности в Teams, пользователю не может быть предложено дать согласие и ему сразу же будет предоставлен маркер доступа. Пользователи соглашаются на эти разрешения только в том случае, AAD приложение зарегистрировано в другом клиенте.
> * ² Если пользовательский домен не добавлен в AAD, вы получите ошибку, указывав, что имя хоста не должно основываться на уже собственном домене. Чтобы добавить настраиваемый домен AAD и зарегистрировать его, выполните добавление настраиваемой процедуры AAD доменного имени, а затем [повторите](/azure/active-directory/fundamentals/add-custom-domain) шаг 5. Вы также можете получить эту ошибку, если вы не подписаны с учетными данными администратора в Office 365 аренды.
> * Если вы не получаете основное имя пользователя (UPN) в маркере возвращенного [](/azure/active-directory/develop/active-directory-optional-claims) доступа, вы можете добавить его в качестве необязательных утверждений в AAD.

### <a name="2-update-your-teams-application-manifest"></a>2. Обновление манифеста Teams приложения

Используйте следующий код, чтобы добавить новые свойства в манифест Teams:

```json
"webApplicationInfo": {
  "id": "00000000-0000-0000-0000-000000000000",
  "resource": "api://subdomain.example.com/00000000-0000-0000-0000-000000000000"
}
```

* **WebApplicationInfo** является родителем следующих элементов:

> [!div class="checklist"]
> * **id** — ID клиента приложения. Это ИД приложения, полученный в рамках регистрации приложения в Azure AD.
>* **ресурс** — домен и поддомен приложения. Это тот же URI (включая протокол), который вы зарегистрировали при создании вашего шага `api://` `scope` 6. Не следует включать путь `access_as_user` в ресурс. Доменная часть этого URI должна соответствовать домену, в том числе любым поддоменам, используемым в URL-адресах манифеста Teams приложения.

> [!NOTE]
>
>* Ресурс для AAD обычно является корнем URL-адреса сайта и приложения `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` (например). Это значение также используется для обеспечения того, чтобы ваш запрос был исходя из того же домена. Убедитесь, `contentURL` что вкладка использует те же домены, что и свойство ресурса.
>* Для реализации поля необходимо использовать манифестную версию 1.5 или `webApplicationInfo` более.

### <a name="3-get-an-access-token-from-your-client-side-code"></a>3. Получите маркер доступа из клиентского кода

Используйте следующий API проверки подлинности:

```javascript
var authTokenRequest = {
  successCallback: function(result) { console.log("Success: " + result); },
  failureCallback: function(error) { console.log("Failure: " + error); }
};
microsoftTeams.authentication.getAuthToken(authTokenRequest);
```

Когда для получения разрешений на уровне пользователя требуется согласие пользователя, пользователю отображается диалоговое окно для `getAuthToken` предоставления согласия.

После получения маркера доступа при вызове успешного вызова расшифруем маркер доступа для просмотра утверждений для этого маркера. Необязательно вручную скопировать и вклеить маркер доступа в средство, например [jwt.ms.](https://jwt.ms/) Если вы не получаете upN в маркере возвращенного доступа, [](/azure/active-directory/develop/active-directory-optional-claims) добавьте его в качестве необязательных утверждений в AAD. Дополнительные сведения см. в [том, что касается маркеров доступа.](/azure/active-directory/develop/access-tokens)

<p>
    <img src="~/assets/images/tabs/tabs-sso-prompt.png" alt="Tab single sign-on SSO dialog prompt" width="75%"/>
</p>

## <a name="code-sample"></a>Пример кода

|**Название примера**|**Описание**|**C#**|**Node.js**|
|---------------|---------------|------|--------------|
| Tab SSO |Microsoft Teams пример приложения для вкладок Azure AD SSO| [View](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/tab-sso/csharp)|[Просмотр](https://github.com/OfficeDev/Microsoft-Teams-Samples/blob/main/samples/tab-sso/nodejs), </br>[Teams набор средств](../../../toolkit/visual-studio-code-tab-sso.md)|

## <a name="known-limitations"></a>Известные ограничения

### <a name="get-an-access-token-with-graph-permissions"></a>Получите маркер доступа с Graph разрешениями

Наша текущая реализация для SSO предоставляет согласие только для разрешений на уровне пользователей, которые не могут быть Graph вызовов. Чтобы получить разрешения (области), необходимые для Graph вызова, решения SSO должны реализовать настраиваемую веб-службу для обмена маркера, получаемого из Teams JavaScript SDK, на маркер, который включает необходимые области. Это выполняется с AAD от [имени потока](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow).

#### <a name="tenant-admin-consent"></a>Согласие администратора клиента

Простой способ согласия от имени организации в качестве администратора клиента — обратиться к `https://login.microsoftonline.com/common/adminconsent?client_id=<AAD_App_ID>` .

#### <a name="ask-for-consent-using-the-auth-api"></a>Запрос согласия с помощью API Auth

Другой подход для получения Graph области заключается в том, чтобы представить диалоговое окно согласия с помощью нашего существующего веб-подхода к проверке подлинности [Azure AD.](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-pop-up-page) Этот подход предполагает создание диалогового окна согласия Azure AD.

**Запрос дополнительного согласия с помощью API Auth**

1. Полученный маркер должен быть обменялся сервером на стороне AAD от имени потока, чтобы получить доступ к другим Graph `getAuthToken()` API. [](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow) Убедитесь, что вы используете конечную точку v2 Graph для этого обмена.
2. Если биржа не удается, AAD возвращает недействительные исключения гранта. Обычно существует одно из двух сообщений об ошибке или `invalid_grant` `interaction_required` .
3. В случае сбой обмена необходимо обратиться за согласием. Покажите какой-либо пользовательский интерфейс (пользовательский интерфейс) с просьбой предоставить ему другое согласие. Этот пользовательский интерфейс должен включать кнопку, которая запускает диалоговое окно AAD согласия с помощью [AAD API проверки подлинности.](~/concepts/authentication/auth-silent-aad.md)
4. При запросе большего согласия AAD необходимо включить в параметр `prompt=consent` [запроса строку](~/tabs/how-to/authentication/auth-silent-aad.md#get-the-user-context) AAD, в противном случае AAD не запрашивает другие области.
    * Вместо `?scope={scopes}`
    * Используйте это `?prompt=consent&scope={scopes}`
    * Убедитесь, что в него включены все области, которые вы подсказывая `{scopes}` пользователю, например, Mail.Read или User.Read.
5. После предоставления пользователем дополнительных разрешений повторно обнажь поток от имени, чтобы получить доступ к другим API.

### <a name="non-aad-authentication"></a>Проверка подлинности AAD без проверки подлинности

Вышеуказанное решение проверки подлинности работает только для приложений и служб, AAD как поставщика удостоверений. Приложения, которые хотят проверить подлинность с помощью не AAD служб, должны продолжать использовать всплывающий поток [веб-проверки подлинности.](~/concepts/authentication.md)

> [!NOTE]
> SSO поддерживается для приложений, которые принадлежат AAD B2C.

## <a name="step-by-step-guide"></a>Пошаговые инструкции

Следуйте [пошаговом руководстве по](../../../sbs-tabs-and-messaging-extensions-with-sso.yml) проверке подлинности вкладок и расширений обмена сообщениями.

## <a name="see-also"></a>См. также
[Teams Бот с одним входом](../../../sbs-bots-with-sso.yml)