---
title: Поддержка единого входного знака для вкладок
description: Описывает один вход (SSO)
ms.topic: how-to
keywords: группы проверки подлинности SSO AAD единого api для входов
ms.openlocfilehash: 7b8406473b8356b9c26948641b49f7e1239e697a
ms.sourcegitcommit: 5cb3453e918bec1173899e7591b48a48113cf8f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/04/2021
ms.locfileid: "50449264"
---
# <a name="single-sign-on-sso-support-for-tabs"></a>Поддержка единого входного знака (SSO) для вкладок

Пользователи во входе в Microsoft Teams через свои учетные записи в работе, школе или Microsoft (Office 365, Outlook и т.д.). Вы можете воспользоваться этим, разрешив одному входу авторизировать вкладку Microsoft Teams (или модуль задач) на настольных компьютерах или мобильных клиентах. Таким образом, если пользователь соглашается использовать ваше приложение, он не должен будет снова соглашаться на другое устройство — они будут подписаны автоматически. Кроме того, мы предоформим маркер доступа, чтобы повысить производительность и время загрузки.

> [!NOTE]
> **Команды мобильных клиентских версий, поддерживающих SSO**  
>
> ✔Teams для Android (1416/1.0.0.2020073101 и более поздней версии)
>
> ✔Teams для iOS _(Версия_: 2.0.18 и более поздней версии)  
>
> Чтобы лучше работать с Teams, используйте последнюю версию iOS и Android.

> [!NOTE]
> **Быстрый запуск**  
>
> Самый простой путь к началу работы с SSO вкладки — это с помощью microsoft Teams набор средств для Visual Studio code. [Подробнее](../../../toolkit/visual-studio-code-tab-sso.md)

## <a name="how-sso-works-at-runtime"></a>Принцип работы единого входа во время выполнения

На следующей схеме показано, как работает процесс SSO:

<!-- markdownlint-disable MD033 -->
<img src="~/assets/images/tabs/tabs-sso-diagram.png" alt="Tab single sign-on SSO diagram" width="75%"/>

1. На вкладке выполнен вызов JavaScript для `getAuthToken()` . Это указывает Teams на получение маркера проверки подлинности для приложения вкладки.
2. Если текущий пользователь впервые использовал приложение вкладки, будет предложен запрос на согласие (если требуется согласие) или обработку этапной проверки подлинности (например, двух факторов проверки подлинности).
3. Teams запрашивает маркер приложения вкладок из конечной точки Azure AD для текущего пользователя.
4. Azure AD отправляет маркер приложения-вкладки в приложение Teams.
5. Teams отправляет маркер приложения вкладок на вкладку как часть объекта результатов, возвращаемого `getAuthToken()` вызовом.
6. Маркер будет разбором в приложении вкладки с помощью JavaScript, чтобы извлечь необходимую информацию, например адрес электронной почты пользователя.

> [!NOTE]
> Это допустимо только для согласия на ограниченный набор API уровня пользователя — электронной почты, профиля, offline_access и OpenId , а не для дополнительных областей Microsoft Graph, таких как `getAuthToken()` `User.Read` или `Mail.Read` . Дополнительные области Graph см. в нашем разделе в конце этого документа для предлагаемых обходных [обходных обходов.](#apps-that-require-additional-microsoft-graph-scopes)

API SSO также будет работать в модулях [задач,](../../../task-modules-and-cards/what-are-task-modules.md) встраив веб-контент.

## <a name="develop-an-sso-microsoft-teams-tab"></a>Разработка вкладки SSO Microsoft Teams

В этом разделе описываются задачи, связанные с созданием вкладки Teams, использующей SSO. Эти задачи описаны здесь языком и framework-agnostic.

### <a name="1-create-your-azure-active-directory-azure-ad-application"></a>1. Создайте приложение Azure Active Directory (Azure AD)

#### <a name="registering-your-application-in-theazure-ad-portal-overview"></a>Регистрация приложения в обзоре[портала Azure AD:](https://azure.microsoft.com/features/azure-portal/)

1. Получите [свой ID приложения Azure AD.](/azure/active-directory/develop/howto-create-service-principal-portal#get-values-for-signing-in)
2. Укажите разрешения, необходимые приложению для конечной точки Azure AD и, необязательно, Microsoft Graph.
3. [Предоставление разрешений](/azure/active-directory/develop/howto-create-service-principal-portal#configure-access-policies-on-resources) для настольных, веб-приложений и мобильных приложений Teams.
4. Предварительно авторизуйте Teams, выбрав кнопку **Добавить** область и открываемую панель, введите в качестве `access_as_user` имени **Область.**

> [!NOTE]
> Существует ряд важных ограничений, которые необходимо иметь в виду:
>
> * Мы поддерживаем только разрешения API Microsoft Graph на уровне пользователей, например электронную почту, профиль, offline_access, OpenId. Если вам необходим доступ к другим областьм Microsoft Graph (например, или), см. в нашем рекомендуемом обходе в `User.Read` `Mail.Read` конце этой документации. [](#apps-that-require-additional-microsoft-graph-scopes)
> * Важно, чтобы доменное имя вашего приложения было таким же, как доменное имя, которое вы зарегистрировали для приложения Azure AD.
> * В настоящее время мы не поддерживаем несколько доменов в приложении.
> * Мы не поддерживаем приложения, которые используют домен, так как он является слишком распространенным и может `azurewebsites.net` быть угрозой безопасности. Тем не менее, мы активно стремимся удалить это ограничение.

#### <a name="registering-your-app-through-the-azure-active-directory-portal-in-depth"></a>Подробное регистрация приложения на портале Azure Active Directory:

1. Регистрация нового приложения на [портале Регистрации приложений Azure Active Directory.](https://go.microsoft.com/fwlink/?linkid=2083908)
2. Выберите **новую регистрацию** и на странице *регистрации приложения* установите следующие значения:
    * **Задайте** имя имени приложения.
    * Выберите **поддерживаемые типы учетных** записей (любой тип учетной записи будет работать) ¹
    * Оставьте поле **URI перенаправления** пустым.
    * Нажмите кнопку **Зарегистрировать**.
3. На странице обзор скопируйте и сохраните ID приложения **(клиента).** Он понадобится позже при обновлении манифеста приложения Teams.
4. В разделе **Управление** выберите **Предоставление API**. 
5. Выберите **ссылку Set** для создания URI ID приложения в виде `api://{AppID}` . Вставьте полностью квалифицированное доменное имя (с переназначенной чертой "/" в конце) между двумя полосами вперед и GUID. Весь ID должен иметь форму: `api://fully-qualified-domain-name.com/{AppID}` ²
    * ex: `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` .
    
    Полностью квалифицированное доменное имя — это доступное для чтения имя домена, из которого обслуживается ваше приложение. Если вы используете службу тоннелей, например ngrok, вам потребуется обновить это значение всякий раз, когда изменяется поддомен ngrok. 
6. Нажмите кнопку **Добавить область**. В открывшейся панели введите `access_as_user` в качестве параметра **Имя области**.
7. Set **Who can consent?** to `Admins and users`
8. Заполните поля для настройки подсказок согласия администратора и пользователя со значениями, подходящими для `access_as_user` области:
    * **Название согласия администратора:** Команды могут получить доступ к профилю пользователя.
    * **Описание согласия администратора.** Позволяет Teams вызывать веб-API приложения в качестве текущего пользователя.
    * **Название согласия пользователя.** Команды могут получать доступ к профиле пользователя и делать запросы от имени пользователя.
    * **Описание согласия пользователя:** Включить Teams для вызова API этого приложения с тем же правам, что и пользователь.
9. **Убедитесь, что состояние** **включено**
10. Выберите **кнопку Добавить область,** чтобы сохранить 
    * Доменная часть имени **Scope,** отображаемая чуть ниже текстового поля, должна автоматически соответствовать набору URI **ID** приложения на предыдущем шаге с приложением до `/access_as_user` конца:
        * `api://subdomain.example.com/00000000-0000-0000-0000-000000000000/access_as_user`
11. В разделе **Авторизованные клиентские приложения** определите приложения, которые необходимо авторизировать для веб-приложения вашего приложения. Выберите *Добавление клиентского приложения.* Введите каждый из следующих клиентских ИД и выберите авторизованную область, созданную на предыдущем шаге:
    * `1fec8e78-bce4-4aaf-ab1b-5451cc387264` (Teams mobile/desktop application)
    * `5e3ce6c0-2b1f-4285-8d4b-75ee78787346` (Веб-приложение Teams)
12. Перейдите **к разрешениям API.** Выберите *Добавить разрешения,* делегированные Microsoft Graph, а затем добавьте следующие разрешения из  >    >  API Microsoft Graph:
    * User.Read (включен по умолчанию)
    * рассылка
    * offline_access
    * OpenId
    * profile

13. Переход к **проверке подлинности**

    Если приложению не было предоставлено согласие ИТ-администратора, пользователи должны будут предоставить согласие при первом использовании приложения.

    Установите URI перенаправления:
    * Выберите **Добавить платформу.**
    * Выберите **веб.**
    * Введите **URI перенаправления** для приложения. Это будет страница, на которой успешный неявный поток грантов будет перенаправлять пользователя. Это будет то же полное доменное имя, которое вы ввели на шаге 5, а затем маршрут API, куда должен быть отправлен ответ на проверку подлинности. Если вы следуете за любыми примерами Teams, это будет: `https://subdomain.example.com/auth-end`

    Далее включить неявный грант, проверив следующие поля:  
    ✔ ID Token  
    ✔ маркер доступа  
    
Поздравляем! Вы выполнили необходимые условия регистрации приложений для работы с приложением SSO вкладки.     

> [!NOTE]
>
> * ¹ Если приложение Azure AD зарегистрировано в том же клиенте, где вы делаете запрос на проверку подлинности в Teams, пользователю не будет предложено дать согласие и ему сразу же будет предоставлен маркер доступа.  Пользователи должны согласиться на эти разрешения только в том случае, если приложение Azure AD зарегистрировано в другом клиенте.
> * ² Если вы получаете ошибку, указывав, что домен уже принадлежит и вы владелец, выполните процедуру в [Quickstart:](/azure/active-directory/fundamentals/add-custom-domain) Добавьте настраиваемую доменную фамилию в Azure Active Directory для регистрации домена, а затем повторите шаг 5 выше. (Эта ошибка также может возникнуть, если вы не подписаны с учетными данными администратора в аренде Office 365).
> * Если вы не получаете upN (имя пользователя) в возвращенном маркере доступа, вы можете добавить его в качестве необязательных утверждений [в](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) Azure AD.

### <a name="2-update-your-microsoft-teams-application-manifest"></a>2. Обновление манифеста приложения Microsoft Teams

Добавьте новые свойства в манифест Microsoft Teams:

* **WebApplicationInfo** — родитель следующих элементов:

> [!div class="checklist"]
> * **id** — ID клиента приложения. Это ИД приложения, полученный в рамках регистрации приложения в Azure AD.
>* **ресурс** — домен и поддомен приложения. Это тот же URI (включая протокол), который вы зарегистрировали при создании на `api://` `scope` шаге 6 выше. Не следует включать путь `access_as_user` в ресурс. Доменная часть этого URI должна соответствовать домену, в том числе любым поддоменам, используемым в URL-адресах манифеста приложения Teams.

```json
"webApplicationInfo": {
  "id": "00000000-0000-0000-0000-000000000000",
  "resource": "api://subdomain.example.com/00000000-0000-0000-0000-000000000000"
}
```

> [!NOTE]
>
>* Ресурс приложения AAD обычно является корнем URL-адреса сайта и приложения `api://subdomain.example.com/00000000-0000-0000-0000-000000000000` (например). Это значение также используется для обеспечения того, чтобы ваш запрос был исходя из того же домена. Поэтому убедитесь, что вкладка использует те же домены, что `contentURL` и свойство ресурса.
>* Для реализации поля необходимо использовать манифестную версию 1.5 или `webApplicationInfo` более.

### <a name="3-get-an-authentication-token-from-your-client-side-code"></a>3. Получите маркер проверки подлинности из клиентского кода

Вот как выглядит API проверки подлинности:

```javascript
var authTokenRequest = {
  successCallback: function(result) { console.log("Success: " + result); },
  failureCallback: function(error) { console.log("Failure: " + error); }
};
microsoftTeams.authentication.getAuthToken(authTokenRequest);
```

Когда вы звоните , и требуется дополнительное согласие пользователя (для разрешений на уровне пользователя), мы покажем диалоговое окно пользователю, поощряя его предоставить `getAuthToken` дополнительное согласие. 

После получения маркера доступа в вызове успешного вызова можно расшифровать маркер доступа для просмотра утверждений, связанных с этим маркером. Необязательно можно вручную скопировать и вклеить маркер доступа [](https://jwt.ms/) в средство, например jwt.ms для проверки его содержимого. Если вы не получаете основное имя пользователя (UPN) в возвращенном маркере доступа, вы можете добавить его в качестве необязательных утверждений [в](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims) Azure AD.

<p>
    <img src="~/assets/images/tabs/tabs-sso-prompt.png" alt="Tab single sign-on SSO dialog prompt" width="75%"/>
</p>

## <a name="code-sample"></a>Пример кода

|**Пример имени**|**Описание**|**C#**|**TypeScript**|
|---------------|---------------|------|--------------|
| Tab SSO |Пример приложения Microsoft Teams для вкладок Azure AD SSO| [View](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/tab-sso/csharp)|[Просмотр](https://github.com/OfficeDev/Microsoft-Teams-Samples/blob/main/samples/tab-sso/nodejs), </br>[Teams набор средств](../../../toolkit/visual-studio-code-tab-sso.md)|

## <a name="known-limitations"></a>Известные ограничения

### <a name="apps-that-require-additional-microsoft-graph-scopes"></a>Приложения, которые требуют дополнительных областей Microsoft Graph

Наша текущая реализация для SSO предоставляет согласие только для разрешений на уровне пользователей — электронной почты, профиля, offline_access, OpenId — не для других API (например, User.Read или Mail.Read). Если вашему приложению необходимы дополнительные области Microsoft Graph, ниже приведен ряд разрешающих обходных действий:

#### <a name="tenant-admin-consent"></a>Согласие администратора клиента

Самый простой подход — получить предварительное согласие администратора клиента от имени организации. Это означает, что пользователям не придется соглашаться на эти области, и вы можете свободно обмениваться стороной сервера маркеров с помощью потока Azure AD от [имени.](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow) Это обходное решение приемлемо для внутренних бизнес-приложений, но может оказаться недостаточно для сторонних разработчиков, которые могут не полагаться на утверждение администратора клиента.

Простой способ согласия от имени организации (в качестве администратора клиента) — посетить:

* `https://login.microsoftonline.com/common/adminconsent?client_id=<AAD_App_ID>`

#### <a name="asking-for-additional-consent-using-the-auth-api"></a>Запрос дополнительного согласия с помощью API Auth

Другой подход для получения дополнительных областей Microsoft Graph заключается в том, чтобы представить диалоговое окно согласия с помощью нашего существующего веб-подхода к проверке подлинности [Azure AD,](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-popup-page) который включает в себя создание диалогового диалога согласия Azure AD. Есть несколько заметных дополнений:

1. Маркер, полученный с помощью сервера, должен быть обменяно с помощью потока Azure AD от имени, чтобы получить доступ к дополнительным `getAuthToken()` API Microsoft [](/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow) Graph.
    * Обязательно используйте конечную точку v2 Microsoft Graph для этого обмена
2. В случае сбой обмена Azure AD возвращает недействительное исключение гранта. Обычно существует одно из двух сообщений об ошибке: `invalid_grant` или `interaction_required`
3. При сбойе обмена необходимо попросить дополнительное согласие. Рекомендуется показывать пользовательский интерфейс, запрашивая у пользователя дополнительное согласие. Этот пользовательский интерфейс должен включать кнопку, которая запускает диалоговое окно согласия Azure AD с помощью API проверки [подлинности Azure AD.](~/concepts/authentication/auth-silent-aad.md)
4. При запросе дополнительного согласия от Azure AD необходимо включить в параметры строки запроса в Azure AD, в противном случае Azure AD не будет запрашивать `prompt=consent` дополнительные области. [](~/tabs/how-to/authentication/auth-silent-aad.md#get-the-user-context)
    * Вместо: `?scope={scopes}`
    * Используйте это: `?prompt=consent&scope={scopes}`
    * Убедитесь, что в него включены все области, для которые вы подсказываете пользователю `{scopes}` (например: Mail.Read или User.Read).
5. После предоставления пользователем дополнительных разрешений повторно обнажь поток от имени, чтобы получить доступ к этим дополнительным API.

### <a name="non-azure-ad-authentication"></a>Проверка подлинности без Azure AD

Вышеуказанное решение проверки подлинности работает только для приложений и служб, поддерживаюющих Azure AD в качестве поставщика удостоверений. Приложения, которые хотят проверить подлинность с помощью служб, не использующих Azure AD, должны продолжать использовать поток веб-проверки подлинности на основе всплывающих [данных.](~/concepts/authentication.md)

> [!NOTE] 
> SSO поддерживается для приложений, которые принадлежат клиентам в клиентах Azure AD B2C.
