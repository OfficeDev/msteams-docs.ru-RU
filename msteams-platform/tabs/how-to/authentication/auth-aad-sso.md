---
title: Единый вход
description: Описание единого входа (SSO)
keywords: единый вход для проверки подлинности Teams AAD
ms.openlocfilehash: 8f9d94346aad7c096e4310f80b6cda73856afc8c
ms.sourcegitcommit: 61c93b22490526b1de87c0b14a3c7eb6e046caf6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/31/2020
ms.locfileid: "44455515"
---
# <a name="single-sign-on"></a>Единый вход

> [!NOTE]
> API единого входа в настоящее время поддерживается только в _режиме предварительного просмотра разработчика_ .

Пользователи могут войти в Microsoft Teams, используя свою рабочую или учебную учетную запись (Office 365), и использовать единый вход (SSO), чтобы авторизовать пользователя на вкладке Microsoft Teams. Это означает, что если пользователь будет использовать ваше приложение на настольном компьютере, ему не нужно будет согласиться на мобильные устройства и он будет автоматически входить в систему. 

## <a name="how-sso-works-at-runtime"></a>Принцип работы единого входа во время выполнения

На следующей схеме показано, как работает процесс единого входа.

<img src="~/assets/images/tabs/tabs-sso-diagram.png" alt="Tab single sign-on SSO diagram" width="75%"/>

1. На вкладке JavaScript вызывает Жетаустокен (). Это означает, что приложение Teams будет получать маркер проверки подлинности для приложения вкладки.
2. Если в первый раз текущий пользователь использовал вкладку приложения, ему будет предложено согласие (если требуется согласие) или требуется обработать поэтапную проверку подлинности (например, двухфакторная проверка подлинности).
3. Приложение Microsoft Teams запрашивает маркер приложения вкладки из конечной точки Azure AD версии 1.0 для текущего пользователя.
4. Azure AD отправляет маркер приложения "Вкладка" приложению Teams.
5. Приложение Microsoft Teams отправляет маркер приложения на вкладку в составе результирующего объекта, возвращаемого вызовом Жетаустокен ().
6. JavaScript в приложении TAB может проанализировать маркер и извлечь необходимые сведения, например адрес электронной почты пользователя.
    * Note: этот маркер действителен только для того, чтобы быть отправлен в ограниченный набор API уровня пользователя (например, электронная почта, профиль и т. д.), а не для последующих областей диаграммы (например, mail. Read). Предлагаемые решения можно найти в конце этого документа, если вам нужны дополнительные области диаграммы.

## <a name="develop-an-sso-microsoft-teams-tab"></a>Разработка вкладки Microsoft Teams единого входа

В этом разделе описываются задачи, связанные с созданием вкладки Microsoft Teams, использующей единый вход. Эти задачи описываются независимо от языка и платформы.

### <a name="1-create-your-aad-application-in-azure"></a>1. Создание приложения AAD в Azure

Зарегистрируйте приложение на портале регистрации для конечной точки Azure AD версии 1.0. Этот процесс занимает 5–10 минут и включает следующие задачи:

* Извлечение идентификатора приложения AAD
* Укажите разрешения, необходимые вашему приложению для конечной точки AAD (и при необходимости Microsoft Graph). 
* Предоставление доступа к вашему приложению для настольных систем, веб-приложений и мобильных приложений Microsoft Teams
* Предавторизация приложения Microsoft Teams для приложения с именем области по умолчанию `access_as_user` .

> [!NOTE]
> Вы должны знать о некоторых важных ограничениях:
>
> * Поддерживаются только разрешения API Graph на уровне пользователя, например, электронная почта, профиль, offline_access, OpenID. Если вам требуется доступ к другим областям диаграммы, ознакомьтесь с рекомендуемым обходным способом в конце этой документации.
> * Важно, чтобы доменное имя вашего приложения было зарегистрировано в приложении Azure AD. Это должно быть то же доменное имя, которое приложение выполняет при запросе маркера проверки подлинности в Teams, а также при указании свойства ресурса в манифесте Teams (Дополнительные сведения см. в следующем разделе).
> * В настоящее время не поддерживается несколько доменов для каждого приложения
> * Кроме того, мы не поддерживаем приложения, использующие `azurewebsites.net` домен, так как этот домен слишком распространен и может представлять угрозу безопасности

#### <a name="steps"></a>Шаги

1. Регистрация нового приложения в портале [регистрации приложений Azure Active Directory —](https://go.microsoft.com/fwlink/?linkid=2083908)
2. Выберите пункт "Новая регистрация". На странице Регистрация приложения задайте следующие значения:
    * Задайте **имя** для имени приложения.
    * Установка **поддерживаемых типов учетных** записей для **учетных записей в любых организациях и личных учетных записях Майкрософт**
    * Оставить **URI перенаправления** пустым
    * Выбор **регистра**
3. На странице Обзор скопируйте и сохраните **идентификатор приложения (клиента)**. Он понадобится позже при обновлении манифеста приложения Teams.
4. Выберите пункт **Предоставление API** в разделе **Управление**. Выберите ссылку **задать** , чтобы создать URI идентификатора приложения в виде `api://{AppID}` . Вставьте полное доменное имя (с символом косой черты "/") между двумя косыми чертами и GUID. Весь идентификатор должен иметь вид:`api://fully-qualified-domain-name.com/{AppID}`
    * Пример: `api://subdomain.example.com:6789/c6c1f32b-5e55-4997-881a-753cc1d563b7` .

> [!NOTE]
> Если возникает ошибка с сообщением о том, что домен уже занят, но при этом вы являетесь его владельцем, следуйте процедуре в статье [Краткое руководство. Добавление имени личного домена в Azure Active Directory](/azure/active-directory/fundamentals/add-custom-domain), чтобы зарегистрировать его, а затем повторите этот шаг. (Эта ошибка также может возникать, если вы не вошли в систему с учетными данными администратора в клиенте Office 365.

5. Нажмите кнопку **Добавить область**. В открывшейся панели введите `access_as_user` в качестве параметра **Имя области**.
6. Как определить, кому разрешено согласие? для администраторов и пользователей
7. Заполните поля для настройки запросов администратора и согласия пользователя со значениями, подходящими для `access_as_user` области. Предложения:
    * **Заголовок согласия администратора:** Teams может получить доступ к профилю пользователя
    * **Описание согласия администратора**: позволяет Teams вызывать API приложения в качестве текущего пользователя.
    * **Заголовок согласия пользователя**: teams могут получать доступ к профилю пользователя и делать запросы от вашего имени.
    * **Описание согласия пользователя:** Разрешить Teams вызывать API этого приложения с теми же правами, что и у вас
8. Убедитесь, **State** что для параметра состояние **Включено значение включено** .
9. Выберите команду " **Добавить область** "
    * Note: Доменная часть **имени области** , отображаемая под текстовым полем, должна автоматически СОПОСТАВЛЯТЬ URI **идентификатора приложения** , заданный на предыдущем шаге, с `/access_as_user` добавлением в конец, например: 
        * `api://subdomain.example.com:6789/c6c1f32b-5e55-4997-881a-753cc1d563b7/access_as_user`
10. В разделе **Авторизованные клиентские приложения** определяются приложения, которые вы хотите авторизовать для веб-приложения приложения. Необходимо ввести каждый из следующих идентификаторов:
    * `1fec8e78-bce4-4aaf-ab1b-5451cc387264`(Приложение Teams для мобильных устройств и настольных приложений)
    * `5e3ce6c0-2b1f-4285-8d4b-75ee78787346`(Веб-приложение Teams)
11. Перейдите к разделу **разрешения API**и убедитесь, что добавлены следующие разрешения.
    * User. Read (включено по умолчанию)
    * email
    * offline_access
    * openid
    * profile

### <a name="2-update-your-microsoft-teams-application-manifest"></a>2. Обновление манифеста приложения Microsoft Teams

Добавьте новые свойства в манифест Microsoft teams:

* **WebApplicationInfo** — родительский элемент для указанных ниже элементов.
* **ID** — идентификатор клиента приложения. Это идентификатор приложения, который вы получаете в процессе регистрации приложения с конечной точкой Azure AD 1,0.
* **Resource** — домен и поддомен приложения. Это тот же URI (включая `api://` протокол), который вы использовали при регистрации приложения в AAD. Доменная часть этого URI должна быть соотнесена с доменом, включая все поддомены, используемые в URL-адресах в разделе манифеста приложения Teams.

```json
"webApplicationInfo": {
  "id": "<application_GUID here>",
  "resource": "<web_API resource here>"
}
```

Примечания.

* Ресурс для приложения AAD обычно просто является корнем URL-адреса сайта и appID (например, `api://subdomain.example.com/6789/c6c1f32b-5e55-4997-881a-753cc1d563b7` ). Кроме того, мы используем это значение, чтобы убедиться, что ваш запрос поступает из того же домена. Серефор убедитесь, что на `contentURL` вкладке используются те же домены, что и в свойстве ресурса.
* Для использования этих полей необходимо использовать манифест версии 1,5 или более поздней.
* Области не поддерживаются в манифесте, а вместо этого должны быть указаны в разделе "разрешения API" на портале Azure.

### <a name="3-get-an-authentication-token-from-your-client-side-code"></a>3. получение маркера проверки подлинности из клиентского кода

Вот как выглядит API проверки подлинности:

```javascript
var authTokenRequest = {
  successCallback: function(result) { console.log("Success: " + result); },
  failureCallback: function(error) { console.log("Failure: " + error); },
};
microsoftTeams.authentication.getAuthToken(authTokenRequest);
```

Если `getAuthToken` требуется согласие пользователя на вызовы (для разрешений на уровне пользователей), будет отображаться диалоговое окно, позволяющее пользователю предоставить дополнительное согласие. 

<img src="~/assets/images/tabs/tabs-sso-prompt.png" alt="Tab single sign-on SSO dialog prompt" width="75%"/>

## <a name="demo-code"></a>Демонстрационный код

Теперь вы можете посетить наш тестовый процесс приложения [меов](https://github.com/ydogandjiev/taskmeow) и использовать манифест единого входа и извлечь `teams.auth.service.js` файл, `sso.auth.service.js` чтобы увидеть, как мы обработаем рабочий процесс проверки подлинности.

## <a name="known-limitations"></a>Известные ограничения

### <a name="apps-that-require-additional-graph-scopes"></a>Приложения, для которых требуются дополнительные области диаграммы

Наша текущая реализация единого входа предоставляет согласие для разрешений на уровне пользователя (электронная почта, профиль, offline_access, OpenID), но не для других интерфейсов API (например, mail. Read). Если вашему приложению требуются дополнительные области диаграммы, это можно сделать несколькими способами.

#### <a name="tenant-admin-consent"></a>Согласие администратора клиента

Самым простым подходом является получение администратором клиента предварительного согласия от имени Организации. Это означает, что пользователям не нужно будет согласиться с этими областями, и вы сможете бесплатно обмениваться данными на стороне сервера маркеров с помощью функции "от [имени](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow)пользователя AAD". Это решение приемлемо для внутренних бизнес-приложений, но может быть недостаточно для независимых поставщиков программного обеспечения, которые могут не полагаться на утверждение администратором клиента.

Простой способ отправки от имени Организации (в качестве администратора клиента):

* `https://login.microsoftonline.com/common/adminconsent?client_id=<AAD_App_ID>`

#### <a name="asking-for-additional-consent-using-the-auth-api"></a>Запрос дополнительного согласия с помощью API проверки подлинности

Еще один подход к получению дополнительных областей диаграммы — Показать диалоговое окно согласия, используя существующий [подход проверки подлинности AAD на основе веб-сайта](~/tabs/how-to/authentication/auth-tab-aad.md#navigate-to-the-authorization-page-from-your-popup-page) , который включает диалоговое окно согласия AAD. Вот некоторые важные дополнения:

1. Маркер, полученный с помощью Жетаустокен, должен быть серверной стороны Exchange с помощью ААДС [от имени](/azure/active-directory/develop/v1-oauth2-on-behalf-of-flow) для получения доступа к этим дополнительным API Graph.
    * Обязательно используйте конечную точку V2 Graph для этого Exchange
2. В случае сбоя Exchange в AAD возвращается недопустимое исключение granting. Как правило, существует одно из двух сообщений об `ConsentRequired` ошибках.`InteractionRequired`
3. При сбое Exchange необходимо запросить дополнительное разрешение. Мы рекомендуем отобразить пользовательский интерфейс, который просит пользователя предоставить дополнительное согласие. Этот пользовательский интерфейс должен включать кнопку, которая запускает диалоговое окно согласия AAD с помощью [API проверки подлинности AAD](~/concepts/authentication/auth-silent-aad.md).
4. При запросе дополнительного согласия от AAD необходимо включить `prompt=consent` [параметр запроса с параметром строки запроса](~/tabs/how-to/authentication/auth-silent-aad.md#get-the-user-context) в AAD, иначе AAD не запрашивает дополнительные области.
    * Вместо:`?scope={scopes}`
    * Используйте следующую команду:`?prompt=consent&scope={scopes}`
    * Убедитесь, что `{scopes}` включены все области, на которые вы запрашиваете пользователя (пример: mail. Read или User. Read).
5. После того как пользователь выдает дополнительное разрешение, повторите запрос от имени "от имени", чтобы получить доступ к этим дополнительным API.

### <a name="non-aad-authentication"></a>Проверка подлинности без AAD

Описанное выше решение для проверки подлинности работает только для приложений и служб, поддерживающих Azure AD в качестве поставщика удостоверений. Приложения, которые хотят пройти проверку подлинности с помощью служб на основе AAD, должны продолжать использовать [веб-процесс проверки подлинности](~/concepts/authentication.md)на основе всплывающих окон.
