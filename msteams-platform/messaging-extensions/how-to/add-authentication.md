---
title: Добавление проверки подлинности к своему расширению обмена сообщениями
author: clearab
description: Добавление проверки подлинности к расширению системы обмена сообщениями
ms.topic: conceptual
ms.author: anclear
ms.openlocfilehash: f7ebbcd99b1ec35900de7ec2f54f93263918e945
ms.sourcegitcommit: 4329a94918263c85d6c65ff401f571556b80307b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2020
ms.locfileid: "41675231"
---
# <a name="add-authentication-to-your-messaging-extension"></a>Добавление проверки подлинности к своему расширению обмена сообщениями

[!include[v4-to-v3-SDK-pointer](~/includes/v4-to-v3-pointer-me.md)]

## <a name="identify-the-user"></a>Идентификация пользователя

Каждый запрос к службам включает в себя идентификатор пользователя, который выполнил запрос, а также отображаемое имя пользователя и идентификатор объекта Azure Active Directory.

```json
"from": {
  "id": "29:1C7dbRrC_5yzN1RGtZIrcWT0xz88KPGP9sxdpVpV8sODlgPHeQE9RqQ02hnpuKzy6zZ-AaZx6swUOMj_Dsdse3TQ4sIaeebbFBF-VgjJy_nY",
  "name": "Larry Jin",
  "aadObjectId": "cd723fa0-0591-416a-9290-e93ecf3a9b92"
},
```

Гарантируется, что значения `id` и `aadObjectId` значения для пользователя Teams прошли проверку подлинности. Они могут использоваться в качестве ключей для поиска учетных данных или любого кэшированного состояния в службе. Кроме того, каждый запрос содержит идентификатор клиента Azure Active Directory для пользователя, который можно использовать для определения организации пользователя. Если это возможно, запрос также содержит идентификаторы команд и каналов, из которых поступил запрос.

## <a name="authentication"></a>Проверка подлинности

Если для вашей службы требуется проверка подлинности пользователя, необходимо войти в систему, прежде чем ее сможет использовать расширение системы обмена сообщениями. Если вы написали робот или вкладку, которые подписываются пользователю, этот раздел должен быть знаком.

Последовательность выглядит следующим образом:

1. Пользователь выдает запрос, или запрос по умолчанию автоматически отправляется в службу.
2. Служба проверяет, прошел ли пользователь проверку подлинности, проверив идентификатор пользователя Teams.
3. Если пользователь не прошел проверку подлинности, отправьте `auth` ответ с `openUrl` предложенным действием, включая URL-адрес проверки подлинности.
4. Клиент Microsoft Teams запускает всплывающее окно, в котором размещается веб-страница, используя указанный URL-адрес проверки подлинности.
5. После входа пользователя необходимо закрыть окно и отправить ему код проверки подлинности в клиент Teams.
6. Затем клиент Teams повторно отправляет запрос в службу, который включает код проверки подлинности, переданный на шаге 5.

Ваша служба должна проверить, что код проверки подлинности, полученный на шаге 6, соответствует тому, что получено на шаге 5. Это гарантирует, что злоумышленник не будет пытаться подменить или ослабить процесс входа в систему. Это фактически "закрывает цикл" для завершения безопасной последовательности проверки подлинности.

### <a name="respond-with-a-sign-in-action"></a>Ответ с действием входа

Чтобы выдать запрос пользователю, не прошедшему проверку подлинности, выполните ответ с `openUrl` предложенным действием типа, которое включает URL-адрес проверки подлинности.

#### <a name="response-example-for-a-sign-in-action"></a>Пример отклика для действия при входе

```json
{
  "composeExtension":{
    "type":"auth",
    "suggestedActions":{
      "actions":[
        {
          "type": "openUrl",
          "value": "https://example.com/auth",
          "title": "Sign in to this app"
        }
      ]
    }
  }
}
```

> [!NOTE]
> Для того чтобы при входе в систему можно было размещаться в всплывающем окне Teams, в списке допустимых доменов приложения должен находиться домен, являющийся частью URL-адреса. (См. раздел [валиддомаинс](~/resources/schema/manifest-schema.md#validdomains) в схеме манифеста.)

### <a name="start-the-sign-in-flow"></a>Запуск процесса входа

Ваш интерфейс пользователя должен отвечать на запросы и размещаться в всплывающем окне. Он должен интегрироваться с [клиентским пакетом SDK для Microsoft Teams JavaScript](/javascript/api/overview/msteams-client), который использует передачу сообщений.

Как и другие встроенные возможности, выполняемые в Microsoft Teams, код в окне должен вызываться `microsoftTeams.initialize()`первым. Если ваш код выполняет процесс OAuth, можно передать идентификатор пользователя Teams в ваше окно, которое затем может передать его в URL-адрес входа OAuth.

### <a name="complete-the-sign-in-flow"></a>Завершение процесса входа

Когда запрос на вход завершается и перенаправляется обратно на страницу, он должен выполнить следующие действия:

1. Создайте код безопасности. (Это может быть случайное число.) Необходимо кэшировать этот код в службе, а также учетные данные, полученные с помощью процесса входа (например, OAuth 2,0 tokens).
2. Позвоните `microsoftTeams.authentication.notifySuccess` и передайте код безопасности.

На этом шаге окно закрывается и управление передается клиенту Teams. Теперь клиент может повторно отправить исходный запрос пользователя, а также код безопасности в `state` свойстве. Код может использовать код безопасности для поиска ранее сохраненных учетных данных, чтобы выполнить последовательность проверки подлинности, а затем выполнить запрос пользователя.

#### <a name="reissued-request-example"></a>Пример повторной выданной заявки

```json
{
    "name": "composeExtension/query",
    "value": {
        "commandId": "insertWiki",
        "parameters": [{
            "name": "searchKeyword",
            "value": "lakers"
        }],
        "state": "12345",
        "queryOptions": {
            "skip": 0,
            "count": 25
        }
    },
    "type": "invoke",
    "timestamp": "2017-04-26T05:18:25.629Z",
    "localTimestamp": "2017-04-25T22:18:25.629-07:00",
    "entities": [{
        "locale": "en-US",
        "country": "US",
        "platform": "Web",
        "type": "clientInfo"
    }],
    "text": "",
    "attachments": [],
    "address": {
        "id": "f:7638210432489287768",
        "channelId": "msteams",
        "user": {
            "id": "29:1A5TJWHkbOwSyu_L9Ktk9QFI1d_kBOEPeNEeO1INscpKHzHTvWfiau5AX_6y3SuiOby-r73dzHJ17HipUWqGPgw",
            "aadObjectId": "fc8ca1c0-d043-4af6-b09f-141536207403"
        },
        "conversation": {
            "id": "19:7705841b240044b297123ad7f9c99217@thread.skype"
        },
        "bot": {
            "id": "28:c073afa8-7e77-4f92-b3e7-aa589e952a3e",
            "name": "maotestbot2"
        },
        "serviceUrl": "https://smba.trafficmanager.net/amer-client-ss.msg/",
        "useAuth": true
    },
    "source": "msteams"
}
```

