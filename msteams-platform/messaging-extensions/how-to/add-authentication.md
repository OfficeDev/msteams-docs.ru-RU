---
title: Добавление проверки подлинности в расширение для сообщений
author: surbhigupta
description: Узнайте, как добавить проверку подлинности в расширение для сообщений, на основе примеров программного кода и образцов программ.
ms.localizationpriority: medium
ms.topic: conceptual
ms.author: anclear
ms.openlocfilehash: 996ae2fe8a45e5ebbb481865198b759c7ad221a3
ms.sourcegitcommit: 430bf416bb8d1b74f926c8b5d5ffd3dbb0782286
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2022
ms.locfileid: "65297010"
---
# <a name="add-authentication-to-your-message-extension"></a>Добавление проверки подлинности в расширение для сообщений

[!include[v4-to-v3-SDK-pointer](~/includes/v4-to-v3-pointer-me.md)]

## <a name="identify-the-user"></a>Идентификация пользователя

Каждый запрос к вашим службам содержит идентификатор пользователя, видимое имя пользователя и идентификатор объекта Azure Active Directory.

```json
"from": {
  "id": "29:1C7dbRrC_5yzN1RGtZIrcWT0xz88KPGP9sxdpVpV8sODlgPHeQE9RqQ02hnpuKzy6zZ-AaZx6swUOMj_Dsdse3TQ4sIaeebbFBF-VgjJy_nY",
  "name": "Larry Jin",
  "aadObjectId": "cd723fa0-0591-416a-9290-e93ecf3a9b92"
},
```

Для пользователя, прошедшего проверку подлинности Teams, гарантируется наличие `id` и `aadObjectId`. Они используются в качестве ключей для поиска учетных данных или любого кэшированного состояния в службе. Кроме того, каждый запрос содержит ИД клиента Azure Active Directory, который используется для определения организации пользователя. Если применимо, запрос также содержит идентификатор команды и идентификатор канала, из которого поступил запрос.

## <a name="authentication"></a>Проверка подлинности

Если служба требует проверки подлинности пользователя, пользователи должны войти в систему, прежде чем использовать расширение для сообщений. Шаги проверки подлинности в этом случае аналогичны шагам для бота или вкладки. Последовательность действий выглядит следующим образом:

1. Пользователь отправляет запрос или запрос по умолчанию автоматически отправляется в службу.
1. Ваша служба определяет, прошел ли пользователь проверку подлинности, проверяя его идентификатор Teams.
1. Если пользователь не прошел проверку подлинности, отправьте ответ `auth` с предложением выполнить действие `openUrl`, включающим URL-адрес проверки подлинности.
1. Используя заданный URL-адрес проверки подлинности, клиент Microsoft Teams запускает диалоговое окно, в котором размещается ваша веб-страница.
1. После входа пользователя следует закрыть окно и отправить **код проверки подлинности Teams** клиенту.
1. Затем Teams повторно отправляет в вашу службу запрос, содержащий код проверки подлинности, переданный на шаге 5.

Служба должна убедиться, что код проверки подлинности, полученный на шаге 6, соответствует коду из шага 5. Это гарантирует, что пользователь - не злоумышленник, пытающийся прикинуться кем-то другим или взломать поток входа. Это фактически "закрывает цикл" для завершения последовательности надежной проверки подлинности.

### <a name="respond-with-a-sign-in-action"></a>Ответ с помощью действия входа

Чтобы предложить пользователю, не прошедшему проверку подлинности, выполнить вход, в ответном сообщении предложите ему выполнить действие типа `openUrl` и укажите URL-адрес проверки подлинности.

#### <a name="response-example-for-a-sign-in-action"></a>Пример ответа для действия входа

```json
{
  "composeExtension":{
    "type":"auth",
    "suggestedActions":{
      "actions":[
        {
          "type": "openUrl",
          "value": "https://example.com/auth",
          "title": "Sign in to this app"
        }
      ]
    }
  }
}
```

> [!NOTE]
>
> * Чтобы интерфейс входа размещался во всплывающем окне Teams, доменная часть URL-адреса должна быть в списке допустимых доменов приложения. Дополнительные сведения см. в разделе [validDomains](~/resources/schema/manifest-schema.md#validdomains) в схеме манифеста.
> * Размер всплывающего окна проверки подлинности можно задать, включив в строку запроса параметры ширины и высоты `Value = $"{_siteUrl}/searchSettings.html?height=600&width=600"`.

### <a name="start-the-sign-in-flow"></a>Запуск потока входа

Интерфейс входа должен обладать гибким дизайном и умещаться во всплывающем окне. Он должен интегрироваться с [клиентским пакетом SDK Microsoft Teams JavaScript](/javascript/api/overview/msteams-client), который использует передачу сообщений.

Как и в случае с другими встроенными пользовательскими интерфейсами Microsoft Teams, код в окне должен сначала вызвать `microsoftTeams.initialize()`. Если код выполняет поток OAuth, вы можете передать идентификатор пользователя Teams окну, которое затем передает его по URL-адресу для входа в OAuth.

### <a name="complete-the-sign-in-flow"></a>Завершение потока входа

После того, как обработка запроса на вход завершена и пользователь перенаправлен обратно на страницу, она должен выполнить следующие действия:

1. Сформируйте код безопасности: случайное число. Этот код необходимо кэшировать в службе вместе с учетными данными, полученными в потоке входа, например маркерами OAuth 2.0.
1. Вызовите `microsoftTeams.authentication.notifySuccess` и передайте код безопасности.

После этого окно закрывается и управление передается клиенту Teams. Теперь клиент повторно отсылает исходный пользовательский запрос, содержащий код безопасности в свойстве `state`. Ваша программа может использовать код безопасности для поиска учетных данных, сохраненных ранее, для завершения последовательности проверки подлинности, а затем для выполнения запроса пользователя.

#### <a name="reissued-request-example"></a>Пример повторно отправленного запроса

```json
{
    "name": "composeExtension/query",
    "value": {
        "commandId": "insertWiki",
        "parameters": [{
            "name": "searchKeyword",
            "value": "lakers"
        }],
        "state": "12345",
        "queryOptions": {
            "skip": 0,
            "count": 25
        }
    },
    "type": "invoke",
    "timestamp": "2017-04-26T05:18:25.629Z",
    "localTimestamp": "2017-04-25T22:18:25.629-07:00",
    "entities": [{
        "locale": "en-US",
        "country": "US",
        "platform": "Web",
        "type": "clientInfo"
    }],
    "text": "",
    "attachments": [],
    "address": {
        "id": "f:7638210432489287768",
        "channelId": "msteams",
        "user": {
            "id": "29:1A5TJWHkbOwSyu_L9Ktk9QFI1d_kBOEPeNEeO1INscpKHzHTvWfiau5AX_6y3SuiOby-r73dzHJ17HipUWqGPgw",
            "aadObjectId": "fc8ca1c0-d043-4af6-b09f-141536207403"
        },
        "conversation": {
            "id": "19:7705841b240044b297123ad7f9c99217@thread.skype"
        },
        "bot": {
            "id": "28:c073afa8-7e77-4f92-b3e7-aa589e952a3e",
            "name": "maotestbot2"
        },
        "serviceUrl": "https://smba.trafficmanager.net/amer-client-ss.msg/",
        "useAuth": true
    },
    "source": "msteams"
}
```

## <a name="code-sample"></a>Пример кода

|**Название примера** | **Описание** |**.NET** | **Node.js**|
|----------------|-----------------|--------------|----------------|
|Расширения для сообщений — аутентификация и конфигурация | Расширение для сообщений, у которого есть страница конфигурации, принимает поисковые запросы и возвращает результаты после того, как пользователь выполнит вход. |[View](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/52.teams-messaging-extensions-search-auth-config)|[Просмотр](https://github.com/microsoft/BotBuilder-Samples/blob/main/samples/javascript_nodejs/52.teams-messaging-extensions-search-auth-config)|

## <a name="see-also"></a>Дополнительные ресурсы

[Единый вход (SSO) для расширений обмена сообщениями](~/messaging-extensions/how-to/enable-sso-auth-me.md)
