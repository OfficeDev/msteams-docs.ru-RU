---
title: Добавление проверки подлинности в расширение обмена сообщениями
author: clearab
description: Добавление проверки подлинности в расширение обмена сообщениями
ms.topic: conceptual
ms.author: anclear
ms.openlocfilehash: 4ebe65af06240d13ceb99fe3b7640ab402d716c5
ms.sourcegitcommit: 00c657e3bf57d3b92aca7da941cde47a2eeff4d0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/20/2021
ms.locfileid: "49911872"
---
# <a name="add-authentication-to-your-messaging-extension"></a>Добавление проверки подлинности в расширение обмена сообщениями

[!include[v4-to-v3-SDK-pointer](~/includes/v4-to-v3-pointer-me.md)]

## <a name="identify-the-user"></a>Идентификация пользователя

Каждый запрос к вашим службам включает в себя запутывавный ИД пользователя, выполнив запрос, а также отображаемого имени пользователя и ИД объекта Azure Active Directory.

```json
"from": {
  "id": "29:1C7dbRrC_5yzN1RGtZIrcWT0xz88KPGP9sxdpVpV8sODlgPHeQE9RqQ02hnpuKzy6zZ-AaZx6swUOMj_Dsdse3TQ4sIaeebbFBF-VgjJy_nY",
  "name": "Larry Jin",
  "aadObjectId": "cd723fa0-0591-416a-9290-e93ecf3a9b92"
},
```

Эти значения гарантированно будут у пользователя Teams с проверкой `id` `aadObjectId` подлинности. Их можно использовать в качестве ключей для иска учетных данных или любого кэшного состояния в службе. Кроме того, каждый запрос содержит ИД клиента Azure Active Directory пользователя, который можно использовать для идентификации организации пользователя. Если применимо, запрос также содержит команды и каналы, из которых был произведен запрос.

## <a name="authentication"></a>Проверка подлинности

Если служба требует проверки подлинности пользователя, необходимо войти в систему пользователя, прежде чем он сможет использовать расширение обмена сообщениями. Если вы написали бот или вкладку, которая подписывает пользователя, этот раздел должен быть знаком.

Последовательность действий:

1. Пользователь отправляет запрос или автоматически отправляет запрос по умолчанию в вашу службу.
2. Ваша служба проверяет, впервые ли пользователь проверил подлинность, проверив его ИД пользователя Teams.
3. Если пользователь не прошла проверку подлинности, отправьте ответ с рекомендуемым действием, включая `auth` `openUrl` URL-адрес проверки подлинности.
4. Клиент Microsoft Teams запускает всплывающее окно с веб-страницей с использованием заданного URL-адреса проверки подлинности.
5. После того как пользователь войдет, необходимо закрыть окно и отправить "код проверки подлинности" клиенту Teams.
6. Затем клиент Teams повторно выдает запрос службе, в том числе код проверки подлинности, переданный на шаге 5.

Ваша служба должна убедиться, что код проверки подлинности, полученный на шаге 6, соответствует коду, полученному на шаге 5. Это гарантирует, что злоумышленник не попытается подменить или нарушить поток входов. Это фактически "закрывает цикл", чтобы завершить последовательность безопасной проверки подлинности.

### <a name="respond-with-a-sign-in-action"></a>Ответ с помощью действия для регистрации

Чтобы предложить пользователю, не подлинность пользователя, войти, ответьте предлагаемым действием типа, которое включает `openUrl` URL-адрес проверки подлинности.

#### <a name="response-example-for-a-sign-in-action"></a>Пример ответа для действия при входе

```json
{
  "composeExtension":{
    "type":"auth",
    "suggestedActions":{
      "actions":[
        {
          "type": "openUrl",
          "value": "https://example.com/auth",
          "title": "Sign in to this app"
        }
      ]
    }
  }
}
```

> [!NOTE]
> Чтобы во всплывающее приложение Teams можно было войти во всплывающее приложение, доменная часть URL-адреса должна быть указана в списке допустимого домена вашего приложения. [(См. validDomains](~/resources/schema/manifest-schema.md#validdomains) в схеме манифеста.)

### <a name="start-the-sign-in-flow"></a>Запуск потока входов

Во всплывающее окно должна отвечать и умещаться ваша возможность входов. Он должен интегрироваться с [клиентским SDK JavaScript для Microsoft Teams,](/javascript/api/overview/msteams-client)который использует передачу сообщений.

Как и в других встроенных решениях, работающих в Microsoft Teams, код в окне должен сначала `microsoftTeams.initialize()` вызываться. Если код выполняет поток OAuth, вы можете передать в окно ИД пользователя Teams, который затем может передать его на URL-адрес для входов в OAuth.

### <a name="complete-the-sign-in-flow"></a>Завершение потока входов

Когда запрос на вход завершается и перенаправляется обратно на страницу, он должен выполнить следующие действия:

1. Создание кода безопасности. (Это может быть случайное число.) Этот код необходимо кэшировать в службе, а также учетные данные, полученные в потоке входа (например, маркеры OAuth 2.0).
2. Вызовите `microsoftTeams.authentication.notifySuccess` и передав код безопасности.

На этом этапе окно закрывается и управление передается клиенту Teams. Теперь клиент может повторно использовать исходный запрос пользователя вместе с кодом безопасности в `state` свойстве. Код безопасности может использовать код безопасности, чтобы найти учетные данные, сохраненные ранее, чтобы завершить последовательность проверки подлинности, а затем выполнить запрос пользователя.

#### <a name="reissued-request-example"></a>Пример повторного выдачи запроса

```json
{
    "name": "composeExtension/query",
    "value": {
        "commandId": "insertWiki",
        "parameters": [{
            "name": "searchKeyword",
            "value": "lakers"
        }],
        "state": "12345",
        "queryOptions": {
            "skip": 0,
            "count": 25
        }
    },
    "type": "invoke",
    "timestamp": "2017-04-26T05:18:25.629Z",
    "localTimestamp": "2017-04-25T22:18:25.629-07:00",
    "entities": [{
        "locale": "en-US",
        "country": "US",
        "platform": "Web",
        "type": "clientInfo"
    }],
    "text": "",
    "attachments": [],
    "address": {
        "id": "f:7638210432489287768",
        "channelId": "msteams",
        "user": {
            "id": "29:1A5TJWHkbOwSyu_L9Ktk9QFI1d_kBOEPeNEeO1INscpKHzHTvWfiau5AX_6y3SuiOby-r73dzHJ17HipUWqGPgw",
            "aadObjectId": "fc8ca1c0-d043-4af6-b09f-141536207403"
        },
        "conversation": {
            "id": "19:7705841b240044b297123ad7f9c99217@thread.skype"
        },
        "bot": {
            "id": "28:c073afa8-7e77-4f92-b3e7-aa589e952a3e",
            "name": "maotestbot2"
        },
        "serviceUrl": "https://smba.trafficmanager.net/amer-client-ss.msg/",
        "useAuth": true
    },
    "source": "msteams"
}
```

## <a name="samples"></a>Примеры
Пример кода, показывающий процесс проверки подлинности с расширениями обмена сообщениями, см. в:

[Пример проверки подлинности расширений обмена сообщениями Microsoft Teams](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/52.teams-messaging-extensions-search-auth-config)

 
