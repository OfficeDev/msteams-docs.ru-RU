---
title: Поток проверки подлинности для ботов
description: Описывает поток проверки подлинности в ботах
keywords: боты потока проверки подлинности команд
localization_priority: Normal
ms.topic: conceptual
ms.date: 03/01/2018
ms.openlocfilehash: fe7e528be98a0b58334535952327b6026b30a87d
ms.sourcegitcommit: 825abed2f8784d2bab7407ba7a4455ae17bbd28f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/26/2021
ms.locfileid: "52019806"
---
# <a name="microsoft-teams-authentication-flow-for-bots"></a><span data-ttu-id="49875-104">Microsoft Teams потока проверки подлинности для ботов</span><span class="sxs-lookup"><span data-stu-id="49875-104">Microsoft Teams authentication flow for bots</span></span>

[!include[v3-to-v4-SDK-pointer](~/includes/v3-to-v4-pointer-bots.md)]

<span data-ttu-id="49875-105">OAuth 2.0 — это открытый стандарт проверки подлинности и авторизации, используемый Azure AD и многими другими поставщиками удостоверений.</span><span class="sxs-lookup"><span data-stu-id="49875-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure AD and many other identity providers.</span></span> <span data-ttu-id="49875-106">Базовое понимание OAuth 2.0 является обязательным условием для работы с проверкой подлинности в Teams; [Вот хороший обзор,](https://aaronparecki.com/oauth-2-simplified/) который легче следовать, чем [формальные спецификации](https://oauth.net/2/).</span><span class="sxs-lookup"><span data-stu-id="49875-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="49875-107">Поток проверки подлинности для вкладок и ботов немного отличается, так как вкладки очень похожи на веб-сайты, поэтому они могут напрямую использовать OAuth 2.0, а боты не являются и должны делать несколько вещей по-другому, но основные понятия идентичны.</span><span class="sxs-lookup"><span data-stu-id="49875-107">Authentication flow for tabs and bots are a little different because tabs are very similar to websites so they can use OAuth 2.0 directly, and bots are not and must do a few things differently, but the core concepts are identical.</span></span>

<span data-ttu-id="49875-108">Пример GitHub репо [Microsoft Teams](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) проверки подлинности см. в примере, демонстрируемом потоком проверки подлинности для ботов с использованием node с помощью типа гранта кода авторизации [OAuth 2.0.](https://oauth.net/2/grant-types/authorization-code/)</span><span class="sxs-lookup"><span data-stu-id="49875-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) for an example that demonstrates authentication flow for bots using Node using the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Схема последовательности проверки подлинности ботов](~/assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="49875-110">Пользователь отправляет сообщение боту.</span><span class="sxs-lookup"><span data-stu-id="49875-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="49875-111">Бот определяет, нужно ли пользователю войти.</span><span class="sxs-lookup"><span data-stu-id="49875-111">The bot determines if the user needs to sign in.</span></span>
    * <span data-ttu-id="49875-112">В этом примере бот хранит маркер доступа в хранилище пользовательских данных.</span><span class="sxs-lookup"><span data-stu-id="49875-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="49875-113">Он просит пользователя войти в систему, если у него нет проверенного маркера для выбранного поставщика удостоверений.</span><span class="sxs-lookup"><span data-stu-id="49875-113">It asks the user to log in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="49875-114">([Просмотр кода](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="49875-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="49875-115">Бот строит URL-адрес на стартовую страницу потока проверки подлинности и отправляет карточку пользователю с `signin` действием.</span><span class="sxs-lookup"><span data-stu-id="49875-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="49875-116">([Просмотр кода](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="49875-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span>
    * <span data-ttu-id="49875-117">Как и другие потоки auth приложения в Teams, стартовая страница должна быть на домене, который в вашем списке, и в том же домене, что и страница перенаправления после `validDomains` входа.</span><span class="sxs-lookup"><span data-stu-id="49875-117">Like other application auth flows in Teams, the start page must be on a domain that's in your `validDomains` list, and on the same domain as the post-login redirect page.</span></span>
    * <span data-ttu-id="49875-118">**ВАЖНО.** Поток грантов кода авторизации OAuth 2.0 вызывает параметр в запросе на проверку подлинности, который содержит уникальный маркер сеанса для предотвращения атаки подделки запросов на межсайтовые `state` [запросы.](https://en.wikipedia.org/wiki/Cross-site_request_forgery)</span><span class="sxs-lookup"><span data-stu-id="49875-118">**IMPORTANT**: The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="49875-119">В примере используется случайно созданный GUID.</span><span class="sxs-lookup"><span data-stu-id="49875-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="49875-120">Когда пользователь нажимает кнопку *signin,* Teams открывает всплывающее окно и перемещает его на начните страницу.</span><span class="sxs-lookup"><span data-stu-id="49875-120">When the user clicks on the *signin* button, Teams opens a popup window and navigates it to the start page.</span></span>
5. <span data-ttu-id="49875-121">На стартовой странице пользователь перенаправляется в конечную точку поставщика `authorize` удостоверений.</span><span class="sxs-lookup"><span data-stu-id="49875-121">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="49875-122">([Просмотр кода](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="49875-122">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="49875-123">На сайте поставщика пользователь в записи и предоставляет доступ к боту.</span><span class="sxs-lookup"><span data-stu-id="49875-123">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="49875-124">Поставщик принимает пользователя на страницу перенаправления OAuth бота с кодом авторизации.</span><span class="sxs-lookup"><span data-stu-id="49875-124">The provider takes the user to the bot's OAuth redirect page, with an authorization code.</span></span>
8. <span data-ttu-id="49875-125">Бот выкупает код авторизации маркера  доступа и предварительно связывает маркер с пользователем, который инициировал входной поток.</span><span class="sxs-lookup"><span data-stu-id="49875-125">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="49875-126">Ниже мы называем это *временным маркером.*</span><span class="sxs-lookup"><span data-stu-id="49875-126">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="49875-127">В примере бот связывает значение параметра с идентификатором пользователя, который инициировал процесс регистрации, чтобы впоследствии он соедиировал его со значением, возвращенным поставщиком `state` `state` удостоверений.</span><span class="sxs-lookup"><span data-stu-id="49875-127">In the example, the bot associates the value of the `state` parameter with the id of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="49875-128">([Просмотр кода](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="49875-128">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
    * <span data-ttu-id="49875-129">**ВАЖНО:** бот хранит маркер, который он получает от поставщика удостоверений, и связывает его с определенным пользователем, но он помечен как "ожидающий проверки".</span><span class="sxs-lookup"><span data-stu-id="49875-129">**IMPORTANT**: The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> <span data-ttu-id="49875-130">Временный маркер еще нельзя использовать: он должен быть дополнительно проверен:</span><span class="sxs-lookup"><span data-stu-id="49875-130">The provisional token cannot be used yet: it must be further validated:</span></span> 
      1. <span data-ttu-id="49875-131">**Проверка того, что получено от поставщика удостоверений.**</span><span class="sxs-lookup"><span data-stu-id="49875-131">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="49875-132">Значение параметра `state` должно быть подтверждено в отношении того, что было сохранено ранее.</span><span class="sxs-lookup"><span data-stu-id="49875-132">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="49875-133">**Проверка того, что получено от Teams.**</span><span class="sxs-lookup"><span data-stu-id="49875-133">**Validate what's received from Teams.**</span></span> <span data-ttu-id="49875-134">Для [проверки](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) подлинности выполняется двухшаговая проверка подлинности, чтобы убедиться, что пользователь, уполномочивший бота с поставщиком удостоверений, является тем же пользователем, который общается с ботом.</span><span class="sxs-lookup"><span data-stu-id="49875-134">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="49875-135">Это [охраняет от атак man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) и [фишинга.](https://en.wikipedia.org/wiki/Phishing)</span><span class="sxs-lookup"><span data-stu-id="49875-135">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="49875-136">Бот создает код проверки и сохраняет его, связанный с пользователем.</span><span class="sxs-lookup"><span data-stu-id="49875-136">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="49875-137">Код проверки отправляется автоматически Teams, как описано ниже, в шагах 9 и 10.</span><span class="sxs-lookup"><span data-stu-id="49875-137">The verification code is sent automatically by Teams as described below in steps 9 and 10.</span></span> <span data-ttu-id="49875-138">([Просмотр кода](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="49875-138">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="49875-139">Вызов OAuth отрисовки страницы, которая вызывает `notifySuccess("<verification code>")` .</span><span class="sxs-lookup"><span data-stu-id="49875-139">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="49875-140">([Просмотр кода](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="49875-140">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="49875-141">Teams закрывает всплывающее сообщение и отправляет отправленный обратно `<verification code>` `notifySuccess()` в бот.</span><span class="sxs-lookup"><span data-stu-id="49875-141">Teams closes the popup and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="49875-142">Бот получает сообщение [вызова](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) с `name = signin/verifyState` .</span><span class="sxs-lookup"><span data-stu-id="49875-142">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="49875-143">Бот проверяет входящий код проверки на код проверки, хранимый с временным маркером пользователя.</span><span class="sxs-lookup"><span data-stu-id="49875-143">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="49875-144">([Просмотр кода](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="49875-144">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="49875-145">Если они совпадают, бот отмечает маркер как проверенный и готовый к использованию.</span><span class="sxs-lookup"><span data-stu-id="49875-145">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="49875-146">В противном случае поток auth не удается, и бот удаляет временный маркер.</span><span class="sxs-lookup"><span data-stu-id="49875-146">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

> [!Note]
> <span data-ttu-id="49875-147">Если у вас проблемы с проверкой подлинности на мобильных устройствах, убедитесь, что SDK Javascript обновляется до версии 1.4.1 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="49875-147">If you experience issues with authentication on mobile, ensure your Javascript SDK is update to version 1.4.1 or later.</span></span>

## <a name="samples"></a><span data-ttu-id="49875-148">Примеры</span><span class="sxs-lookup"><span data-stu-id="49875-148">Samples</span></span>

<span data-ttu-id="49875-149">Пример кода, показывающий процесс проверки подлинности ботов, см. в примере:</span><span class="sxs-lookup"><span data-stu-id="49875-149">For sample code showing the bot authentication process see:</span></span>

* [<span data-ttu-id="49875-150">Microsoft Teams проверки подлинности бота (Node)</span><span class="sxs-lookup"><span data-stu-id="49875-150">Microsoft Teams bot authentication sample (Node)</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a><span data-ttu-id="49875-151">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="49875-151">More details</span></span>

<span data-ttu-id="49875-152">Подробные инструкции по реализации для целей проверки подлинности ботов Azure Active Directory см. в этой Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="49875-152">For detailed implementation walkthroughs for bot authentication targeting Azure Active Directory see:</span></span>

* [<span data-ttu-id="49875-153">Проверка подлинности пользователя в Microsoft Teams боте</span><span class="sxs-lookup"><span data-stu-id="49875-153">Authenticate a user in a Microsoft Teams bot</span></span>](~/resources/bot-v3/bot-authentication/auth-bot-AAD.md)
