---
title: Поток проверки подлинности для ботов
description: Описывает поток проверки подлинности в ботах
keywords: teams проверка подлинности поток боты
localization_priority: Normal
ms.topic: conceptual
ms.date: 03/01/2018
ms.openlocfilehash: e3bc5395a6a95272901076ec8bf51dc2ad57dfd2
ms.sourcegitcommit: 1cda2fd3498a76c09e31ed7fd88175414ad428f7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/27/2022
ms.locfileid: "67035333"
---
# <a name="microsoft-teams-authentication-flow-for-bots"></a>Поток проверки подлинности Microsoft Teams для ботов

[!include[v3-to-v4-SDK-pointer](~/includes/v3-to-v4-pointer-bots.md)]

OAuth 2.0 — это открытый стандарт проверки подлинности и авторизации, используемый Azure Active Directory (Azure AD) и многими другими поставщиками удостоверений. Базовое представление OAuth 2.0 является необходимым условием для работы с проверкой подлинности в Teams. [Ниже представлен хороший обзор](https://aaronparecki.com/oauth-2-simplified/), который проще соблюдать, чем [формальную спецификацию](https://oauth.net/2/). Поток проверки подлинности для вкладок и ботов отличается. Вкладки похожи на веб-сайты, поэтому они могут использовать OAuth 2.0 напрямую, а боты — нет и должны выполнять некоторые действия по-разному, но основные понятия идентичны.

Пример проверки подлинности [Microsoft Teams](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) см. в репозитории GitHub. Пример, демонстрирующий поток проверки подлинности для ботов, использующих Node с типом предоставления кода авторизации [OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/).

![Схема последовательностей проверки подлинности бота](~/assets/images/authentication/bot_auth_sequence_diagram.png)

1. Пользователь отправляет боту сообщение.
2. Бот определяет, нужно ли пользователю выполнять вход.
    * В этом примере бот сохраняет маркер доступа в хранилище пользовательских данных. Он запрашивает у пользователя вход, если у него нет проверенного маркера для выбранного поставщика удостоверений. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))
3. Бот создает URL-адрес начальной страницы потока проверки подлинности и отправляет карточку пользователю с действием `signin`. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))
    * Как и другие потоки проверки подлинности приложений в Teams, `validDomains` начальная страница должна находиться в домене, который есть в вашем списке, и в том же домене, что и страница перенаправления после входа.
    * **ВАЖНО**! Поток предоставления кода авторизации OAuth 2.0 `state` вызывает параметр в запросе проверки подлинности, который содержит уникальный маркер сеанса для предотвращения подделки межсайтовых [запросов.](https://en.wikipedia.org/wiki/Cross-site_request_forgery) В примере используется случайный идентификатор GUID.
4. Когда пользователь нажмет  кнопку входа, Teams откроет всплывающее окно и перейдет на пусковую страницу.
5. Начальная страница перенаправляет пользователя в конечную точку `authorize` поставщика удостоверений. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))
6. На сайте поставщика пользователь выполняет вход и предоставляет доступ к боту.
7. Поставщик перенаправляет пользователя на страницу перенаправления OAuth бота с кодом авторизации.
8. Бот активирует код авторизации на маркер доступа и **предварительно** связывает маркер с пользователем, инициировавшим процесс входа. Ниже мы называем это *маркером подготовки*.
    * В этом примере бот связывает значение параметра `state` с идентификатором пользователя, который инициировал процесс входа, чтобы впоследствии сопоставить его со значением `state`, возвращенным поставщиком удостоверений. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))
    * **ВАЖНО**! Бот сохраняет маркер, который он получает от поставщика удостоверений, и связывает его с определенным пользователем, но он помечается как "ожидающая проверка". Пока не удается использовать маркер подготовки: он должен быть проверен далее:
      1. **Проверьте, что получено от поставщика удостоверений.** Значение параметра `state` необходимо сверить с тем, что было сохранено ранее.
      1. **Проверьте, что получено от Teams.** Выполняется [двухэтапная проверка подлинности](https://en.wikipedia.org/wiki/Man-in-the-middle_attack), чтобы убедиться, что пользователь, авторизовавший бота с помощью поставщика удостоверений, является тем же пользователем, который общается с ботом. Эта проверка защищает от [атак типа "злоумышленник в середине"](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) [и фишинга](https://en.wikipedia.org/wiki/Phishing) . Бот создает код проверки и сохраняет его, связанный с пользователем. Код проверки автоматически отправляется Teams, как описано ниже в шагах 9 и 10. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))
9. Обратный вызов OAuth отображает страницу, которая вызывает `notifySuccess("<verification code>")`. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))
10. Teams закрывает всплывающее окно и отправляет `<verification code>` отправленное `notifySuccess()` обратно боту. Бот получает сообщение [вызова](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) с `name = signin/verifyState`.
11. Бот сравнивает входящий код подтверждения с кодом проверки, хранящимся в маркере подготовки пользователя. ([Просмотреть код](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))
12. Если они совпадают, бот помечает маркер как проверенный и готовый к использованию. В противном случае поток проверки подлинности завершится ошибкой, и бот удалит временный маркер.

> [!Note]
> При проблемах с проверкой подлинности на мобильных устройствах убедитесь, что пакет SDK для JavaScript обновлен до версии 1.4.1 или более поздней.

## <a name="samples"></a>Примеры

Пример кода, демонстрирующий процесс проверки подлинности бота, см. в следующих статьях:

* [Пример проверки подлинности бота Microsoft Teams (Node)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a>Дополнительные сведения

Подробные пошаговые руководства по реализации проверки подлинности бота, предназначенной для Azure Active Directory, см. в следующих статьях:

* [Проверка подлинности пользователя в боте Microsoft Teams](~/resources/bot-v3/bot-authentication/auth-bot-AAD.md)
