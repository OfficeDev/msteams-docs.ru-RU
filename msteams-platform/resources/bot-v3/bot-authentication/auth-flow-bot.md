---
title: Процесс проверки подлинности для Боты
description: Описание процесса проверки подлинности в Боты
keywords: Боты процесса проверки подлинности Teams
ms.date: 03/01/2018
ms.openlocfilehash: 5230a94b23f9042d9d7753b52467fba5b2fec89e
ms.sourcegitcommit: 4329a94918263c85d6c65ff401f571556b80307b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2020
ms.locfileid: "41675662"
---
# <a name="microsoft-teams-authentication-flow-for-bots"></a>Процесс проверки подлинности Microsoft Teams для Боты

[!include[v3-to-v4-SDK-pointer](~/includes/v3-to-v4-pointer-bots.md)]

OAuth 2,0 это открытый стандарт для проверки подлинности и авторизации, используемый Azure AD и многими другими поставщиками удостоверений. Основное понимание OAuth 2,0 является необходимым условием для работы с проверкой подлинности в Teams; [Вот хороший обзор](https://aaronparecki.com/oauth-2-simplified/) , который легче следовать, чем [формальное описание](https://oauth.net/2/). Процесс проверки подлинности для вкладок и боты слегка различается, так как вкладки очень похожи на веб-сайты, поэтому они могут использовать OAuth 2,0 напрямую, и боты не должны выполнять несколько действий по-разному, но основные понятия идентичны.

Пример [проверки подлинности Microsoft Teams](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) в репозитории GitHub, демонстрирующий процесс проверки подлинности для боты с использованием узла с использованием [типа предоставления кода авторизации OAuth 2,0](https://oauth.net/2/grant-types/authorization-code/).

![Схема последовательности проверки подлинности на Bot](~/assets/images/authentication/bot_auth_sequence_diagram.png)

1. Пользователь отправляет сообщение в Bot.
2. Элемент Bot определяет, нужно ли выполнять вход в систему.
    * В этом примере элемент Bot хранит маркер доступа в хранилище данных пользователя. Он предлагает пользователю войти в систему, если у него нет проверенного маркера для выбранного поставщика удостоверений. ([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))
3. Элемент Bot создает URL-адрес начальной страницы для процесса проверки подлинности и отправляет карточку пользователю с `signin` действием. ([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))
    * Как и в случае с другими потоками проверки подлинности приложений в Teams, начальная страница `validDomains` должна находиться в домене, который находится в списке, и в том же домене, что и страница перенаправления после входа.
    * **Важно!** код авторизации OAuth 2,0 вызывает для `state` параметра в запросе на проверку подлинности, который содержит уникальный маркер сеанса для предотвращения атаки на [межсайтовый запрос на межсайтовую подделку](https://en.wikipedia.org/wiki/Cross-site_request_forgery). В этом примере используется идентификатор GUID, созданный случайным образом.
4. Когда пользователь нажимает кнопку *Signing (войти* ), Teams открывает всплывающее окно и переходит к начальной странице.
5. Начальная страница перенаправляет пользователя на `authorize` конечную точку поставщика удостоверений. ([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))
6. На сайте поставщика пользователь входит в систему и предоставляет доступ к Bot.
7. Поставщик переводит пользователя на страницу переадресации OAuth на Bot, используя код авторизации.
8. Bot пополняет код авторизации для маркера доступа **, а затем** связывает маркер с пользователем, который инициировал процесс входа. Ниже мы вызываем этот *описатель подготовки*.
    * В этом примере с помощью Bot связывается значение `state` параметра с идентификатором пользователя, который инициировал процесс входа, поэтому он может впоследствии сопоставлять его со `state` значением, возвращенным поставщиком удостоверений. ([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))
    * **Важно!** элемент Bot хранит маркер, который он получает от поставщика удостоверений, и связывает его с определенным пользователем, но отмечено как "Ожидание проверки". Вы еще не можете использовать предварительный маркер: он должен быть проверен следующим образом: 
      1. **Проверка того, что получено от поставщика удостоверений.** Значение `state` параметра должно быть подтверждено относительно того, что было сохранено ранее. 
      1. **Проверка того, что получено от Teams.** Проверка [подлинности выполняется в два этапа](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) с учетом того, что пользователь, уполномоченный с помощью поставщика удостоверений, — это тот же пользователь, что и в чате. Это защищает от атак ["злоумышленник в середине"](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) и " [Фишинг](https://en.wikipedia.org/wiki/Phishing) ". Bot создает код проверки и сохраняет его, связанный с пользователем. Код проверки автоматически отправляется Teams, как описано ниже в шагах 9 и 10. ([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))
9. Обратный вызов OAuth отображает страницу, которая вызывается `notifySuccess("<verification code>")`. ([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))
10. Teams закрывает всплывающее окно `<verification code>` и отправляет `notifySuccess()` ответ на задний план. Bot получает сообщение о [вызове](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) `name = signin/verifyState`.
11. Bot проверяет входящий код проверки относительно кода проверки, хранящегося в пользовательском маркере подготовки. ([Перейти к коду](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))
12. Если они совпадают, элемент Bot помечает маркер как проверенный и готовый к использованию. В противном случае произойдет сбой процесса проверки подлинности, а Bot будет удален.

> [!Note]
> При возникновении проблем с проверкой подлинности на мобильном устройстве убедитесь, что пакет SDK для JavaScript обновлен до версии 1.4.1 или более поздней версии.

## <a name="samples"></a>Примеры

Пример кода, демонстрирующий процесс создания подлинности на Bot, см.

* [Пример проверки подлинности с помощью Microsoft Teams (узел)](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a>Дополнительные сведения

Подробные пошаговые руководства по реализации проверки подлинности, нацеленной на Azure Active Directory, представлены в следующих статьях:

* [Проверка подлинности пользователя в роботе Microsoft Teams](~/resources/bot-v3/bot-authentication/auth-bot-AAD.md)
